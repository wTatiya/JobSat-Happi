<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Happinometer ฝ่ายการพยาบาล 2568</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=K2D:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #f2f7ff 0%, #fff5f7 35%, #f3fffa 100%);
      --card-bg: rgba(255, 255, 255, 0.85);
      --primary: #2c3d7a;
      --accent: #ff8a5b;
      --accent-2: #2bb1a8;
      --accent-3: #ffcd4b;
      --text: #1f2a44;
      --muted: #5d6a93;
      --shadow: 0 18px 40px rgba(44, 61, 122, 0.12);
      --radius-lg: 24px;
      --radius-md: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "K2D", sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 40px 16px 60px;
    }

    .dashboard {
      width: min(1180px, 100%);
      background: rgba(255, 255, 255, 0.72);
      border-radius: var(--radius-lg);
      padding: 36px 32px 48px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 28px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.9rem, 3vw, 2.4rem);
      font-weight: 600;
      color: var(--primary);
    }

    header p {
      margin: 0;
      font-size: 1rem;
      color: var(--muted);
      max-width: 720px;
      line-height: 1.6;
    }

    .tab-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 28px;
    }

    .tab-button {
      flex: 1;
      min-width: 160px;
      border: none;
      border-radius: 999px;
      padding: 12px 20px;
      font-size: 0.95rem;
      font-weight: 500;
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #2c3d7a, #3c58b9);
      color: #f7f9ff;
      box-shadow: 0 12px 30px rgba(60, 88, 185, 0.3);
    }

    .panel {
      display: none;
      animation: fade 0.4s ease;
    }

    .panel.active {
      display: grid;
      gap: 22px;
    }

    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-grid {
      display: grid;
      gap: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 22px 24px;
      box-shadow: 0 12px 28px rgba(31, 42, 68, 0.1);
      border: 1px solid rgba(44, 61, 122, 0.08);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .card h2 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--primary);
    }

    .card h3 {
      margin: 0;
      font-size: 1.05rem;
      color: var(--primary);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(43, 177, 168, 0.16);
      color: #15766f;
      font-weight: 500;
      font-size: 0.85rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .metric {
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      box-shadow: 0 10px 20px rgba(44, 61, 122, 0.08);
      border: 1px solid rgba(44, 61, 122, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .metric-title {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .metric-value {
      font-size: 2.1rem;
      font-weight: 600;
      color: var(--primary);
    }

    .metric-desc {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .bar-track {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: rgba(44, 61, 122, 0.08);
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(135deg, var(--accent), #ff6f91);
      transition: width 0.6s ease;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .list-item {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 8px 20px rgba(31, 42, 68, 0.08);
    }

    .list-item strong {
      color: var(--primary);
      font-weight: 600;
    }

    .list-item span {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .hint {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .insight-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .correlation-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .correlation-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .correlation-item {
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 8px 20px rgba(31, 42, 68, 0.08);
    }

    .correlation-item strong {
      display: block;
      color: var(--primary);
      font-size: 1rem;
      margin-bottom: 6px;
    }

    .correlation-score-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .correlation-score {
      font-weight: 600;
      color: var(--accent-2);
    }

    .correlation-score.negative {
      color: var(--accent);
    }

    .correlation-bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(44, 61, 122, 0.08);
      overflow: hidden;
      margin: 10px 0;
    }

    .correlation-bar span {
      display: block;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(135deg, var(--accent-2), #3fd0c4);
    }

    .correlation-bar span.negative {
      background: linear-gradient(135deg, var(--accent), #ff6f91);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(255, 205, 75, 0.22);
      color: #9b6b00;
      font-size: 0.78rem;
      font-weight: 500;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .chip {
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(43, 177, 168, 0.14);
      color: #11655f;
      font-size: 0.85rem;
      cursor: default;
    }

    .cluster-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .cluster-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 20px 22px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 10px 26px rgba(31, 42, 68, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .cluster-card.positive {
      background: rgba(43, 177, 168, 0.16);
      border-color: rgba(43, 177, 168, 0.4);
    }

    .cluster-card.neutral {
      background: rgba(255, 205, 75, 0.16);
      border-color: rgba(255, 205, 75, 0.4);
    }

    .cluster-card.warning {
      background: rgba(255, 138, 91, 0.16);
      border-color: rgba(255, 138, 91, 0.42);
    }

    .cluster-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .cluster-id {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .cluster-header h4 {
      margin: 4px 0 0;
      font-size: 1.15rem;
      color: var(--primary);
    }

    .cluster-score {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 999px;
      padding: 6px 12px;
    }

    .cluster-desc {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .cluster-members {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .cluster-chip {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.7);
      color: var(--primary);
      font-size: 0.82rem;
      box-shadow: 0 6px 14px rgba(31, 42, 68, 0.08);
    }

    .cluster-metrics {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .cluster-subtitle {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .cluster-tag {
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
      font-size: 0.82rem;
      display: inline-block;
    }

    .cluster-tag.warning {
      background: rgba(255, 138, 91, 0.18);
      color: #a44a2d;
    }

    .cluster-summary {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .unit-select {
      width: 100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(44, 61, 122, 0.18);
      font-size: 0.95rem;
      color: var(--primary);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: inset 0 4px 12px rgba(31, 42, 68, 0.08);
    }

    .unit-details {
      display: grid;
      gap: 16px;
      margin-top: 18px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.88);
      border-radius: 16px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 8px 20px rgba(31, 42, 68, 0.08);
    }

    .detail-row span {
      color: var(--muted);
      font-size: 0.92rem;
    }

    .detail-row strong {
      color: var(--primary);
      font-size: 1.05rem;
    }

    .alert-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .alert-item {
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255, 138, 91, 0.15);
      color: #a44a2d;
      font-size: 0.88rem;
      line-height: 1.4;
    }

    .attrition-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .attrition-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 18px 20px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 10px 24px rgba(31, 42, 68, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .attrition-card h4 {
      margin: 0;
      color: var(--primary);
      font-size: 1rem;
    }

    .attrition-card .figure {
      font-size: 2rem;
      font-weight: 600;
      color: var(--accent);
    }

    .commitment-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .commitment-table th,
    .commitment-table td {
      border-bottom: 1px solid rgba(44, 61, 122, 0.12);
      padding: 10px 8px;
      text-align: left;
    }

    .commitment-table th {
      color: var(--muted);
      font-weight: 600;
    }

    .commitment-table td strong {
      color: var(--primary);
    }

    .regression-table th:nth-child(2),
    .regression-table td:nth-child(2) {
      text-align: center;
      width: 120px;
      white-space: nowrap;
    }

    .regression-table td:nth-child(3) {
      max-width: 420px;
    }

    .commitment-insight {
      background: rgba(43, 177, 168, 0.12);
      border-radius: 14px;
      padding: 12px 14px;
      color: #126b64;
      font-size: 0.9rem;
      margin-top: 12px;
    }

    .forecast-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .forecast-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 18px 20px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 10px 24px rgba(31, 42, 68, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .forecast-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .risk-badge {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      background: rgba(43, 177, 168, 0.15);
      color: #11655f;
    }

    .risk-badge.moderate {
      background: rgba(255, 205, 75, 0.25);
      color: #8d6500;
    }

    .risk-badge.high {
      background: rgba(255, 138, 91, 0.25);
      color: #b4481d;
    }

    .forecast-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .forecast-metric .value {
      font-weight: 600;
      color: var(--primary);
      font-size: 1.05rem;
    }

    .forecast-bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(44, 61, 122, 0.1);
      overflow: hidden;
    }

    .forecast-bar span {
      display: block;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(135deg, #ff8a5b, #ff6f91);
      transition: width 0.6s ease;
    }

    .forecast-trend {
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .forecast-trend.down {
      color: var(--accent-2);
    }

    .forecast-note {
      font-size: 0.82rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      color: var(--accent);
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 12px;
    }

    footer {
      margin-top: 24px;
      font-size: 0.8rem;
      color: var(--muted);
      text-align: right;
    }

    @media (max-width: 780px) {
      body {
        padding: 24px 12px 40px;
      }
      .dashboard {
        padding: 28px 20px 40px;
      }
      .tab-button {
        min-width: 140px;
      }
    }
  </style>
</head>
<body>
  <main class="dashboard">
    <header>
      <div class="pill">Happinometer &amp; Job Satisfaction 2568</div>
      <h1>สรุปความสุขและความผูกพันบุคลากรพยาบาลระดับบริหาร</h1>
      <p>
        ข้อมูลนี้สังเคราะห์จากผลสำรวจ Happinometer, ความผูกพัน และความพึงพอใจในการทำงานปี 2568 โดยมุ่งเน้นสำหรับผู้บริหารการพยาบาล เพื่อช่วยชี้โอกาสการเสริมพลังทีมและเฝ้าระวังความเสี่ยงด้านบุคลากร
      </p>
    </header>

    <nav class="tab-bar">
      <button class="tab-button active" data-target="overview">ภาพรวมความสุข</button>
      <button class="tab-button" data-target="satisfaction">ความพึงพอใจงาน</button>
      <button class="tab-button" data-target="focus">จุดเน้นผู้บริหาร</button>
      <button class="tab-button" data-target="attrition">การลาออก 2568</button>
    </nav>

    <section id="overview" class="panel active">
      <div class="card">
        <h2>ค่าเด่นจาก Happinometer และความผูกพัน</h2>
        <div class="grid-3">
          <div class="metric" style="background: rgba(43, 177, 168, 0.18);">
            <span class="metric-title">หน่วยที่สร้างประสบการณ์โดดเด่น</span>
            <span class="metric-value">หอพัก 90.0%</span>
            <p class="metric-desc">คะแนน Overall Happy สูงที่สุด 90% พร้อมระดับความผูกพัน 73.33% (3.67) แสดงถึงการดูแลชีวิต-งานที่สมดุล</p>
          </div>
          <div class="metric" style="background: rgba(255, 205, 75, 0.18);">
            <span class="metric-title">กลุ่ม OPD ที่เติบโตต่อเนื่อง</span>
            <span class="metric-value">OPD2 84.3%</span>
            <p class="metric-desc">คะแนนความสุขรวม 84.29% และความผูกพัน 77.62% สะท้อนการบริหารภาระงานและสวัสดิการที่สมดุล</p>
          </div>
          <div class="metric" style="background: rgba(255, 138, 91, 0.18);">
            <span class="metric-title">หน่วยที่ต้องเร่งฟื้นฟูความสุข</span>
            <span class="metric-value">PICU 48.9%</span>
            <p class="metric-desc">คะแนนความสุขรวมต่ำสุด 48.89% แม้ความพึงพอใจงานยังสูง (81%) ต้องเน้นสนับสนุนสุขภาพกายใจและกำลังคน</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>อันดับความสุขรวม (Overall Happy)</h3>
        <div class="chip-group">
          <div class="chip">Top: หอพัก 90.0%</div>
          <div class="chip">Top: OPD2 84.3%</div>
          <div class="chip">Top: CSSD 81.3%</div>
          <div class="chip" style="background: rgba(255, 138, 91, 0.18); color: #a44a2d;">Low: PICU 48.9%</div>
          <div class="chip" style="background: rgba(255, 138, 91, 0.18); color: #a44a2d;">Low: 19C 53.9%</div>
          <div class="chip" style="background: rgba(255, 138, 91, 0.18); color: #a44a2d;">Low: 20B 57.0%</div>
        </div>
        <div class="list">
          <div class="list-item">
            <div>
              <strong>หน่วยที่ขับเคลื่อนประสบการณ์เชิงบวก</strong>
              <p class="hint">CSSD 81.25%, ปฐมภูมิ 80.0%, OPD3 74.21% ร่วมสร้างต้นแบบทีมสุขภาพจิตดี</p>
            </div>
            <span>ดัชนี ≥ 74%</span>
          </div>
          <div class="list-item">
            <div>
              <strong>พื้นที่ต้องเสริมสุขภาพองค์รวม</strong>
              <p class="hint">PICU (Relax 52.89%, Happy Plus 48.15%), 20B (Body 62.4%, Relax 48.8%) และ 19C (Relax 50.86%) ต้องเติมพลังงานและระบบสนับสนุน</p>
            </div>
            <span>ดัชนี &lt; 60%</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>การจัดกลุ่มหน่วยงานตามโปรไฟล์ความสุข (Cluster Analysis)</h3>
        <p class="hint">
          วิเคราะห์คะแนน 11 มิติความสุขเพื่อค้นหาหน่วยงานที่มีรูปแบบคล้ายกัน ช่วยให้เลือกกลยุทธ์สนับสนุนที่ตรงจุดและขยายผลจากทีมต้นแบบได้รวดเร็ว
        </p>
        <div class="cluster-summary" id="clusterSummary"></div>
        <div class="cluster-grid" id="clusterGrid"></div>
      </div>

      <div class="card">
        <h3>ความผูกพันพนักงาน (Engagement Score)</h3>
        <div class="insight-grid">
          <div>
            <div class="tag">สูงสุด</div>
            <div class="list" style="margin-top: 10px;">
              <div class="list-item">
                <div>
                  <strong>งานระบาด 93.33%</strong>
                  <span>คะแนน 4.67 (SD 0.16) สะท้อนผู้นำและภารกิจชัดเจน</span>
                </div>
              </div>
              <div class="list-item">
                <div>
                  <strong>ผู้บริหาร 80.58%</strong>
                  <span>ความผูกพันสูงควบคู่ความสุข 75.43%</span>
                </div>
              </div>
              <div class="list-item">
                <div>
                  <strong>ปฐมภูมิ 78.67%</strong>
                  <span>ระบบทีมและ Happy Plus 84% สนับสนุนการรักษาผลงาน</span>
                </div>
              </div>
            </div>
          </div>
          <div>
            <div class="tag">เฝ้าระวัง</div>
            <div class="list" style="margin-top: 10px;">
              <div class="list-item">
                <div>
                  <strong>22A &amp; Stroke 59.39%</strong>
                  <span>คะแนน Relax 55.27% และ Happy Plus 56.36% บ่งชี้ภาระงานตึง</span>
                </div>
              </div>
              <div class="list-item">
                <div>
                  <strong>20B 59.56%</strong>
                  <span>Body 62.4% และ Engagement ด้าน Stay เพียง 55.5%</span>
                </div>
              </div>
              <div class="list-item">
                <div>
                  <strong>19C 60.71%</strong>
                  <span>Relax 50.86% ต้องจัดการภาระงานและทรัพยากรสนับสนุน</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="satisfaction" class="panel">
      <div class="card">
        <h2>ไฮไลต์ความพึงพอใจในการทำงาน</h2>
        <div class="grid-3">
          <div class="metric" style="background: rgba(43, 177, 168, 0.18);">
            <span class="metric-title">คะแนนรวมสูงสุด</span>
            <span class="metric-value">สำนักงาน 87.2%</span>
            <p class="metric-desc">โดดเด่นในสิ่งแวดล้อมการทำงาน (90%) และสวัสดิการ (86%) เป็นต้นแบบพื้นที่สนับสนุน</p>
          </div>
          <div class="metric" style="background: rgba(255, 205, 75, 0.18);">
            <span class="metric-title">หน่วยบริการที่ยังรักษาคะแนนสูง</span>
            <span class="metric-value">CSSD 83.2%</span>
            <p class="metric-desc">คะแนนการบังคับบัญชา 85.6% และภาพรวม 83.2% สนับสนุนคุณภาพบริการด่านหลัง</p>
          </div>
          <div class="metric" style="background: rgba(255, 138, 91, 0.18);">
            <span class="metric-title">ประเด็นปานกลาง</span>
            <span class="metric-value">ER 74.0%</span>
            <p class="metric-desc">ค่าตอบแทนและสวัสดิการอยู่ในระดับปานกลาง (68.2%) ควรเสริมรางวัลและการดูแลใจ</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>ภาพรวมตามมิติ</h3>
        <div class="insight-grid">
          <div class="metric">
            <span class="metric-title">การบังคับบัญชา</span>
            <span class="metric-value">เฉลี่ย 3.9 (78%)</span>
            <p class="metric-desc">หน่วยที่ดีที่สุด: สำนักงาน 87.6%, CSSD 85.6% สะท้อนภาวะผู้นำที่ชัด</p>
            <div class="hint">ต้องเฝ้าระวัง: ไตเทียม 68.8% (ปานกลาง)</div>
          </div>
          <div class="metric">
            <span class="metric-title">สิ่งแวดล้อมการทำงาน</span>
            <span class="metric-value">เฉลี่ย 3.9 (78%)</span>
            <p class="metric-desc">PICU 92.8% และสำนักงาน 90% แสดงความพร้อมด้านทรัพยากรและความปลอดภัย</p>
            <div class="hint">22A&Stroke 75.6% ยังต่ำกว่าค่าเฉลี่ยหน่วยบริการ</div>
          </div>
          <div class="metric">
            <span class="metric-title">ค่าตอบแทนและสวัสดิการ</span>
            <span class="metric-value">เฉลี่ย 3.8 (76%)</span>
            <p class="metric-desc">OPD2 83.4% และ CSSD 82.2% ช่วยรักษากำลังคน</p>
            <div class="hint">ER 74.6%, ไตเทียม 80.8% (แต่ค่าตอบแทนย่อย 66.8%) ต้องปรับสวัสดิการเชิงแรงจูงใจ</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>สรุปจุดเด่นและโอกาส</h3>
        <div class="insight-grid">
          <div class="metric" style="background: rgba(43, 177, 168, 0.16);">
            <span class="metric-title">จุดแข็งที่ต้องต่อยอด</span>
            <p class="metric-desc">
              OPD2, CSSD และสำนักงานสร้างคะแนน ≥ 80% ในหลายมิติ แนะนำให้ใช้เป็นพื้นที่เรียนรู้ร่วมเพื่อถ่ายทอดแนวทางบริหารทีมและการดูแลทรัพยากร
            </p>
          </div>
          <div class="metric" style="background: rgba(255, 205, 75, 0.16);">
            <span class="metric-title">โอกาสพัฒนาเชิงระบบ</span>
            <p class="metric-desc">
              มิติ “ค่าตอบแทนและสวัสดิการ” ของ ER (68.2%) และไตเทียม (66.8%) พร้อมมิติ “ลักษณะงาน” ของ SICU (67.8%) สะท้อนความต้องการเสริมกำลังคนและการชดเชยภาระงาน
            </p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>สหสัมพันธ์มิติความพึงพอใจต่อคะแนนรวม</h3>
        <p class="hint">วิเคราะห์จากข้อมูล 18 หน่วยบริการ พบว่าการเสริมบางมิติเชื่อมโยงโดยตรงต่อคะแนนภาพรวม ขณะที่การละเลยบางมิติสัมพันธ์กับความเสี่ยงคะแนนต่ำ</p>
        <div class="metric" id="correlationSummary" style="background: rgba(43, 177, 168, 0.14);"></div>
        <div class="correlation-grid">
          <div>
            <h4>ตัวขับเคลื่อนคะแนนสูง</h4>
            <div class="correlation-list" id="positiveCorrelation"></div>
          </div>
          <div>
            <h4>ตัวบ่งชี้ความเสี่ยงคะแนนต่ำ</h4>
            <div class="correlation-list" id="negativeCorrelation"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="focus" class="panel">
      <div class="card">
        <h2>แดชบอร์ดโฟกัสสำหรับผู้บริหาร</h2>
        <p class="hint">เลือกหน่วยงานเพื่อดูสรุปคะแนนสำคัญและสัญญาณเตือน</p>
        <select class="unit-select" id="unitSelect">
          <option value="หอพัก">หอพัก</option>
          <option value="OPD2">OPD2</option>
          <option value="CSSD">CSSD</option>
          <option value="PICU">PICU</option>
          <option value="20B">20B</option>
          <option value="ER">ER</option>
          <option value="ไตเทียม">ไตเทียม</option>
          <option value="SICU">SICU</option>
        </select>
        <div class="unit-details" id="unitDetails">
          <div class="detail-row">
            <span>ความสุขรวม (Happinometer)</span>
            <strong id="happyScore">90.0%</strong>
          </div>
          <div class="detail-row">
            <span>ความผูกพัน (Employee Engagement)</span>
            <strong id="engagementScore">73.33%</strong>
          </div>
          <div class="detail-row">
            <span>ความพึงพอใจงาน (ภาพรวม)</span>
            <strong id="jobScore">ไม่มีข้อมูล</strong>
          </div>
          <div>
            <div class="tag">สัญญาณที่ควรจับตา</div>
            <div class="alert-list" id="alertList">
              <div class="alert-item">ข้อมูลครบถ้วนและอยู่ในระดับแข็งแรง</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>ประเด็นยุทธศาสตร์ที่ควรขับเคลื่อน</h3>
        <div class="insight-grid">
          <div class="metric">
            <span class="metric-title">1. เสริมสุขภาพกายใจในหน่วยวิกฤต</span>
            <p class="metric-desc">PICU, 20B และ 19C มีมิติ Relax &amp; Happy Plus ต่ำกว่า 55% แนะนำจัดโครงการพี่เลี้ยงและเวลาพักเชิงรุก</p>
          </div>
          <div class="metric">
            <span class="metric-title">2. จัดการภาระงานและทรัพยากร</span>
            <p class="metric-desc">SICU และ ER มีคะแนนลักษณะงานและค่าตอบแทนระดับปานกลาง ต้องพิจารณาปรับสัดส่วนเวรและเครื่องมือสนับสนุน</p>
          </div>
          <div class="metric">
            <span class="metric-title">3. ต่อยอดทีมต้นแบบ</span>
            <p class="metric-desc">นำแนวทางจาก OPD2, CSSD และสำนักงาน (คะแนน ≥ 83%) มาใช้เป็นโครงการ Coach the Coach สร้างมาตรฐานการดูแลบุคลากร</p>
          </div>
        </div>
      </div>
    </section>

    <section id="attrition" class="panel">
      <div class="card">
        <h2>ภาพรวมการลาออกของบุคลากร (รวม 53 คน)</h2>
        <div class="attrition-grid">
          <div class="attrition-card">
            <h4>หน่วยที่มีการลาออกสูงสุด</h4>
            <div class="figure">OR 6 คน</div>
            <p class="hint">ประกอบด้วย N 4 คน และ PN 2 คน จำเป็นต้องทบทวนแผนเวรและสวัสดิการเฉพาะ</p>
          </div>
          <div class="attrition-card">
            <h4>หน่วยเสี่ยงระดับกลาง</h4>
            <div class="figure">MICU / DR / บางพระ 3 คน</div>
            <p class="hint">MICU สูญเสีย N 2 คน PN 1 คน สัมพันธ์กับคะแนน Relax 52.79% และ Stay 60%</p>
          </div>
          <div class="attrition-card">
            <h4>กระจายหลายหน่วยงาน</h4>
            <div class="figure">18D, Refer, 23A, 22A ฯลฯ</div>
            <p class="hint">แต่ละหน่วยออก 2-3 คน ควรเชื่อมโยงข้อมูลลาออกกับคะแนนค่าตอบแทนและ Engagement เพื่อจัดแผนรักษาคน</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Trend Simulation 2569</h3>
        <p class="hint">แบบจำลองคาดการณ์ลาออกในอีก 6-12 เดือน โดยอ้างอิงจำนวนลาออกปัจจุบัน คะแนนความผูกพัน และตัวชี้วัดความพึงพอใจ</p>
        <div class="forecast-grid" id="forecastGrid"></div>
        <div class="alert-list" id="forecastInsights"></div>
      </div>

      <div class="card">
        <h3>ข้อเสนอแนะการจัดการกำลังคน</h3>
        <div class="insight-grid">
          <div class="metric">
            <span class="metric-title">พยาบาลวิกฤต</span>
            <p class="metric-desc">OR และ MICU ควรรวมทีมผู้เชี่ยวชาญเพื่อทบทวนระบบพี่เลี้ยงและค่าตอบแทนเสี่ยงภัยเชื่อมกับคะแนน Happinometer</p>
          </div>
          <div class="metric">
            <span class="metric-title">หน่วยบริการนอกเวลา</span>
            <p class="metric-desc">บางพระและ Refer มีการลาออก 3 และ 2 คนตามลำดับ ต้องตรวจสอบภาระงานนอกเวลารวมถึงแรงจูงใจเพิ่มเติม</p>
          </div>
          <div class="metric">
            <span class="metric-title">การสื่อสารกับบุคลากรใหม่</span>
            <p class="metric-desc">เชื่อมข้อมูลลาออกของ PN และ NA รวม 22 คน กับโครงการ Onboarding เพื่อเสริมความผูกพันตั้งแต่ 90 วันแรก</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Commitment vs. Resignation Analysis</h3>
        <p class="hint">เชื่อมโยงคะแนนความผูกพันกับจำนวนการลาออกเพื่อดูว่าหน่วยที่มีผูกพันต่ำมีการสูญเสียกำลังคนสูงเพียงใด</p>
        <div class="commitment-insight" id="commitmentSummary"></div>
        <div class="table-wrapper">
          <table class="commitment-table">
            <thead>
              <tr>
                <th>หน่วยงาน</th>
                <th>ความผูกพัน (Commitment)</th>
                <th>จำนวนลาออก 2568</th>
              </tr>
            </thead>
            <tbody id="commitmentTable"></tbody>
          </table>
        </div>
        <div class="alert-list" id="commitmentInsights"></div>
      </div>

      <div class="card">
        <h3>Regression: ตัวแปรที่คาดการณ์การลาออก</h3>
        <p class="hint">วิเคราะห์ถดถอยเชิงเส้นจากข้อมูล 7 หน่วยบริการ โดยปรับมาตรฐานคะแนนแต่ละมิติเพื่อเปรียบเทียบอิทธิพลต่อจำนวนลาออก (β เป็นค่าที่สูงขึ้นหมายถึงผลกระทบมากขึ้น)</p>
        <div class="commitment-insight" id="regressionSummary"></div>
        <div class="table-wrapper">
          <table class="commitment-table regression-table">
            <thead>
              <tr>
                <th>ปัจจัย</th>
                <th>สัมประสิทธิ์ (β)</th>
                <th>คำอธิบาย</th>
              </tr>
            </thead>
            <tbody id="regressionTableBody"></tbody>
          </table>
        </div>
        <div class="alert-list" id="regressionInsights"></div>
      </div>
    </section>

    <footer>ที่มา: รายงาน Happinometer, การผูกพัน และ Job Satisfaction ฝ่ายการพยาบาล ปี 2568</footer>
  </main>

  <script>
    const happinessProfiles = [
      {
        unit: 'หอพัก',
        dimensions: {
          Body: 88,
          Brain: 85,
          Heart: 90,
          Soul: 87,
          Family: 89,
          Support: 88,
          Finance: 82,
          Growth: 81,
          Environment: 90,
          Relax: 86,
          HappyPlus: 90
        }
      },
      {
        unit: 'OPD2',
        dimensions: {
          Body: 84,
          Brain: 82,
          Heart: 86,
          Soul: 83,
          Family: 85,
          Support: 84,
          Finance: 83,
          Growth: 80,
          Environment: 85,
          Relax: 78,
          HappyPlus: 85
        }
      },
      {
        unit: 'CSSD',
        dimensions: {
          Body: 82,
          Brain: 80,
          Heart: 84,
          Soul: 81,
          Family: 83,
          Support: 86,
          Finance: 82,
          Growth: 78,
          Environment: 84,
          Relax: 76,
          HappyPlus: 82
        }
      },
      {
        unit: 'OPD3',
        dimensions: {
          Body: 78,
          Brain: 77,
          Heart: 80,
          Soul: 78,
          Family: 79,
          Support: 80,
          Finance: 79,
          Growth: 76,
          Environment: 82,
          Relax: 74,
          HappyPlus: 79
        }
      },
      {
        unit: 'ปฐมภูมิ',
        dimensions: {
          Body: 81,
          Brain: 79,
          Heart: 83,
          Soul: 80,
          Family: 82,
          Support: 82,
          Finance: 78,
          Growth: 82,
          Environment: 83,
          Relax: 75,
          HappyPlus: 84
        }
      },
      {
        unit: 'ผู้บริหาร',
        dimensions: {
          Body: 76,
          Brain: 78,
          Heart: 82,
          Soul: 79,
          Family: 80,
          Support: 83,
          Finance: 77,
          Growth: 81,
          Environment: 80,
          Relax: 72,
          HappyPlus: 80
        }
      },
      {
        unit: 'งานระบาด',
        dimensions: {
          Body: 85,
          Brain: 88,
          Heart: 87,
          Soul: 86,
          Family: 84,
          Support: 86,
          Finance: 82,
          Growth: 84,
          Environment: 88,
          Relax: 80,
          HappyPlus: 88
        }
      },
      {
        unit: 'PICU',
        dimensions: {
          Body: 66,
          Brain: 72,
          Heart: 70,
          Soul: 68,
          Family: 65,
          Support: 75,
          Finance: 74,
          Growth: 69,
          Environment: 93,
          Relax: 53,
          HappyPlus: 48
        }
      },
      {
        unit: '20B',
        dimensions: {
          Body: 62,
          Brain: 68,
          Heart: 66,
          Soul: 64,
          Family: 63,
          Support: 70,
          Finance: 69,
          Growth: 66,
          Environment: 72,
          Relax: 49,
          HappyPlus: 55
        }
      },
      {
        unit: '19C',
        dimensions: {
          Body: 64,
          Brain: 69,
          Heart: 67,
          Soul: 65,
          Family: 64,
          Support: 71,
          Finance: 68,
          Growth: 65,
          Environment: 74,
          Relax: 51,
          HappyPlus: 57
        }
      },
      {
        unit: '22A & Stroke',
        dimensions: {
          Body: 66,
          Brain: 70,
          Heart: 68,
          Soul: 66,
          Family: 65,
          Support: 72,
          Finance: 67,
          Growth: 68,
          Environment: 76,
          Relax: 55,
          HappyPlus: 56
        }
      },
      {
        unit: 'ER',
        dimensions: {
          Body: 64,
          Brain: 71,
          Heart: 69,
          Soul: 66,
          Family: 68,
          Support: 73,
          Finance: 68,
          Growth: 67,
          Environment: 75,
          Relax: 58,
          HappyPlus: 60
        }
      },
      {
        unit: 'SICU',
        dimensions: {
          Body: 63,
          Brain: 70,
          Heart: 68,
          Soul: 65,
          Family: 64,
          Support: 72,
          Finance: 66,
          Growth: 67,
          Environment: 74,
          Relax: 57,
          HappyPlus: 59
        }
      },
      {
        unit: 'ไตเทียม',
        dimensions: {
          Body: 70,
          Brain: 72,
          Heart: 73,
          Soul: 71,
          Family: 70,
          Support: 68,
          Finance: 67,
          Growth: 69,
          Environment: 78,
          Relax: 60,
          HappyPlus: 62
        }
      }
    ];

    const dimensionLabels = {
      Body: 'Body (สุขภาพกาย)',
      Brain: 'Brain (การเรียนรู้)',
      Heart: 'Heart (ความสัมพันธ์)',
      Soul: 'Soul (คุณค่าภายใน)',
      Family: 'Family (เครือข่ายหนุนเสริม)',
      Support: 'การนำและระบบสนับสนุน',
      Finance: 'ค่าตอบแทนและสวัสดิการ',
      Growth: 'โอกาสเติบโตในงาน',
      Environment: 'สิ่งแวดล้อมการทำงาน',
      Relax: 'Relax (Work-Life Balance)',
      HappyPlus: 'Happy Plus (ความสุขเชิงบวก)'
    };

    const dimensionKeys = Object.keys(happinessProfiles[0].dimensions);

    const clusterSummaryElement = document.getElementById('clusterSummary');
    const clusterGridElement = document.getElementById('clusterGrid');

    if (clusterSummaryElement && clusterGridElement) {
      const seeds = ['หอพัก', 'ER', 'PICU'];
      const clusterResult = analyzeHappinessClusters(happinessProfiles, dimensionKeys, seeds);
      clusterSummaryElement.textContent = clusterResult.summary;
      renderClusterCards(clusterGridElement, clusterResult.details);
    }

    function analyzeHappinessClusters(profiles, keys, seeds) {
      const k = 3;
      const { clusters } = kMeansProfiles(profiles, keys, k, seeds);
      const populatedClusters = clusters.filter(cluster => cluster.length);

      const details = populatedClusters.map((members, index) => {
        const averages = keys.reduce((acc, key) => {
          const total = members.reduce((sum, profile) => sum + profile.dimensions[key], 0);
          acc[key] = total / members.length;
          return acc;
        }, {});

        const overall = keys.reduce((sum, key) => sum + averages[key], 0) / keys.length;
        const classification = classifyCluster(overall, averages);

        const strengths = keys
          .slice()
          .sort((a, b) => averages[b] - averages[a])
          .slice(0, 2)
          .map(key => `${dimensionLabels[key]} ${formatPercentage(averages[key])}`);

        const watch = keys
          .slice()
          .sort((a, b) => averages[a] - averages[b])
          .slice(0, 2)
          .map(key => `${dimensionLabels[key]} ${formatPercentage(averages[key])}`);

        return {
          id: index + 1,
          members: members.map(member => member.unit),
          overall: formatPercentage(overall),
          classification,
          strengths,
          watch
        };
      });

      const summaryParts = details.map(detail => `${detail.classification.label} (${detail.members.length} หน่วย, เฉลี่ย ${detail.overall})`);
      const summaryText = `วิเคราะห์โปรไฟล์ความสุขของ ${profiles.length} หน่วยงาน พบ ${details.length} คลัสเตอร์หลัก: ${summaryParts.join(' • ')}.`;

      return {
        summary: summaryText,
        details
      };
    }

    function kMeansProfiles(profiles, keys, k, seeds, maxIterations = 30) {
      const fallbackProfiles = profiles.filter(profile => !seeds.includes(profile.unit));
      const seedCentroids = seeds
        .map(seed => profiles.find(profile => profile.unit === seed))
        .filter(Boolean)
        .map(profile => keys.map(key => profile.dimensions[key]));

      let centroids = seedCentroids.slice(0, k);
      let fallbackIndex = 0;
      while (centroids.length < k && fallbackIndex < fallbackProfiles.length) {
        centroids.push(keys.map(key => fallbackProfiles[fallbackIndex].dimensions[key]));
        fallbackIndex += 1;
      }

      if (!centroids.length) {
        centroids = profiles.slice(0, k).map(profile => keys.map(key => profile.dimensions[key]));
      }

      let clusters = [];

      for (let iteration = 0; iteration < maxIterations; iteration += 1) {
        clusters = Array.from({ length: centroids.length }, () => []);

        profiles.forEach(profile => {
          const vector = keys.map(key => profile.dimensions[key]);
          let bestIndex = 0;
          let bestDistance = Infinity;

          centroids.forEach((centroid, index) => {
            const distance = euclideanDistance(vector, centroid);
            if (distance < bestDistance) {
              bestDistance = distance;
              bestIndex = index;
            }
          });

          clusters[bestIndex].push(profile);
        });

        const newCentroids = centroids.map((centroid, index) => {
          const members = clusters[index];
          if (!members.length) {
            return centroid;
          }
          const sums = new Array(keys.length).fill(0);
          members.forEach(member => {
            keys.forEach((key, keyIndex) => {
              sums[keyIndex] += member.dimensions[key];
            });
          });
          return sums.map(sum => sum / members.length);
        });

        const hasShift = centroids.some((centroid, index) =>
          centroid.some((value, dimIndex) => Math.abs(value - newCentroids[index][dimIndex]) > 0.1)
        );

        centroids = newCentroids;

        if (!hasShift) {
          break;
        }
      }

      clusters = clusters.filter(cluster => cluster.length);

      return { clusters, centroids };
    }

    function euclideanDistance(a, b) {
      return Math.sqrt(a.reduce((sum, value, index) => sum + Math.pow(value - b[index], 2), 0));
    }

    function classifyCluster(overall, averages) {
      if (overall >= 80 && averages.Relax >= 75 && averages.HappyPlus >= 80) {
        return {
          label: 'สมดุลสูงเป็นต้นแบบ',
          description:
            'คะแนนทุกมิติเฉลี่ยมากกว่า 80% โดยเฉพาะการผ่อนคลายและความสุขเชิงบวก เหมาะขยายผลเป็นทีมต้นแบบและโค้ชหน่วยอื่น',
          tone: 'positive'
        };
      }

      if (averages.Relax < 60 || averages.Body < 65) {
        return {
          label: 'ภาระงานตึง ต้องเร่งพยุง',
          description:
            'คะแนนด้านพลังงานกายและเวลาพักต่ำกว่ามาตรฐาน สะท้อนความล้าและความเสี่ยงผูกพัน จำเป็นต้องจัดการเวรและเพิ่มระบบสนับสนุนทันที',
          tone: 'warning'
        };
      }

      return {
        label: 'กลุ่มกำลังเสริมสมดุล',
        description:
          'คะแนนรวมระดับกลาง แข็งแรงด้านการสนับสนุนและสิ่งแวดล้อม แต่ยังต้องต่อยอดมิติความผ่อนคลายและแรงจูงใจเชิงบวก',
        tone: 'neutral'
      };
    }

    function formatPercentage(value) {
      return `${Math.round(value)}%`;
    }

    function renderClusterCards(container, details) {
      container.innerHTML = '';
      details.forEach(detail => {
        const card = document.createElement('div');
        card.className = `cluster-card ${detail.classification.tone}`;
        card.innerHTML = `
          <div class="cluster-header">
            <div>
              <span class="cluster-id">Cluster ${detail.id}</span>
              <h4>${detail.classification.label}</h4>
            </div>
            <span class="cluster-score">เฉลี่ย ${detail.overall}</span>
          </div>
          <p class="cluster-desc">${detail.classification.description}</p>
          <div class="cluster-members">
            ${detail.members.map(member => `<span class="cluster-chip">${member}</span>`).join('')}
          </div>
          <div class="cluster-metrics">
            <div>
              <span class="cluster-subtitle">จุดแข็ง</span>
              ${detail.strengths.map(text => `<div class="cluster-tag">${text}</div>`).join('')}
            </div>
            <div>
              <span class="cluster-subtitle">เฝ้าระวัง</span>
              ${detail.watch.map(text => `<div class="cluster-tag warning">${text}</div>`).join('')}
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    const unitsData = {
      "หอพัก": {
        happy: "90.0%",
        engagement: "73.33%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "คะแนนสุขภาวะองค์รวมสูงทุกมิติ เหมาะเป็นพื้นที่แลกเปลี่ยนแนวปฏิบัติที่ดี"
        ]
      },
      "OPD2": {
        happy: "84.29%",
        engagement: "77.62%",
        job: "78.80%",
        alerts: [
          "คะแนนค่าตอบแทนและสวัสดิการ 83.40% สนับสนุนการรักษากำลังคน",
          "ควรต่อยอดโครงการพัฒนาผู้นำสายงานเพื่อรักษาคะแนนสูงต่อเนื่อง"
        ]
      },
      "CSSD": {
        happy: "81.25%",
        engagement: "70.65%",
        job: "83.20%",
        alerts: [
          "การบังคับบัญชาสูงถึง 85.60% เป็นตัวอย่างการจัดการทีม",
          "ควรลงทุนต่อเนื่องในเทคโนโลยีสนับสนุนเพื่อลดภาระงานซ้ำ"
        ]
      },
      "PICU": {
        happy: "48.89%",
        engagement: "62.72%",
        job: "81.00%",
        alerts: [
          "มิติ Relax เพียง 52.89% และ Happy Plus 48.15% ต้องเร่งเสริมกำลังใจ",
          "แม้สิ่งแวดล้อมการทำงานสูง (92.80%) แต่ต้องเติมทรัพยากรบุคลากรและวันพัก"
        ]
      },
      "20B": {
        happy: "57.00%",
        engagement: "59.56%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "คะแนน Body 62.40% และ Relax 48.80% สะท้อนความเหนื่อยล้า",
          "แนะนำจัดโครงการ Care for Caregivers และกำหนดผู้ช่วยสนับสนุน"
        ]
      },
      "ER": {
        happy: "68.48%",
        engagement: "66.94%",
        job: "74.00%",
        alerts: [
          "ค่าตอบแทนและสวัสดิการ 68.20% (ปานกลาง) ต้องเร่งทบทวน",
          "ภาระงานสูงสะท้อนใน Relax 58.42% ต้องเพิ่มเวลาพักและทีมสนับสนุน"
        ]
      },
      "ไตเทียม": {
        happy: "68.67%",
        engagement: "66.52%",
        job: "74.80%",
        alerts: [
          "การบังคับบัญชา 68.80% และค่าตอบแทน 66.80% อยู่ระดับปานกลาง",
          "ควรสื่อสารเส้นทางความก้าวหน้าและสวัสดิการเฉพาะทางเพิ่ม"
        ]
      },
      "SICU": {
        happy: "65.00%",
        engagement: "64.96%",
        job: "72.40%",
        alerts: [
          "ลักษณะงาน 67.80% (ปานกลาง) ต้องปรับสัดส่วนเวร",
          "มิติ Relax 56.92% ควรเสริมทีมสนับสนุนด้านจิตใจ"
        ]
      }
    };

    const tabButtons = document.querySelectorAll('.tab-button');
    const panels = document.querySelectorAll('.panel');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.dataset.target;
        tabButtons.forEach(btn => btn.classList.remove('active'));
        panels.forEach(panel => panel.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    const unitSelect = document.getElementById('unitSelect');
    const happyScore = document.getElementById('happyScore');
    const engagementScore = document.getElementById('engagementScore');
    const jobScore = document.getElementById('jobScore');
    const alertList = document.getElementById('alertList');

    function updateUnitDetails(unit) {
      const data = unitsData[unit];
      happyScore.textContent = data.happy;
      engagementScore.textContent = data.engagement;
      jobScore.textContent = data.job;
      alertList.innerHTML = '';
      data.alerts.forEach(item => {
        const div = document.createElement('div');
        div.className = 'alert-item';
        div.textContent = item;
        alertList.appendChild(div);
      });
    }

    unitSelect.addEventListener('change', (event) => {
      updateUnitDetails(event.target.value);
    });

    updateUnitDetails(unitSelect.value);

    const commitmentData = [
      { unit: 'OR', commitment: 58, resignations: 6 },
      { unit: 'MICU', commitment: 61, resignations: 3 },
      { unit: 'DR', commitment: 63, resignations: 3 },
      { unit: 'บางพระ', commitment: 67, resignations: 3 },
      { unit: 'Refer', commitment: 69, resignations: 2 },
      { unit: '18D', commitment: 72, resignations: 2 },
      { unit: '23A', commitment: 74, resignations: 2 }
    ];

    const commitmentTable = document.getElementById('commitmentTable');
    const commitmentSummary = document.getElementById('commitmentSummary');
    const commitmentInsights = document.getElementById('commitmentInsights');

    const totalResignations = commitmentData.reduce((sum, item) => sum + item.resignations, 0);
    const lowCommitment = commitmentData.filter(item => item.commitment < 65);
    const highCommitment = commitmentData.filter(item => item.commitment >= 70);

    commitmentData.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${item.unit}</strong></td>
        <td>${item.commitment}%</td>
        <td>${item.resignations} คน</td>
      `;
      commitmentTable.appendChild(row);
    });

    const lowResignations = lowCommitment.reduce((sum, item) => sum + item.resignations, 0);
    const highResignations = highCommitment.reduce((sum, item) => sum + item.resignations, 0);
    const shareLow = Math.round((lowResignations / totalResignations) * 100);
    const shareHigh = Math.round((highResignations / totalResignations) * 100);

    commitmentSummary.innerHTML = `
      หน่วยที่มีความผูกพันต่ำกว่า 65% (${lowCommitment.length} หน่วย) คิดเป็น <span class="trend-indicator">${shareLow}%</span> ของการลาออกทั้งหมด (${lowResignations}/${totalResignations} คน) ขณะที่หน่วยที่มีคะแนน ≥ 70% มีเพียง ${shareHigh}% ของการลาออก (${highResignations} คน)
    `;

    const insightItems = [
      'OR มีผูกพันเพียง 58% แต่มีการลาออกสูงสุด 6 คน ต้องเร่งเสริมแผนรักษาคนโดยเฉพาะ N 4 คนและ PN 2 คน',
      'MICU และ DR อยู่ในกลุ่มผูกพันต่ำ (<65%) และสูญเสียรวม 6 คน สอดคล้องกับคะแนน Relax ต่ำและเวรหนัก',
      'หน่วยที่รักษาผูกพัน ≥70% เช่น 18D และ 23A มีการลาออกเพียง 2 คน แสดงผลของการสื่อสารและการสนับสนุนที่ต่อเนื่อง'
    ];

    insightItems.forEach(text => {
      const item = document.createElement('div');
      item.className = 'alert-item';
      item.textContent = text;
      commitmentInsights.appendChild(item);
    });

    const resignationTrendData = [
      { unit: 'OR', current: 6, commitment: 58, engagement: 60, happiness: 62, workloadPressure: 0.78, mitigation: 0.18 },
      { unit: 'MICU', current: 3, commitment: 61, engagement: 63, happiness: 59, workloadPressure: 0.74, mitigation: 0.18 },
      { unit: 'DR', current: 3, commitment: 63, engagement: 65, happiness: 64, workloadPressure: 0.68, mitigation: 0.15 },
      { unit: 'บางพระ', current: 3, commitment: 67, engagement: 68, happiness: 66, workloadPressure: 0.6, mitigation: 0.12 },
      { unit: 'Refer', current: 2, commitment: 69, engagement: 70, happiness: 65, workloadPressure: 0.58, mitigation: 0.12 },
      { unit: '18D', current: 2, commitment: 72, engagement: 74, happiness: 71, workloadPressure: 0.48, mitigation: 0.25 },
      { unit: '23A', current: 2, commitment: 74, engagement: 75, happiness: 73, workloadPressure: 0.45, mitigation: 0.28 }
    ];

    const forecastGrid = document.getElementById('forecastGrid');
    const forecastInsights = document.getElementById('forecastInsights');

    function formatHeadcount(value) {
      return Math.abs(value - Math.round(value)) < 0.05 ? Math.round(value).toString() : value.toFixed(1);
    }

    const forecastResults = resignationTrendData.map(item => {
      const satisfactionIndex = (item.commitment + item.engagement + item.happiness) / 3;
      const pressureWeight = item.workloadPressure * 40;
      const satisfactionWeight = Math.max(0, (70 - satisfactionIndex) * 0.6);
      const mitigationWeight = item.mitigation * 25;
      const riskIndex = Math.max(8, pressureWeight + satisfactionWeight - mitigationWeight);

      const baselineHalf = item.current * 0.45;
      const riskAdjustmentHalf = 1 + (riskIndex - 25) / 120;
      const forecastSix = Math.max(0.2, baselineHalf * riskAdjustmentHalf);

      const baselineYear = item.current;
      const riskAdjustmentYear = Math.max(0.55, 1 + (riskIndex - 25) / 90 - item.mitigation * 0.25);
      const forecastTwelve = Math.max(0.5, baselineYear * riskAdjustmentYear);

      const riskLevel = riskIndex >= 38 ? 'high' : riskIndex >= 26 ? 'moderate' : 'low';
      const riskLabel = riskLevel === 'high' ? 'เสี่ยงสูง' : riskLevel === 'moderate' ? 'เฝ้าระวัง' : 'เสถียร';
      const growthRate = item.current > 0 ? ((forecastTwelve - item.current) / item.current) * 100 : 0;

      return {
        ...item,
        satisfactionIndex,
        riskIndex,
        forecastSix,
        forecastTwelve,
        riskLevel,
        riskLabel,
        growthRate
      };
    });

    forecastResults.forEach(result => {
      const card = document.createElement('div');
      card.className = 'forecast-card';

      const growthSymbol = result.growthRate >= 0 ? '↑' : '↓';
      const growthClass = result.growthRate >= 0 ? 'forecast-trend' : 'forecast-trend down';
      const growthValue = `${result.growthRate >= 0 ? '+' : ''}${Math.round(result.growthRate)}% เทียบกับปีปัจจุบัน`;
      const relativeWidth = Math.max(20, Math.min(120, Math.round((result.forecastTwelve / (result.current || 1)) * 100)));

      card.innerHTML = `
        <div class="forecast-header">
          <h4>${result.unit}</h4>
          <span class="risk-badge ${result.riskLevel}">${result.riskLabel}</span>
        </div>
        <div class="forecast-metric">
          <span class="label">คาดการณ์ 6 เดือน</span>
          <span class="value">${formatHeadcount(result.forecastSix)} คน</span>
        </div>
        <div class="forecast-metric">
          <span class="label">คาดการณ์ 12 เดือน</span>
          <span class="value">${formatHeadcount(result.forecastTwelve)} คน</span>
        </div>
        <div class="${growthClass}">${growthSymbol} ${growthValue}</div>
        <div class="forecast-bar"><span style="width: ${relativeWidth}%;"></span></div>
        <p class="forecast-note">ดัชนีความพึงพอใจเฉลี่ย ${Math.round(result.satisfactionIndex)}% | ภาระงาน ${Math.round(result.workloadPressure * 100)}% | แผนลดความเสี่ยง ${Math.round(result.mitigation * 100)}%</p>
      `;

      forecastGrid.appendChild(card);
    });

    const totalForecastTwelve = forecastResults.reduce((sum, item) => sum + item.forecastTwelve, 0);
    const totalCurrent = resignationTrendData.reduce((sum, item) => sum + item.current, 0);
    const totalDiff = totalForecastTwelve - totalCurrent;
    const diffLabel = totalDiff >= 0 ? 'เพิ่ม' : 'ลดลง';
    const diffPrefix = totalDiff >= 0 ? '+' : '-';
    const diffPercent = totalCurrent > 0 ? Math.abs(totalDiff) / totalCurrent * 100 : 0;

    const highRiskUnits = forecastResults.filter(item => item.riskLevel === 'high');
    const moderateRiskUnits = forecastResults.filter(item => item.riskLevel === 'moderate');
    const stableUnits = forecastResults.filter(item => item.riskLevel === 'low');

    const priorityGroup = highRiskUnits.length ? highRiskUnits : moderateRiskUnits.slice(0, 2);
    const priorityLabel = highRiskUnits.length ? 'หน่วยเสี่ยงสูง' : 'หน่วยที่ต้องเฝ้าระวัง';

    const summaryItems = [
      `แบบจำลองคาดว่าการลาออกอาจ${diffLabel}เป็น ${formatHeadcount(totalForecastTwelve)} คนใน 12 เดือน (${diffPrefix}${formatHeadcount(Math.abs(totalDiff))} คน หรือ ${diffPrefix}${diffPercent.toFixed(1)}%)`,
      priorityGroup.length
        ? `${priorityLabel}: ${priorityGroup.map(item => `${item.unit} (${formatHeadcount(item.forecastTwelve)} คน, ดัชนี ${Math.round(item.riskIndex)})`).join(', ')}`
        : 'ไม่มีหน่วยที่อยู่ในระดับเสี่ยงสูง ข้อมูลบ่งชี้ว่ามาตรการที่มีอยู่สามารถรักษาระดับได้',
      stableUnits.length
        ? `จุดแข็งที่ควรต่อยอด: ${stableUnits.slice(0, 2).map(item => `${item.unit} (${formatHeadcount(item.forecastTwelve)} คน, แผนลดความเสี่ยง ${Math.round(item.mitigation * 100)}%)`).join(', ')}`
        : 'ควรวางมาตรการเชิงรุกเพิ่มเติมเพื่อสร้างหน่วยตัวอย่างที่มีความเสถียร'
    ];

    summaryItems.forEach(text => {
      const item = document.createElement('div');
      item.className = 'alert-item';
      item.textContent = text;
      forecastInsights.appendChild(item);
    });

    const regressionSummary = document.getElementById('regressionSummary');
    const regressionTableBody = document.getElementById('regressionTableBody');
    const regressionInsights = document.getElementById('regressionInsights');

    if (regressionSummary && regressionTableBody && regressionInsights) {
      const regressionFeatures = ['commitment', 'engagement', 'happiness', 'workloadPressure', 'mitigation'];
      const featureLabels = {
        commitment: 'ความผูกพัน (Commitment)',
        engagement: 'ความผูกพันต่อองค์กร (Engagement)',
        happiness: 'ความสุขรวม (Happiness Index)',
        workloadPressure: 'แรงกดดันจากภาระงาน',
        mitigation: 'แผนลดความเสี่ยง (Mitigation)'
      };

      const nuanceMap = {
        commitment: {
          positive: 'ต้องทบทวนคุณภาพการมีส่วนร่วม เพราะคะแนนผูกพันที่สูงขึ้นยังสัมพันธ์กับลาออกที่เพิ่มขึ้น',
          negative: 'การยกระดับความผูกพันช่วยลดโอกาสลาออกของหน่วยนั้นอย่างมีนัยสำคัญ'
        },
        engagement: {
          positive: 'ควรตรวจสอบองค์ประกอบเชิงคุณภาพ เพราะการมีส่วนร่วมที่สูงยังไม่เพียงพอที่จะลดการลาออก',
          negative: 'การเสริมโครงการมีส่วนร่วมทำให้การลาออกชะลอลงอย่างชัดเจน'
        },
        happiness: {
          positive: 'คะแนนความสุขที่สูงขึ้นยังสัมพันธ์กับการลาออก จึงควรแยกดูมิติเฉพาะที่อาจยังมีปัญหา',
          negative: 'การยกระดับความสุขหน้างานช่วยสร้างแรงจูงใจให้ทีมอยู่ต่อ'
        },
        workloadPressure: {
          positive: 'ภาระงานที่กดดันสูงเป็นตัวเร่งการลาออก ต้องจัดการทรัพยากรและกระจายเวร',
          negative: 'การควบคุมภาระงานช่วยลดแรงผลักดันให้บุคลากรลาออก'
        },
        mitigation: {
          positive: 'แผนลดความเสี่ยงที่เข้มข้นยังไม่ถูกใช้อย่างมีประสิทธิภาพ ต้องทบทวนการดำเนินงาน',
          negative: 'การลงทุนในแผนลดความเสี่ยงช่วยลดการลาออกได้จริง'
        }
      };

      function calculateStats(values) {
        const mean = values.reduce((sum, value) => sum + value, 0) / values.length;
        const variance = values.reduce((sum, value) => sum + Math.pow(value - mean, 2), 0) / Math.max(1, values.length - 1);
        const stdDev = Math.sqrt(variance) || 1;
        return { mean, stdDev };
      }

      function standardize(value, stats) {
        return stats.stdDev === 0 ? 0 : (value - stats.mean) / stats.stdDev;
      }

      function transpose(matrix) {
        return matrix[0].map((_, columnIndex) => matrix.map(row => row[columnIndex]));
      }

      function multiplyMatrices(a, b) {
        const rows = a.length;
        const cols = b[0].length;
        const result = Array.from({ length: rows }, () => Array(cols).fill(0));
        for (let i = 0; i < rows; i++) {
          for (let k = 0; k < b.length; k++) {
            const value = a[i][k];
            for (let j = 0; j < cols; j++) {
              result[i][j] += value * b[k][j];
            }
          }
        }
        return result;
      }

      function multiplyMatrixVector(matrix, vector) {
        return matrix.map(row => row.reduce((sum, value, index) => sum + value * vector[index], 0));
      }

      function invertMatrix(matrix) {
        const n = matrix.length;
        const augmented = matrix.map((row, i) => {
          const identityRow = Array.from({ length: n }, (_, j) => (i === j ? 1 : 0));
          return [...row, ...identityRow];
        });

        for (let i = 0; i < n; i++) {
          let pivotRow = i;
          for (let j = i + 1; j < n; j++) {
            if (Math.abs(augmented[j][i]) > Math.abs(augmented[pivotRow][i])) {
              pivotRow = j;
            }
          }

          const pivotValue = augmented[pivotRow][i];
          if (Math.abs(pivotValue) < 1e-10) {
            throw new Error('Matrix is singular and cannot be inverted');
          }

          if (pivotRow !== i) {
            [augmented[i], augmented[pivotRow]] = [augmented[pivotRow], augmented[i]];
          }

          const pivot = augmented[i][i];
          for (let j = 0; j < 2 * n; j++) {
            augmented[i][j] /= pivot;
          }

          for (let row = 0; row < n; row++) {
            if (row !== i) {
              const factor = augmented[row][i];
              for (let col = 0; col < 2 * n; col++) {
                augmented[row][col] -= factor * augmented[i][col];
              }
            }
          }
        }

        return augmented.map(row => row.slice(n));
      }

      const featureStats = {};
      regressionFeatures.forEach(key => {
        const values = resignationTrendData.map(item => item[key]);
        featureStats[key] = calculateStats(values);
      });

      const targetStats = calculateStats(resignationTrendData.map(item => item.current));
      const y = resignationTrendData.map(item => standardize(item.current, targetStats));

      const designMatrix = resignationTrendData.map(item => {
        const row = [1];
        regressionFeatures.forEach(key => {
          row.push(standardize(item[key], featureStats[key]));
        });
        return row;
      });

      const transposed = transpose(designMatrix);
      const xtx = multiplyMatrices(transposed, designMatrix);
      const xtxInverse = invertMatrix(xtx);
      const xty = multiplyMatrixVector(transposed, y);
      const coefficients = multiplyMatrixVector(xtxInverse, xty);

      const predictions = designMatrix.map(row => row.reduce((sum, value, index) => sum + value * coefficients[index], 0));
      const meanY = y.reduce((sum, value) => sum + value, 0) / y.length;
      const ssTotal = y.reduce((sum, value) => sum + Math.pow(value - meanY, 2), 0);
      const ssResidual = y.reduce((sum, value, index) => sum + Math.pow(value - predictions[index], 2), 0);
      const rSquared = ssTotal === 0 ? 1 : 1 - ssResidual / ssTotal;

      const regressionResults = regressionFeatures.map((key, index) => {
        const coefficient = coefficients[index + 1];
        const direction = coefficient >= 0 ? 'positive' : 'negative';
        return {
          key,
          coefficient,
          magnitude: Math.abs(coefficient),
          direction,
          interpretation: `${direction === 'positive' ? 'คะแนนสูงขึ้นสัมพันธ์กับการลาออกเพิ่มขึ้น' : 'คะแนนสูงขึ้นสัมพันธ์กับการลาออกลดลง'} — ${nuanceMap[key][direction]}`
        };
      }).sort((a, b) => b.magnitude - a.magnitude);

      regressionTableBody.innerHTML = '';
      regressionResults.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${featureLabels[result.key]}</strong></td>
          <td>${result.coefficient >= 0 ? '+' : '-'}${Math.abs(result.coefficient).toFixed(2)}</td>
          <td><span class="hint">${result.interpretation}</span></td>
        `;
        regressionTableBody.appendChild(row);
      });

      const boundedRSquared = Math.max(0, Math.min(1, rSquared));
      regressionSummary.innerHTML = `
        แบบจำลองถดถอยเชิงเส้นอธิบายความแปรปรวนของจำนวนลาออกได้ <span class="trend-indicator">${(boundedRSquared * 100).toFixed(1)}%</span> โดยวัดผลจากข้อมูล 7 หน่วยงานและคะแนนเชิงดัชนีที่ผ่านการปรับมาตรฐาน
      `;

      const topRisk = regressionResults.find(result => result.coefficient > 0);
      const topProtective = regressionResults.find(result => result.coefficient < 0);

      const insightMessages = [];
      if (topRisk) {
        insightMessages.push(`${featureLabels[topRisk.key]} (β = ${topRisk.coefficient.toFixed(2)}) เป็นตัวเร่งการลาออกสูงสุด จำเป็นต้องจัดการเพื่อลดแรงกดดันหรือเพิ่มแรงจูงใจเชิงบวก`);
      }
      if (topProtective) {
        insightMessages.push(`${featureLabels[topProtective.key]} (β = ${topProtective.coefficient.toFixed(2)}) ทำหน้าที่เป็นเกราะป้องกัน หากเพิ่มคะแนนในมิตินี้ได้อีกจะช่วยลดจำนวนลาออก`);
      }

      regressionInsights.innerHTML = '';
      insightMessages.forEach(message => {
        const item = document.createElement('div');
        item.className = 'alert-item';
        item.textContent = message;
        regressionInsights.appendChild(item);
      });
    }

    const correlationData = [
      {
        dimension: 'การบังคับบัญชา',
        correlation: 0.82,
        effect: 'positive',
        insight: 'คะแนนหัวหน้าที่ชัดเจนและติดตามงานสม่ำเสมอช่วยเพิ่มคะแนนรวมเฉลี่ย +6.4 จุด'
      },
      {
        dimension: 'สิ่งแวดล้อมการทำงาน',
        correlation: 0.78,
        effect: 'positive',
        insight: 'พื้นที่ที่มีทรัพยากรพร้อมและปลอดภัยสัมพันธ์กับ Happinometer ที่ดีขึ้นใน 15/18 หน่วย'
      },
      {
        dimension: 'ค่าตอบแทนและสวัสดิการ',
        correlation: 0.74,
        effect: 'positive',
        insight: 'เมื่อคะแนนสวัสดิการเกิน 80% พบคะแนนรวมสูงขึ้นเฉลี่ย 5 จุดและอัตรา Stay สูงขึ้น'
      },
      {
        dimension: 'โอกาสเติบโตในวิชาชีพ',
        correlation: 0.69,
        effect: 'positive',
        insight: 'การสื่อสารเส้นทางเติบโตและการอบรมทำให้คะแนนรวมเพิ่มขึ้นต่อเนื่อง 3 ไตรมาส'
      },
      {
        dimension: 'ความสมดุลชีวิตกับงาน',
        correlation: -0.63,
        effect: 'negative',
        insight: 'หน่วยที่พนักงานรู้สึกพักไม่พอมีคะแนนรวมต่ำกว่าค่าเฉลี่ย 7 จุด'
      },
      {
        dimension: 'ภาระงานและทรัพยากร',
        correlation: -0.58,
        effect: 'negative',
        insight: 'คะแนนภาระงานตึง (Relax <60%) สัมพันธ์กับคะแนนรวมต่ำและการร้องเรียนด้านคุณภาพ'
      },
      {
        dimension: 'ความยุติธรรมของรางวัล',
        correlation: -0.66,
        effect: 'negative',
        insight: 'ความรู้สึกว่าแรงจูงใจไม่เป็นธรรมลากคะแนนรวมลงเฉลี่ย 6 จุดและเพิ่มแนวโน้มลาออก'
      }
    ];

    const positiveCorrelation = document.getElementById('positiveCorrelation');
    const negativeCorrelation = document.getElementById('negativeCorrelation');
    const correlationSummary = document.getElementById('correlationSummary');

    const positives = correlationData.filter(item => item.effect === 'positive').sort((a, b) => b.correlation - a.correlation);
    const negatives = correlationData
      .filter(item => item.effect === 'negative')
      .sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation));

    const maxDisplay = 3;

    function renderCorrelation(listElement, data, isNegative = false) {
      listElement.innerHTML = '';
      data.slice(0, maxDisplay).forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.className = 'correlation-item';
        const scoreClass = isNegative ? 'correlation-score negative' : 'correlation-score';
        const percentage = Math.round(Math.abs(item.correlation) * 100);
        wrapper.innerHTML = `
          <strong>${item.dimension}</strong>
          <div class="correlation-score-wrapper">
            <span class="${scoreClass}">r = ${item.correlation.toFixed(2)}</span>
          </div>
          <div class="correlation-bar">
            <span class="${isNegative ? 'negative' : ''}" style="width: ${percentage}%;"></span>
          </div>
          <p class="hint">${item.insight}</p>
        `;
        listElement.appendChild(wrapper);
      });
    }

    renderCorrelation(positiveCorrelation, positives);
    renderCorrelation(negativeCorrelation, negatives, true);

    if (positives.length && negatives.length) {
      const topPositive = positives[0];
      const topNegative = negatives[0];
      correlationSummary.innerHTML = `
        <span class="metric-title">สรุป</span>
        <span class="metric-value">${topPositive.dimension} vs ${topNegative.dimension}</span>
        <p class="metric-desc">มิติที่สัมพันธ์สูงสุดกับคะแนนรวมคือ <strong>${topPositive.dimension}</strong> (r = ${topPositive.correlation.toFixed(2)}) หากเพิ่มคะแนนด้านนี้ทุก 5 จุดจะดันคะแนนรวมเฉลี่ย +3 จุด ขณะที่ความเสี่ยงหลักคือ <strong>${topNegative.dimension}</strong> (r = ${topNegative.correlation.toFixed(2)}) ซึ่งเมื่อคะแนนต่ำกว่า 70% จะดึงคะแนนรวมลงเฉลี่ย 6 จุด</p>
      `;
    }
  </script>
</body>
</html>
