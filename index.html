<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Happinometer ฝ่ายการพยาบาล 2568</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=K2D:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #f2f7ff 0%, #fff5f7 35%, #f3fffa 100%);
      --card-bg: rgba(255, 255, 255, 0.85);
      --primary: #2c3d7a;
      --accent: #ff8a5b;
      --accent-2: #2bb1a8;
      --accent-3: #ffcd4b;
      --text: #1f2a44;
      --muted: #5d6a93;
      --shadow: 0 18px 40px rgba(44, 61, 122, 0.12);
      --radius-lg: 24px;
      --radius-md: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "K2D", sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 40px 16px 60px;
    }

    .dashboard {
      width: min(1180px, 100%);
      background: rgba(255, 255, 255, 0.72);
      border-radius: var(--radius-lg);
      padding: 36px 32px 48px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 28px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.9rem, 3vw, 2.4rem);
      font-weight: 600;
      color: var(--primary);
    }

    header p {
      margin: 0;
      font-size: 1rem;
      color: var(--muted);
      max-width: 720px;
      line-height: 1.6;
    }

    .tab-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 28px;
    }

    .tab-button {
      flex: 1;
      min-width: 160px;
      border: none;
      border-radius: 999px;
      padding: 12px 20px;
      font-size: 0.95rem;
      font-weight: 500;
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #2c3d7a, #3c58b9);
      color: #f7f9ff;
      box-shadow: 0 12px 30px rgba(60, 88, 185, 0.3);
    }

    .panel {
      display: none;
      animation: fade 0.4s ease;
    }

    .panel.active {
      display: grid;
      gap: 22px;
    }

    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-grid {
      display: grid;
      gap: 20px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 22px 24px;
      box-shadow: 0 12px 28px rgba(31, 42, 68, 0.1);
      border: 1px solid rgba(44, 61, 122, 0.08);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .card h2 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--primary);
    }

    .card h3 {
      margin: 0;
      font-size: 1.05rem;
      color: var(--primary);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(43, 177, 168, 0.16);
      color: #15766f;
      font-weight: 500;
      font-size: 0.85rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .metric {
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      box-shadow: 0 10px 20px rgba(44, 61, 122, 0.08);
      border: 1px solid rgba(44, 61, 122, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .metric-title {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .metric-value {
      font-size: 2.1rem;
      font-weight: 600;
      color: var(--primary);
    }

    .metric-desc {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .description-toggle {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .description-toggle .description-text.description-advanced {
      display: none;
    }

    .description-toggle[data-state="advanced"] .description-text.description-easy {
      display: none;
    }

    .description-toggle[data-state="advanced"] .description-text.description-advanced {
      display: block;
    }

    .description-toggle-button {
      align-self: flex-start;
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.78rem;
      font-weight: 500;
      background: linear-gradient(135deg, rgba(44, 61, 122, 0.14), rgba(60, 88, 185, 0.22));
      color: var(--primary);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .description-toggle-button:hover,
    .description-toggle-button:focus {
      background: linear-gradient(135deg, var(--primary), #3c58b9);
      color: #f7f9ff;
      box-shadow: 0 10px 18px rgba(60, 88, 185, 0.2);
      outline: none;
    }

    .bar-track {
      width: 100%;
      height: 12px;
      border-radius: 999px;
      background: rgba(44, 61, 122, 0.08);
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(135deg, var(--accent), #ff6f91);
      transition: width 0.6s ease;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .list-item {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 8px 20px rgba(31, 42, 68, 0.08);
    }

    .list-item strong {
      color: var(--primary);
      font-weight: 600;
    }

    .list-item span {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .hint {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .insight-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .correlation-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .correlation-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .correlation-item {
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 8px 20px rgba(31, 42, 68, 0.08);
    }

    .correlation-item strong {
      display: block;
      color: var(--primary);
      font-size: 1rem;
      margin-bottom: 6px;
    }

    .correlation-score-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .correlation-score {
      font-weight: 600;
      color: var(--accent-2);
    }

    .correlation-score.negative {
      color: var(--accent);
    }

    .correlation-bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(44, 61, 122, 0.08);
      overflow: hidden;
      margin: 10px 0;
    }

    .correlation-bar span {
      display: block;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(135deg, var(--accent-2), #3fd0c4);
    }

    .correlation-bar span.negative {
      background: linear-gradient(135deg, var(--accent), #ff6f91);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(255, 205, 75, 0.22);
      color: #9b6b00;
      font-size: 0.78rem;
      font-weight: 500;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .chip {
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(43, 177, 168, 0.14);
      color: #11655f;
      font-size: 0.85rem;
      cursor: default;
    }

    .matrix-wrapper {
      overflow-x: auto;
    }

    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 480px;
    }

    .matrix-table th,
    .matrix-table td {
      padding: 10px 12px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      text-align: center;
      font-size: 0.85rem;
    }

    .matrix-table th {
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
      font-weight: 600;
    }

    .matrix-table td {
      background: rgba(255, 255, 255, 0.85);
    }

    .matrix-cell {
      border-radius: 12px;
      padding: 8px 0;
      font-weight: 600;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--primary);
      min-height: 40px;
    }

    .matrix-cell.positive {
      color: #11655f;
    }

    .matrix-cell.negative {
      color: #a44a2d;
    }

    .matrix-cell.diagonal {
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
    }

    .matrix-legend {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      font-size: 0.8rem;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-swatch {
      width: 28px;
      height: 12px;
      border-radius: 999px;
    }

    .heatmap-wrapper {
      overflow-x: auto;
    }

    .heatmap-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 540px;
    }

    .heatmap-table th,
    .heatmap-table td {
      padding: 10px 12px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      font-size: 0.85rem;
      text-align: center;
    }

    .heatmap-table th {
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
      font-weight: 600;
      white-space: nowrap;
    }

    .heatmap-cell {
      border-radius: 12px;
      padding: 8px 0;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 40px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .heatmap-cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(31, 42, 68, 0.15);
    }

    .radar-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }

    .radar-select {
      min-width: 220px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(44, 61, 122, 0.18);
      background: rgba(255, 255, 255, 0.9);
      color: var(--primary);
      font-size: 0.95rem;
      box-shadow: inset 0 4px 12px rgba(31, 42, 68, 0.08);
    }

    .radar-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .radar-chart {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 18px;
      padding: 18px;
      border: 1px solid rgba(44, 61, 122, 0.12);
      box-shadow: 0 10px 24px rgba(31, 42, 68, 0.08);
      position: relative;
    }

    .radar-chart h4 {
      margin: 0 0 12px;
      font-size: 1rem;
      color: var(--primary);
    }

    .radar-chart canvas {
      width: 100%;
      height: 320px;
    }

    .radar-note {
      margin-top: 16px;
      font-size: 0.85rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .cluster-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .cluster-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 20px 22px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 10px 26px rgba(31, 42, 68, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .cluster-card.positive {
      background: rgba(43, 177, 168, 0.16);
      border-color: rgba(43, 177, 168, 0.4);
    }

    .cluster-card.neutral {
      background: rgba(255, 205, 75, 0.16);
      border-color: rgba(255, 205, 75, 0.4);
    }

    .cluster-card.warning {
      background: rgba(255, 138, 91, 0.16);
      border-color: rgba(255, 138, 91, 0.42);
    }

    .cluster-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .cluster-id {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .cluster-header h4 {
      margin: 4px 0 0;
      font-size: 1.15rem;
      color: var(--primary);
    }

    .cluster-score {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 999px;
      padding: 6px 12px;
    }

    .cluster-desc {
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .cluster-members {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .cluster-chip {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.7);
      color: var(--primary);
      font-size: 0.82rem;
      box-shadow: 0 6px 14px rgba(31, 42, 68, 0.08);
    }

    .cluster-metrics {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .cluster-subtitle {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .cluster-tag {
      margin-top: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
      font-size: 0.82rem;
      display: inline-block;
    }

    .cluster-tag.warning {
      background: rgba(255, 138, 91, 0.18);
      color: #a44a2d;
    }

    .cluster-summary {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .persona-summary {
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
      font-size: 0.9rem;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .persona-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .persona-card {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 18px;
      padding: 20px 22px;
      border: 1px solid rgba(44, 61, 122, 0.12);
      box-shadow: 0 10px 24px rgba(31, 42, 68, 0.08);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .persona-card.positive {
      background: rgba(43, 177, 168, 0.18);
      border-color: rgba(43, 177, 168, 0.45);
      box-shadow: 0 12px 28px rgba(43, 177, 168, 0.18);
    }

    .persona-card.neutral {
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(44, 61, 122, 0.12);
    }

    .persona-card.warning {
      background: rgba(255, 205, 75, 0.2);
      border-color: rgba(255, 205, 75, 0.45);
    }

    .persona-card.critical {
      background: rgba(255, 138, 91, 0.18);
      border-color: rgba(255, 138, 91, 0.45);
      box-shadow: 0 12px 30px rgba(255, 138, 91, 0.2);
    }

    .persona-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }

    .persona-tag {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .persona-score {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--muted);
      background: rgba(44, 61, 122, 0.1);
      border-radius: 999px;
      padding: 4px 10px;
      white-space: nowrap;
    }

    .persona-card.positive .persona-score {
      background: rgba(255, 255, 255, 0.4);
      color: #11655f;
    }

    .persona-card.warning .persona-score,
    .persona-card.critical .persona-score {
      background: rgba(255, 255, 255, 0.5);
      color: #a44a2d;
    }

    .persona-desc {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .persona-focus {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--primary);
    }

    .persona-members {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .persona-chip {
      padding: 6px 12px;
      border-radius: 12px;
      background: rgba(44, 61, 122, 0.08);
      color: var(--primary);
      font-size: 0.8rem;
      box-shadow: 0 6px 16px rgba(31, 42, 68, 0.08);
    }

    .persona-card.positive .persona-chip {
      background: rgba(255, 255, 255, 0.7);
      color: #11655f;
    }

    .persona-card.warning .persona-chip,
    .persona-card.critical .persona-chip {
      background: rgba(255, 255, 255, 0.75);
      color: #a44a2d;
    }

    .unit-select {
      width: 100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(44, 61, 122, 0.18);
      font-size: 0.95rem;
      color: var(--primary);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: inset 0 4px 12px rgba(31, 42, 68, 0.08);
    }

    .unit-details {
      display: grid;
      gap: 16px;
      margin-top: 18px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.88);
      border-radius: 16px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 8px 20px rgba(31, 42, 68, 0.08);
    }

    .detail-row span {
      color: var(--muted);
      font-size: 0.92rem;
    }

    .detail-row strong {
      color: var(--primary);
      font-size: 1.05rem;
    }

    .alert-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .alert-item {
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255, 138, 91, 0.15);
      color: #a44a2d;
      font-size: 0.88rem;
      line-height: 1.4;
    }

    .attrition-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .attrition-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 18px 20px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 10px 24px rgba(31, 42, 68, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .attrition-card h4 {
      margin: 0;
      color: var(--primary);
      font-size: 1rem;
    }

    .attrition-card .figure {
      font-size: 2rem;
      font-weight: 600;
      color: var(--accent);
    }

    .commitment-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .commitment-table th,
    .commitment-table td {
      border-bottom: 1px solid rgba(44, 61, 122, 0.12);
      padding: 10px 8px;
      text-align: left;
    }

    .commitment-table th {
      color: var(--muted);
      font-weight: 600;
    }

    .commitment-table td strong {
      color: var(--primary);
    }

    .regression-table th:nth-child(2),
    .regression-table td:nth-child(2) {
      text-align: center;
      width: 120px;
      white-space: nowrap;
    }

    .regression-table td:nth-child(3) {
      max-width: 420px;
    }

    .commitment-insight {
      background: rgba(43, 177, 168, 0.12);
      border-radius: 14px;
      padding: 12px 14px;
      color: #126b64;
      font-size: 0.9rem;
      margin-top: 12px;
    }

    .forecast-grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .forecast-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 18px;
      padding: 18px 20px;
      border: 1px solid rgba(44, 61, 122, 0.08);
      box-shadow: 0 10px 24px rgba(31, 42, 68, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .forecast-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .risk-badge {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      background: rgba(43, 177, 168, 0.15);
      color: #11655f;
    }

    .risk-badge.moderate {
      background: rgba(255, 205, 75, 0.25);
      color: #8d6500;
    }

    .risk-badge.high {
      background: rgba(255, 138, 91, 0.25);
      color: #b4481d;
    }

    .forecast-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .forecast-metric .value {
      font-weight: 600;
      color: var(--primary);
      font-size: 1.05rem;
    }

    .forecast-bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(44, 61, 122, 0.1);
      overflow: hidden;
    }

    .forecast-bar span {
      display: block;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(135deg, #ff8a5b, #ff6f91);
      transition: width 0.6s ease;
    }

    .forecast-trend {
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .forecast-trend.down {
      color: var(--accent-2);
    }

    .forecast-note {
      font-size: 0.82rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      color: var(--accent);
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 12px;
    }

    footer {
      margin-top: 24px;
      font-size: 0.8rem;
      color: var(--muted);
      text-align: right;
    }

    @media (max-width: 780px) {
      body {
        padding: 24px 12px 40px;
      }
      .dashboard {
        padding: 28px 20px 40px;
      }
      .tab-button {
        min-width: 140px;
      }
    }
  </style>
</head>
<body>
  <main class="dashboard">
    <header>
      <div class="pill">Happinometer &amp; Job Satisfaction 2568</div>
      <h1>สรุปความสุขและความผูกพันบุคลากรพยาบาลระดับบริหาร</h1>
      <p>
        ข้อมูลนี้สังเคราะห์จากผลสำรวจ Happinometer, ความผูกพัน และความพึงพอใจในการทำงานปี 2568 โดยมุ่งเน้นสำหรับผู้บริหารการพยาบาล เพื่อช่วยชี้โอกาสการเสริมพลังทีมและเฝ้าระวังความเสี่ยงด้านบุคลากร
      </p>
    </header>

    <nav class="tab-bar">
      <button class="tab-button active" data-target="overview">ภาพรวมความสุข</button>
      <button class="tab-button" data-target="satisfaction">ความพึงพอใจงาน</button>
      <button class="tab-button" data-target="focus">จุดเน้นผู้บริหาร</button>
      <button class="tab-button" data-target="attrition">การลาออก 2568</button>
    </nav>

    <section id="overview" class="panel active">
      <div class="card">
        <h2>ค่าเด่นจาก Happinometer และความผูกพัน</h2>
        <div class="grid-3">
          <div class="metric" style="background: rgba(43, 177, 168, 0.18);">
            <span class="metric-title">หน่วยที่สร้างประสบการณ์โดดเด่น</span>
            <span class="metric-value">หอพัก 90.0%</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">คะแนน Overall Happy สูงที่สุด 90% พร้อมระดับความผูกพัน 73.33% (3.67) แสดงถึงการดูแลชีวิต-งานที่สมดุล</span>
              <span class="description-text description-advanced">คะแนน Overall Happy = 90.0% ซึ่งเป็นค่าร้อยละสูงสุดในชุดข้อมูล (อันดับที่ 1) และคะแนนผูกพันเฉลี่ย 73.33% (ค่าเฉลี่ยมาตราไลเคิร์ต 3.67) อยู่เหนือเกณฑ์ 70% จัดอยู่ในควอไทล์บนสุดของการแจกแจง สอดคล้องกับนิยามดัชนีความสุขเชิงสมดุลของราชบัณฑิตยสถาน</span>
            </p>
          </div>
          <div class="metric" style="background: rgba(255, 205, 75, 0.18);">
            <span class="metric-title">กลุ่ม OPD ที่เติบโตต่อเนื่อง</span>
            <span class="metric-value">OPD2 84.3%</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">คะแนนความสุขรวม 84.29% และความผูกพัน 77.62% สะท้อนการบริหารภาระงานและสวัสดิการที่สมดุล</span>
              <span class="description-text description-advanced">คะแนนความสุขรวมเฉลี่ยถ่วงน้ำหนัก 84.29% และดัชนีความผูกพัน 77.62% อยู่ในกลุ่มเปอร์เซ็นไทล์ที่ 80 ขึ้นไป โดยมีส่วนเบี่ยงเบนจากค่ามัธยฐานเชิงบวก สะท้อนการจัดสรรทรัพยากรที่ลดความคลาดเคลื่อนของภาระงาน</span>
            </p>
          </div>
          <div class="metric" style="background: rgba(255, 138, 91, 0.18);">
            <span class="metric-title">หน่วยที่ต้องเร่งฟื้นฟูความสุข</span>
            <span class="metric-value">PICU 48.9%</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">คะแนนความสุขรวมต่ำสุด 48.89% แม้ความพึงพอใจงานยังสูง (81%) ต้องเน้นสนับสนุนสุขภาพกายใจและกำลังคน</span>
              <span class="description-text description-advanced">คะแนนความสุขรวม 48.89% ต่ำกว่าค่าร้อยละ 50 และอยู่ห่างจากค่าเฉลี่ยคาดการณ์มากกว่า 1 ส่วนเบี่ยงเบนมาตรฐาน ขณะที่คะแนนความพึงพอใจ 81% ยังสูง สะท้อนภาวะความแปรปรวนระหว่างดัชนี (discrepancy) ที่ต้องจัดการทรัพยากรบุคคลเชิงสถิติ</span>
            </p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>อันดับความสุขรวม (Overall Happy)</h3>
        <div class="chip-group">
          <div class="chip">Top: หอพัก 90.0%</div>
          <div class="chip">Top: OPD2 84.3%</div>
          <div class="chip">Top: CSSD 81.3%</div>
          <div class="chip" style="background: rgba(255, 138, 91, 0.18); color: #a44a2d;">Low: PICU 48.9%</div>
          <div class="chip" style="background: rgba(255, 138, 91, 0.18); color: #a44a2d;">Low: 19C 53.9%</div>
          <div class="chip" style="background: rgba(255, 138, 91, 0.18); color: #a44a2d;">Low: 20B 57.0%</div>
        </div>
        <div class="list">
          <div class="list-item">
            <div>
              <strong>หน่วยที่ขับเคลื่อนประสบการณ์เชิงบวก</strong>
              <p class="hint description-toggle">
                <span class="description-text description-easy">CSSD 81.25%, ปฐมภูมิ 80.0%, OPD3 74.21% ร่วมสร้างต้นแบบทีมสุขภาพจิตดี</span>
                <span class="description-text description-advanced">CSSD 81.25%, ปฐมภูมิ 80.0% และ OPD3 74.21% มีคะแนนสูงกว่ามัธยฐานอย่างมีนัยสำคัญ (ส่วนเบี่ยงเบนมาตรฐานบวก) จัดอยู่ในกลุ่มเปอร์เซ็นไทล์ ≥ 70 จึงเป็นฐานข้อมูลสำหรับการวิเคราะห์เชิงอ้างอิง</span>
              </p>
            </div>
            <span>ดัชนี ≥ 74%</span>
          </div>
          <div class="list-item">
            <div>
              <strong>พื้นที่ต้องเสริมสุขภาพองค์รวม</strong>
              <p class="hint description-toggle">
                <span class="description-text description-easy">PICU (Relax 52.89%, Happy Plus 48.15%), 20B (Body 62.4%, Relax 48.8%) และ 19C (Relax 50.86%) ต้องเติมพลังงานและระบบสนับสนุน</span>
                <span class="description-text description-advanced">คะแนน Relax ต่ำกว่า 55% และ Happy Plus ต่ำกว่า 50% ของ PICU, 20B และ 19C อยู่ในช่วงควอไทล์ล่างสุดของการแจกแจง บ่งชี้ความเสี่ยงเชิงสถิติที่ต้องเสริมทรัพยากรและมาตรการฟื้นฟู</span>
              </p>
            </div>
            <span>ดัชนี &lt; 60%</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>การจัดกลุ่มหน่วยงานตามโปรไฟล์ความสุข (Cluster Analysis)</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">
            วิเคราะห์คะแนน 11 มิติความสุขเพื่อค้นหาหน่วยงานที่มีรูปแบบคล้ายกัน ช่วยให้เลือกกลยุทธ์สนับสนุนที่ตรงจุดและขยายผลจากทีมต้นแบบได้รวดเร็ว
          </span>
          <span class="description-text description-advanced">
            ใช้วิธีจัดกลุ่ม (k-means clustering) บนคะแนน 11 มิติความสุขเพื่อหาโครงสร้างกลุ่มที่มีลักษณะคล้ายกัน ลดความคลาดเคลื่อนภายในกลุ่ม (within-cluster variance) และช่วยออกแบบกลยุทธ์สนับสนุนตามค่าศูนย์กลาง (centroid)
          </span>
        </p>
        <div class="cluster-summary" id="clusterSummary"></div>
        <div class="cluster-grid" id="clusterGrid"></div>
      </div>

      <div class="card">
        <h3>Engagement Personas</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">
            จำแนกหน่วยงานตามระดับความสุข (Happinometer) และความผูกพัน เพื่อสกัด persona สำคัญ เช่น “Highly Happy but Lowly Committed” สำหรับวางแผนการดูแลเฉพาะกลุ่ม
          </span>
          <span class="description-text description-advanced">
            ใช้การจำแนกตามเมตริก Happinometer และ Engagement เพื่อแบ่ง persona ตามเกณฑ์ตัด (threshold) ของคะแนน โดยอาศัยการวิเคราะห์เชิงจำแนก (classification) เพื่อระบุโครงสร้างกลุ่มอย่างมีนัยสำคัญ เช่น กลุ่ม Highly Happy but Lowly Committed
          </span>
        </p>
        <div class="persona-summary" id="personaSummary"></div>
        <div class="persona-grid" id="personaGrid"></div>
      </div>

      <div class="card">
        <h3>ความผูกพันพนักงาน (Engagement Score)</h3>
        <div class="insight-grid">
          <div>
            <div class="tag">สูงสุด</div>
            <div class="list" style="margin-top: 10px;">
              <div class="list-item">
                <div>
                  <strong>งานระบาด 93.33%</strong>
                  <span>คะแนน 4.67 (SD 0.16) สะท้อนผู้นำและภารกิจชัดเจน</span>
                </div>
              </div>
              <div class="list-item">
                <div>
                  <strong>ผู้บริหาร 80.58%</strong>
                  <span>ความผูกพันสูงควบคู่ความสุข 75.43%</span>
                </div>
              </div>
              <div class="list-item">
                <div>
                  <strong>ปฐมภูมิ 78.67%</strong>
                  <span>ระบบทีมและ Happy Plus 84% สนับสนุนการรักษาผลงาน</span>
                </div>
              </div>
            </div>
          </div>
          <div>
            <div class="tag">เฝ้าระวัง</div>
            <div class="list" style="margin-top: 10px;">
              <div class="list-item">
                <div>
                  <strong>22A &amp; Stroke 59.39%</strong>
                  <span>คะแนน Relax 55.27% และ Happy Plus 56.36% บ่งชี้ภาระงานตึง</span>
                </div>
              </div>
              <div class="list-item">
                <div>
                  <strong>20B 59.56%</strong>
                  <span>Body 62.4% และ Engagement ด้าน Stay เพียง 55.5%</span>
                </div>
              </div>
              <div class="list-item">
                <div>
                  <strong>19C 60.71%</strong>
                  <span>Relax 50.86% ต้องจัดการภาระงานและทรัพยากรสนับสนุน</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="satisfaction" class="panel">
      <div class="card">
        <h2>ไฮไลต์ความพึงพอใจในการทำงาน</h2>
        <div class="grid-3">
          <div class="metric" style="background: rgba(43, 177, 168, 0.18);">
            <span class="metric-title">คะแนนรวมสูงสุด</span>
            <span class="metric-value">สำนักงาน 87.2%</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">โดดเด่นในสิ่งแวดล้อมการทำงาน (90%) และสวัสดิการ (86%) เป็นต้นแบบพื้นที่สนับสนุน</span>
              <span class="description-text description-advanced">คะแนนสิ่งแวดล้อมการทำงาน 90% และสวัสดิการ 86% อยู่เหนือค่าเฉลี่ยกลุ่มตัวอย่างมากกว่า 1 ส่วนเบี่ยงเบนมาตรฐาน ส่งผลให้ดัชนีความพึงพอใจรวม 87.2% อยู่ในกลุ่มค่าร้อยละสูงสุด และจัดเป็น "ตัวแปรต้นแบบ" ตามนิยามเชิงสถิติ</span>
            </p>
          </div>
          <div class="metric" style="background: rgba(255, 205, 75, 0.18);">
            <span class="metric-title">หน่วยบริการที่ยังรักษาคะแนนสูง</span>
            <span class="metric-value">CSSD 83.2%</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">คะแนนการบังคับบัญชา 85.6% และภาพรวม 83.2% สนับสนุนคุณภาพบริการด่านหลัง</span>
              <span class="description-text description-advanced">คะแนนการบังคับบัญชา 85.6% และคะแนนรวม 83.2% อยู่ในช่วงเปอร์เซ็นไทล์ที่ 75 ขึ้นไป โดยสูงกว่าค่ากลางราว +7 จุด สะท้อนความได้เปรียบของโครงสร้างการกำกับงานในเชิงสถิติ</span>
            </p>
          </div>
          <div class="metric" style="background: rgba(255, 138, 91, 0.18);">
            <span class="metric-title">ประเด็นปานกลาง</span>
            <span class="metric-value">ER 74.0%</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">ค่าตอบแทนและสวัสดิการอยู่ในระดับปานกลาง (68.2%) ควรเสริมรางวัลและการดูแลใจ</span>
              <span class="description-text description-advanced">คะแนนค่าตอบแทน 68.2% ต่ำกว่าค่าเฉลี่ยกลุ่มประมาณ 0.4 ส่วนเบี่ยงเบนมาตรฐาน และดัชนีความพึงพอใจรวม 74.0% อยู่ในควอไทล์ที่ 2 บ่งชี้ความจำเป็นในการเพิ่มแรงจูงใจเพื่อลดความเสี่ยงเชิงสถิติ</span>
            </p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>ภาพรวมตามมิติ</h3>
        <div class="insight-grid">
          <div class="metric">
            <span class="metric-title">การบังคับบัญชา</span>
            <span class="metric-value">เฉลี่ย 3.9 (78%)</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">หน่วยที่ดีที่สุด: สำนักงาน 87.6%, CSSD 85.6% สะท้อนภาวะผู้นำที่ชัด</span>
              <span class="description-text description-advanced">สำนักงาน (87.6%) และ CSSD (85.6%) สูงกว่าค่าเฉลี่ยมิติการบังคับบัญชามากกว่า 1 ส่วนเบี่ยงเบนมาตรฐาน ทำให้ค่าสัมประสิทธิ์การแปรปรวน (CV) ต่ำ แสดงถึงความสม่ำเสมอของภาวะผู้นำ</span>
            </p>
            <div class="hint description-toggle">
              <span class="description-text description-easy">ต้องเฝ้าระวัง: ไตเทียม 68.8% (ปานกลาง)</span>
              <span class="description-text description-advanced">ต้องเฝ้าระวัง: คะแนนไตเทียม 68.8% ต่ำกว่าค่ากลาง -0.3 ส่วนเบี่ยงเบนมาตรฐาน บ่งชี้แนวโน้มลดลงของมิติการบังคับบัญชาตามเกณฑ์ค่าคะแนน z-score</span>
            </div>
          </div>
          <div class="metric">
            <span class="metric-title">สิ่งแวดล้อมการทำงาน</span>
            <span class="metric-value">เฉลี่ย 3.9 (78%)</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">PICU 92.8% และสำนักงาน 90% แสดงความพร้อมด้านทรัพยากรและความปลอดภัย</span>
              <span class="description-text description-advanced">คะแนนสิ่งแวดล้อมของ PICU 92.8% และสำนักงาน 90% อยู่ในเปอร์เซ็นไทล์ ≥ 90 โดยค่าเฉลี่ยสูงกว่ากลุ่มเปรียบเทียบ +12 จุด ส่งผลให้ดัชนีความเสี่ยง (Risk Index) ต่ำกว่ามาตรฐาน</span>
            </p>
            <div class="hint description-toggle">
              <span class="description-text description-easy">22A&amp;Stroke 75.6% ยังต่ำกว่าค่าเฉลี่ยหน่วยบริการ</span>
              <span class="description-text description-advanced">22A&amp;Stroke มีคะแนนสิ่งแวดล้อม 75.6% ต่ำกว่าค่าเฉลี่ยโดยประมาณ 0.2 ส่วนเบี่ยงเบนมาตรฐาน แสดงว่าจัดอยู่ในเปอร์เซ็นไทล์ต่ำกว่าค่ากลาง ต้องติดตามแนวโน้มเชิงเวลา</span>
            </div>
          </div>
          <div class="metric">
            <span class="metric-title">ค่าตอบแทนและสวัสดิการ</span>
            <span class="metric-value">เฉลี่ย 3.8 (76%)</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">OPD2 83.4% และ CSSD 82.2% ช่วยรักษากำลังคน</span>
              <span class="description-text description-advanced">ค่าเฉลี่ยค่าตอบแทนของ OPD2 (83.4%) และ CSSD (82.2%) สูงกว่าค่ากลาง +6 จุด ลดอัตราส่วนลาออกต่อหัวลง (resignation ratio) ตามแนวคิดสัมประสิทธิ์สหสัมพันธ์เชิงลบกับการคงอยู่</span>
            </p>
            <div class="hint description-toggle">
              <span class="description-text description-easy">ER 74.6%, ไตเทียม 80.8% (แต่ค่าตอบแทนย่อย 66.8%) ต้องปรับสวัสดิการเชิงแรงจูงใจ</span>
              <span class="description-text description-advanced">ER 74.6% และไตเทียม 80.8% แต่มีองค์ประกอบค่าตอบแทนย่อยเพียง 66.8% ทำให้ค่าเฉลี่ยถ่วงน้ำหนักลดลงและเพิ่มความแปรปรวนภายในมิติ (ภาวะ heterogeneity) จำเป็นต้องเพิ่มเครื่องจูงใจ</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>สรุปจุดเด่นและโอกาส</h3>
        <div class="insight-grid">
          <div class="metric" style="background: rgba(43, 177, 168, 0.16);">
            <span class="metric-title">จุดแข็งที่ต้องต่อยอด</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">
                OPD2, CSSD และสำนักงานสร้างคะแนน ≥ 80% ในหลายมิติ แนะนำให้ใช้เป็นพื้นที่เรียนรู้ร่วมเพื่อถ่ายทอดแนวทางบริหารทีมและการดูแลทรัพยากร
              </span>
              <span class="description-text description-advanced">
                OPD2, CSSD และสำนักงานมีคะแนนเฉลี่ยหลายมิติ ≥ 80% อยู่ในกลุ่มเปอร์เซ็นไทล์ที่ 75-90 ทำให้ค่าเฉลี่ยรวมของกลุ่มต้นแบบสูงกว่ากลุ่มอื่นมากกว่า 1 ส่วนเบี่ยงเบนมาตรฐาน เหมาะสำหรับเป็นฐานอ้างอิง (benchmark) เชิงสถิติ
              </span>
            </p>
          </div>
          <div class="metric" style="background: rgba(255, 205, 75, 0.16);">
            <span class="metric-title">โอกาสพัฒนาเชิงระบบ</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">
                มิติ “ค่าตอบแทนและสวัสดิการ” ของ ER (68.2%) และไตเทียม (66.8%) พร้อมมิติ “ลักษณะงาน” ของ SICU (67.8%) สะท้อนความต้องการเสริมกำลังคนและการชดเชยภาระงาน
              </span>
              <span class="description-text description-advanced">
                คะแนนค่าตอบแทนของ ER 68.2% และไตเทียม 66.8% ต่ำกว่าค่าเฉลี่ยรวมประมาณ 0.5 ส่วนเบี่ยงเบนมาตรฐาน ขณะที่คะแนนลักษณะงานของ SICU 67.8% อยู่ต่ำกว่าเกณฑ์ตัด 70% แสดงความเสี่ยงเชิงสถิติที่ต้องเสริมอัตรากำลังและค่าชดเชย
              </span>
            </p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>สหสัมพันธ์มิติความพึงพอใจต่อคะแนนรวม</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">วิเคราะห์จากข้อมูล 18 หน่วยบริการ พบว่าการเสริมบางมิติเชื่อมโยงโดยตรงต่อคะแนนภาพรวม ขณะที่การละเลยบางมิติสัมพันธ์กับความเสี่ยงคะแนนต่ำ</span>
          <span class="description-text description-advanced">วิเคราะห์สหสัมพันธ์เพียร์สัน (Pearson's r) จากข้อมูล 18 หน่วย พบมิติที่มีค่าสัมประสิทธิ์บวกสูงต่อคะแนนรวม และมิติที่มีค่าสัมประสิทธิ์ลบซึ่งเพิ่มความเสี่ยงคะแนนต่ำ</span>
        </p>
        <div class="metric" id="correlationSummary" style="background: rgba(43, 177, 168, 0.14);"></div>
        <div class="correlation-grid">
          <div>
            <h4>ตัวขับเคลื่อนคะแนนสูง</h4>
            <div class="correlation-list" id="positiveCorrelation"></div>
          </div>
          <div>
            <h4>ตัวบ่งชี้ความเสี่ยงคะแนนต่ำ</h4>
            <div class="correlation-list" id="negativeCorrelation"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Diagnostic &amp; Relationship Analysis</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">สำรวจความสัมพันธ์ระหว่างมิติความพึงพอใจหลัก (การบังคับบัญชา ค่าตอบแทน ลักษณะงาน สิ่งแวดล้อม และโอกาสเติบโต) เพื่อระบุว่าคู่มิติใดเคลื่อนไปด้วยกันหรือสวนทางกัน</span>
          <span class="description-text description-advanced">ใช้เมทริกซ์สหสัมพันธ์ (correlation matrix) วิเคราะห์ค่าความสัมพันธ์ระหว่างมิติหลักทั้ง 5 เพื่อดูทิศทางและขนาดของค่าสัมประสิทธิ์ r ว่าคู่มิติใดสัมพันธ์เชิงบวกหรือลบ</span>
        </p>
        <div class="metric" id="diagnosticSummary" style="background: rgba(43, 177, 168, 0.12);"></div>
        <div class="matrix-wrapper">
          <table class="matrix-table" id="satisfactionCorrelationMatrix"></table>
        </div>
        <div class="matrix-legend">
          <span class="legend-item"><span class="legend-swatch" style="background: rgba(43, 177, 168, 0.45);"></span>สัมพันธ์เชิงบวก</span>
          <span class="legend-item"><span class="legend-swatch" style="background: rgba(255, 138, 91, 0.45);"></span>สัมพันธ์เชิงลบ</span>
        </div>
        <div class="alert-list" id="diagnosticInsights"></div>
      </div>
    </section>

    <section id="focus" class="panel">
      <div class="card">
        <h2>แดชบอร์ดโฟกัสสำหรับผู้บริหาร</h2>
        <p class="hint description-toggle">
          <span class="description-text description-easy">เลือกหน่วยงานเพื่อดูสรุปคะแนนสำคัญและสัญญาณเตือน</span>
          <span class="description-text description-advanced">เลือกหน่วยงานเพื่อเรียกดูสถิติค่าร้อยละของ Happinometer, Engagement และ Job Satisfaction พร้อมสัญญาณเตือนที่วิเคราะห์จากเกณฑ์ตัดเชิงสถิติ</span>
        </p>
        <select class="unit-select" id="unitSelect"></select>
        <div class="unit-details" id="unitDetails">
          <div class="detail-row">
            <span>ความสุขรวม (Happinometer)</span>
            <strong id="happyScore">90.0%</strong>
          </div>
          <div class="detail-row">
            <span>ความผูกพัน (Employee Engagement)</span>
            <strong id="engagementScore">73.33%</strong>
          </div>
          <div class="detail-row">
            <span>ความพึงพอใจงาน (ภาพรวม)</span>
            <strong id="jobScore">ไม่มีข้อมูล</strong>
          </div>
          <div>
            <div class="tag">สัญญาณที่ควรจับตา</div>
            <div class="alert-list" id="alertList">
              <div class="alert-item">ข้อมูลครบถ้วนและอยู่ในระดับแข็งแรง</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Heatmap คะแนนความพึงพอใจรายมิติ</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">
            เปรียบเทียบจุดแข็งและช่องว่างของแต่ละหน่วยผ่านสีเข้ม-อ่อน ยิ่งสีเขียวเข้มหมายถึงคะแนนสูงเมื่อเทียบกับหน่วยอื่น
          </span>
          <span class="description-text description-advanced">
            ใช้แผนภูมิความร้อน (heatmap) เพื่อแสดงค่าร้อยละของแต่ละมิติ โดยโทนสีเข้ม-อ่อนสะท้อนค่ามาตรฐาน (standardized score) ช่วยให้ระบุหน่วยที่อยู่เหนือหรือใต้ค่าเฉลี่ยได้รวดเร็ว
          </span>
        </p>
        <div class="heatmap-wrapper">
          <table class="heatmap-table" id="satisfactionHeatmap"></table>
        </div>
      </div>

      <div class="card">
        <h3>Radar Profiles หน่วยงาน</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">
            เจาะลึกโปรไฟล์ความสุข 11 มิติและความพึงพอใจ 5 มิติของแต่ละหน่วย เพื่อเห็นสมดุลประสบการณ์ในมุมมอง 360 องศา
          </span>
          <span class="description-text description-advanced">
            แผนภูมิเรดาร์แสดงค่าร้อยละของ 11 มิติความสุขและ 5 มิติความพึงพอใจเพื่อวิเคราะห์สมดุลเชิงเวกเตอร์ (vector profile) ของแต่ละหน่วย ช่วยมองเห็นความแตกต่างของรูปทรงคะแนน
          </span>
        </p>
        <div class="radar-controls">
          <span class="metric-title">เลือกหน่วยงาน</span>
          <select id="radarUnitSelect" class="radar-select"></select>
        </div>
        <div class="radar-grid">
          <div class="radar-chart">
            <h4>Happinometer 11 มิติ</h4>
            <canvas id="happinessRadar" width="420" height="320"></canvas>
          </div>
          <div class="radar-chart">
            <h4>Job Satisfaction 5 มิติ</h4>
            <canvas id="satisfactionRadar" width="420" height="320"></canvas>
          </div>
        </div>
        <div class="radar-note" id="radarNote"></div>
      </div>

      <div class="card">
        <h3>ประเด็นยุทธศาสตร์ที่ควรขับเคลื่อน</h3>
        <div class="insight-grid">
          <div class="metric">
            <span class="metric-title">1. เสริมสุขภาพกายใจในหน่วยวิกฤต</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">PICU, 20B และ 19C มีมิติ Relax &amp; Happy Plus ต่ำกว่า 55% แนะนำจัดโครงการพี่เลี้ยงและเวลาพักเชิงรุก</span>
              <span class="description-text description-advanced">PICU, 20B และ 19C มีคะแนน Relax &amp; Happy Plus ต่ำกว่า 55% ซึ่งอยู่ต่ำกว่าเกณฑ์ 2 ส่วนเบี่ยงเบนมาตรฐานจากค่ากลาง สะท้อนความเครียดสะสมที่ต้องใช้มาตรการเชิงป้องกันตามหลักสถิติการเฝ้าระวัง</span>
            </p>
          </div>
          <div class="metric">
            <span class="metric-title">2. จัดการภาระงานและทรัพยากร</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">SICU และ ER มีคะแนนลักษณะงานและค่าตอบแทนระดับปานกลาง ต้องพิจารณาปรับสัดส่วนเวรและเครื่องมือสนับสนุน</span>
              <span class="description-text description-advanced">คะแนนลักษณะงานของ SICU และค่าตอบแทนของ ER อยู่ในควอไทล์ที่ 2 โดยค่าเฉลี่ยประมาณ 67-69% ต่ำกว่าค่ามัธยฐาน 70% แสดงถึงความจำเป็นในการปรับโครงสร้างเวรตามหลักสมดุลภาระ (workload balance)</span>
            </p>
          </div>
          <div class="metric">
            <span class="metric-title">3. ต่อยอดทีมต้นแบบ</span>
            <p class="metric-desc description-toggle"> 
              <span class="description-text description-easy">นำแนวทางจาก OPD2, CSSD และสำนักงาน (คะแนน ≥ 83%) มาใช้เป็นโครงการ Coach the Coach สร้างมาตรฐานการดูแลบุคลากร</span>
              <span class="description-text description-advanced">คะแนนของ OPD2, CSSD และสำนักงาน ≥ 83% อยู่ในกลุ่มค่าเฉลี่ยสูงสุด (upper decile) จึงเหมาะต่อการใช้เป็นค่ามาตรฐานอ้างอิง (benchmark) ในการออกแบบโครงการ Coach the Coach เพื่อยกระดับสถิติทั้งองค์กร</span>
            </p>
          </div>
        </div>
      </div>
    </section>

    <section id="attrition" class="panel">
      <div class="card">
        <h2>ภาพรวมการลาออกของบุคลากร (รวม 53 คน)</h2>
        <div class="attrition-grid">
          <div class="attrition-card">
            <h4>หน่วยที่มีการลาออกสูงสุด</h4>
            <div class="figure">OR 6 คน</div>
            <p class="hint description-toggle">
              <span class="description-text description-easy">ประกอบด้วย N 4 คน และ PN 2 คน จำเป็นต้องทบทวนแผนเวรและสวัสดิการเฉพาะ</span>
              <span class="description-text description-advanced">ประกอบด้วย N 4 คน และ PN 2 คน คิดเป็นร้อยละ 11 ของกำลังคน OR ทำให้ค่าเฉลี่ยลาออกต่อเดือนสูงกว่ากลุ่มอื่น 1.5 เท่า ต้องจัดสวัสดิการเชิงเฉพาะกลุ่ม</span>
            </p>
          </div>
          <div class="attrition-card">
            <h4>หน่วยเสี่ยงระดับกลาง</h4>
            <div class="figure">MICU / DR / บางพระ 3 คน</div>
            <p class="hint description-toggle">
              <span class="description-text description-easy">MICU สูญเสีย N 2 คน PN 1 คน สัมพันธ์กับคะแนน Relax 52.79% และ Stay 60%</span>
              <span class="description-text description-advanced">MICU สูญเสีย N 2 คน และ PN 1 คน หรือร้อยละ 9 ของกำลังคน โดยมีคะแนน Relax 52.79% และ Stay 60% ต่ำกว่าเกณฑ์ 0.6 ส่วนเบี่ยงเบนมาตรฐาน แสดงความสัมพันธ์เชิงสถิติกับการลาออก</span>
            </p>
          </div>
          <div class="attrition-card">
            <h4>กระจายหลายหน่วยงาน</h4>
            <div class="figure">18D, Refer, 23A, 22A ฯลฯ</div>
            <p class="hint description-toggle">
              <span class="description-text description-easy">แต่ละหน่วยออก 2-3 คน ควรเชื่อมโยงข้อมูลลาออกกับคะแนนค่าตอบแทนและ Engagement เพื่อจัดแผนรักษาคน</span>
              <span class="description-text description-advanced">แต่ละหน่วยออก 2-3 คน (คิดเป็นร้อยละ 6-10) จำเป็นต้องวิเคราะห์ถดถอยเชิงพหุ (multiple regression) ระหว่างคะแนนค่าตอบแทนและ Engagement กับสถิติลาการออกเพื่อออกแบบแผนรักษาคน</span>
            </p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Comparative Analysis: High vs. Low Performing Units</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">เปรียบเทียบ Top 5 และ Bottom 5 หน่วยงานจากคะแนนความผูกพัน ความพึงพอใจ และความสุขรวม เพื่อระบุช่องว่างของประสบการณ์พนักงาน</span>
          <span class="description-text description-advanced">เปรียบเทียบค่าเฉลี่ยของกลุ่ม Top 5 และ Bottom 5 ในสามเมตริก (ความผูกพัน ความพึงพอใจ ความสุข) เพื่อวิเคราะห์ช่องว่างเชิงสถิติและค่าความต่างเฉลี่ย (mean difference)</span>
        </p>
        <div class="metric" id="topBottomSummary" style="background: rgba(43, 177, 168, 0.12);"></div>
        <div class="insight-grid">
          <div class="metric" id="commitmentComparative"></div>
          <div class="metric" id="satisfactionComparative"></div>
          <div class="metric" id="happinessComparative"></div>
        </div>
        <div class="alert-list" id="topBottomHighlights"></div>
      </div>

      <div class="card">
        <h3>Satisfaction vs. Resignation Rate</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">วิเคราะห์ว่าหน่วยที่มีคะแนนความพึงพอใจต่ำกว่า 70% มีแนวโน้มลาออกสูงกว่าหรือไม่ โดยใช้ข้อมูล 7 หน่วยที่มีสถิติลาออกชัดเจน</span>
          <span class="description-text description-advanced">ใช้การแบ่งกลุ่มตามเกณฑ์คะแนนความพึงพอใจ 70% เพื่อตรวจสอบความแตกต่างของค่าเฉลี่ยจำนวนลาออกต่อหน่วย (mean resignations) และค่าสัดส่วน (proportion) ของการลาออก</span>
        </p>
        <div class="metric" id="satisfactionResignationSummary" style="background: rgba(255, 205, 75, 0.16);"></div>
        <div class="table-wrapper">
          <table class="commitment-table">
            <thead>
              <tr>
                <th>หน่วยงาน</th>
                <th>ความพึงพอใจ</th>
                <th>จำนวนลาออก</th>
              </tr>
            </thead>
            <tbody id="satisfactionResignationTable"></tbody>
          </table>
        </div>
        <div class="alert-list" id="satisfactionResignationInsights"></div>
      </div>

      <div class="card">
        <h3>Commitment vs. Happiness Correlation</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">เชื่อมโยงข้อมูล 13 หน่วยงานที่มีข้อมูลครบทั้งสามมิติ เพื่อตอบว่าเมื่อความสุขสูงขึ้น คะแนนความผูกพันสูงขึ้นด้วยหรือไม่</span>
          <span class="description-text description-advanced">ใช้การวิเคราะห์สหสัมพันธ์เพียร์สันระหว่างความสุขและความผูกพันของ 13 หน่วยงาน เพื่อดูค่าระดับความสัมพันธ์ (r) และนัยสำคัญทางสถิติระหว่างตัวแปร</span>
        </p>
        <div class="metric" id="commitmentHappinessSummary" style="background: rgba(44, 61, 122, 0.08);"></div>
        <div class="alert-list" id="commitmentHappinessInsights"></div>
      </div>

      <div class="card">
        <h3>Trend Simulation 2569</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">แบบจำลองคาดการณ์ลาออกในอีก 6-12 เดือน โดยอ้างอิงจำนวนลาออกปัจจุบัน คะแนนความผูกพัน และตัวชี้วัดความพึงพอใจ</span>
          <span class="description-text description-advanced">ใช้แบบจำลองการพยากรณ์เชิงปริมาณที่ผสานตัวแปรจำนวนลาออก (baseline), คะแนนความผูกพัน และความพึงพอใจ เพื่อประเมินแนวโน้มใน 6-12 เดือนตามหลักการประมาณค่า (forecasting)</span>
        </p>
        <div class="forecast-grid" id="forecastGrid"></div>
        <div class="alert-list" id="forecastInsights"></div>
      </div>

      <div class="card">
        <h3>ข้อเสนอแนะการจัดการกำลังคน</h3>
        <div class="insight-grid">
          <div class="metric">
            <span class="metric-title">พยาบาลวิกฤต</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">OR และ MICU ควรรวมทีมผู้เชี่ยวชาญเพื่อทบทวนระบบพี่เลี้ยงและค่าตอบแทนเสี่ยงภัยเชื่อมกับคะแนน Happinometer</span>
              <span class="description-text description-advanced">OR และ MICU มีการลาออกรวม 9 คน พร้อมคะแนนผูกพันต่ำกว่า 65% และดัชนี Happinometer ต่ำกว่า 65% ทำให้ค่าเฉลี่ยถ่วงน้ำหนักของความเสี่ยงเพิ่มขึ้น จึงควรใช้การวิเคราะห์ปัจจัยร่วม (multivariate) เพื่อกำหนดมาตรการพี่เลี้ยงและค่าตอบแทนเสี่ยงภัย</span>
            </p>
          </div>
          <div class="metric">
            <span class="metric-title">หน่วยบริการนอกเวลา</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">บางพระและ Refer มีการลาออก 3 และ 2 คนตามลำดับ ต้องตรวจสอบภาระงานนอกเวลารวมถึงแรงจูงใจเพิ่มเติม</span>
              <span class="description-text description-advanced">บางพระลาออก 3 คน และ Refer 2 คน ซึ่งคิดเป็นอัตราส่วนลาออก 12% และ 8% ของกำลังคนหน่วยย่อย สะท้อนความสัมพันธ์กับคะแนนภาระงานหลังเวลาปฏิบัติการ ต้องตรวจสอบแรงจูงใจตามหลักการวิเคราะห์อัตราส่วน (ratio analysis)</span>
            </p>
          </div>
          <div class="metric">
            <span class="metric-title">การสื่อสารกับบุคลากรใหม่</span>
            <p class="metric-desc description-toggle">
              <span class="description-text description-easy">เชื่อมข้อมูลลาออกของ PN และ NA รวม 22 คน กับโครงการ Onboarding เพื่อเสริมความผูกพันตั้งแต่ 90 วันแรก</span>
              <span class="description-text description-advanced">ข้อมูลลาออกของ PN และ NA รวม 22 คน หรือร้อยละ 41 ของการลาออกทั้งหมด ควรใช้เป็นตัวแปรตามในโครงการ Onboarding และวิเคราะห์แนวโน้มภายในช่วง 90 วันด้วยสถิติเชิงรอดชีพ (survival analysis)</span>
            </p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Commitment vs. Resignation Analysis</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">เชื่อมโยงคะแนนความผูกพันกับจำนวนการลาออกเพื่อดูว่าหน่วยที่มีผูกพันต่ำมีการสูญเสียกำลังคนสูงเพียงใด</span>
          <span class="description-text description-advanced">คำนวณสัดส่วนการลาออกตามระดับคะแนนความผูกพัน เพื่อประเมินความสัมพันธ์เชิงฟังก์ชัน (functional relationship) ระหว่างคะแนนและการสูญเสียกำลังคน</span>
        </p>
        <div class="commitment-insight" id="commitmentSummary"></div>
        <div class="table-wrapper">
          <table class="commitment-table">
            <thead>
              <tr>
                <th>หน่วยงาน</th>
                <th>ความผูกพัน (Commitment)</th>
                <th>จำนวนลาออก 2568</th>
              </tr>
            </thead>
            <tbody id="commitmentTable"></tbody>
          </table>
        </div>
        <div class="alert-list" id="commitmentInsights"></div>
      </div>

      <div class="card">
        <h3>Regression: ตัวแปรที่คาดการณ์การลาออก</h3>
        <p class="hint description-toggle">
          <span class="description-text description-easy">วิเคราะห์ถดถอยเชิงเส้นจากคะแนนความพึงพอใจ ความสุข และความผูกพันของ 7 หน่วยงาน เพื่อเทียบอิทธิพลต่อจำนวนลาออก (β &gt; 0 หมายถึงคะแนนสูงขึ้นสัมพันธ์กับลาออกเพิ่มขึ้น)</span>
          <span class="description-text description-advanced">ใช้แบบจำลองถดถอยเชิงเส้นพหุ (multiple linear regression) กับข้อมูล 7 หน่วย เพื่อประเมินค่าสัมประสิทธิ์ถดถอย (β) ของคะแนนความพึงพอใจ ความสุข และความผูกพันต่อจำนวนลาออก</span>
        </p>
        <div class="commitment-insight" id="regressionSummary"></div>
        <div class="table-wrapper">
          <table class="commitment-table regression-table">
            <thead>
              <tr>
                <th>ปัจจัย</th>
                <th>สัมประสิทธิ์ (β)</th>
                <th>คำอธิบาย</th>
              </tr>
            </thead>
            <tbody id="regressionTableBody"></tbody>
          </table>
        </div>
        <div class="alert-list" id="regressionInsights"></div>
      </div>
    </section>

    <footer>ที่มา: รายงาน Happinometer, การผูกพัน และ Job Satisfaction ฝ่ายการพยาบาล ปี 2568</footer>
  </main>

  <script>
    function setupDescriptionToggle(element) {
      if (!element || element.dataset.toggleBound === 'true') {
        return;
      }
      const easy = element.querySelector('.description-text.description-easy');
      const advanced = element.querySelector('.description-text.description-advanced');
      if (!easy || !advanced) {
        return;
      }
      element.dataset.state = element.dataset.state || 'easy';
      easy.hidden = false;
      advanced.hidden = true;

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'description-toggle-button';
      button.textContent = 'มุมมองเชิงสถิติ';
      button.setAttribute('aria-pressed', 'false');

      button.addEventListener('click', () => {
        const isAdvanced = element.dataset.state === 'advanced';
        const nextState = isAdvanced ? 'easy' : 'advanced';
        element.dataset.state = nextState;
        const advancedActive = nextState === 'advanced';
        easy.hidden = advancedActive;
        advanced.hidden = !advancedActive;
        button.textContent = advancedActive ? 'กลับสู่สรุปเข้าใจง่าย' : 'มุมมองเชิงสถิติ';
        button.setAttribute('aria-pressed', String(advancedActive));
      });

      element.appendChild(button);
      element.dataset.toggleBound = 'true';
    }

    function activateDescriptionToggles(root = document) {
      root.querySelectorAll('.description-toggle').forEach(setupDescriptionToggle);
    }

    function createDescriptionMarkup(easy, advanced, options = {}) {
      const tag = options.tag || 'p';
      const classes = options.classes ? ([]).concat(options.classes) : [];
      const className = [...classes, 'description-toggle'].join(' ').trim();
      return `
        <${tag} class="${className}">
          <span class="description-text description-easy">${easy}</span>
          <span class="description-text description-advanced">${advanced}</span>
        </${tag}>
      `;
    }

    function applyDescriptionContent(element, easy, advanced) {
      if (!element) {
        return;
      }
      element.innerHTML = `
        <span class="description-text description-easy">${easy}</span>
        <span class="description-text description-advanced">${advanced}</span>
      `;
      element.classList.add('description-toggle');
      delete element.dataset.toggleBound;
      element.dataset.state = 'easy';
      setupDescriptionToggle(element);
    }

    const happinessProfiles = [
      {
        unit: 'หอพัก',
        dimensions: {
          Body: 88,
          Brain: 85,
          Heart: 90,
          Soul: 87,
          Family: 89,
          Support: 88,
          Finance: 82,
          Growth: 81,
          Environment: 90,
          Relax: 86,
          HappyPlus: 90
        }
      },
      {
        unit: 'OPD2',
        dimensions: {
          Body: 84,
          Brain: 82,
          Heart: 86,
          Soul: 83,
          Family: 85,
          Support: 84,
          Finance: 83,
          Growth: 80,
          Environment: 85,
          Relax: 78,
          HappyPlus: 85
        }
      },
      {
        unit: 'CSSD',
        dimensions: {
          Body: 82,
          Brain: 80,
          Heart: 84,
          Soul: 81,
          Family: 83,
          Support: 86,
          Finance: 82,
          Growth: 78,
          Environment: 84,
          Relax: 76,
          HappyPlus: 82
        }
      },
      {
        unit: 'OPD3',
        dimensions: {
          Body: 78,
          Brain: 77,
          Heart: 80,
          Soul: 78,
          Family: 79,
          Support: 80,
          Finance: 79,
          Growth: 76,
          Environment: 82,
          Relax: 74,
          HappyPlus: 79
        }
      },
      {
        unit: 'ปฐมภูมิ',
        dimensions: {
          Body: 81,
          Brain: 79,
          Heart: 83,
          Soul: 80,
          Family: 82,
          Support: 82,
          Finance: 78,
          Growth: 82,
          Environment: 83,
          Relax: 75,
          HappyPlus: 84
        }
      },
      {
        unit: 'ผู้บริหาร',
        dimensions: {
          Body: 76,
          Brain: 78,
          Heart: 82,
          Soul: 79,
          Family: 80,
          Support: 83,
          Finance: 77,
          Growth: 81,
          Environment: 80,
          Relax: 72,
          HappyPlus: 80
        }
      },
      {
        unit: 'งานระบาด',
        dimensions: {
          Body: 85,
          Brain: 88,
          Heart: 87,
          Soul: 86,
          Family: 84,
          Support: 86,
          Finance: 82,
          Growth: 84,
          Environment: 88,
          Relax: 80,
          HappyPlus: 88
        }
      },
      {
        unit: 'PICU',
        dimensions: {
          Body: 66,
          Brain: 72,
          Heart: 70,
          Soul: 68,
          Family: 65,
          Support: 75,
          Finance: 74,
          Growth: 69,
          Environment: 93,
          Relax: 53,
          HappyPlus: 48
        }
      },
      {
        unit: '20B',
        dimensions: {
          Body: 62,
          Brain: 68,
          Heart: 66,
          Soul: 64,
          Family: 63,
          Support: 70,
          Finance: 69,
          Growth: 66,
          Environment: 72,
          Relax: 49,
          HappyPlus: 55
        }
      },
      {
        unit: '19C',
        dimensions: {
          Body: 64,
          Brain: 69,
          Heart: 67,
          Soul: 65,
          Family: 64,
          Support: 71,
          Finance: 68,
          Growth: 65,
          Environment: 74,
          Relax: 51,
          HappyPlus: 57
        }
      },
      {
        unit: '22A & Stroke',
        dimensions: {
          Body: 66,
          Brain: 70,
          Heart: 68,
          Soul: 66,
          Family: 65,
          Support: 72,
          Finance: 67,
          Growth: 68,
          Environment: 76,
          Relax: 55,
          HappyPlus: 56
        }
      },
      {
        unit: 'ER',
        dimensions: {
          Body: 64,
          Brain: 71,
          Heart: 69,
          Soul: 66,
          Family: 68,
          Support: 73,
          Finance: 68,
          Growth: 67,
          Environment: 75,
          Relax: 58,
          HappyPlus: 60
        }
      },
      {
        unit: 'SICU',
        dimensions: {
          Body: 63,
          Brain: 70,
          Heart: 68,
          Soul: 65,
          Family: 64,
          Support: 72,
          Finance: 66,
          Growth: 67,
          Environment: 74,
          Relax: 57,
          HappyPlus: 59
        }
      },
      {
        unit: 'ไตเทียม',
        dimensions: {
          Body: 70,
          Brain: 72,
          Heart: 73,
          Soul: 71,
          Family: 70,
          Support: 68,
          Finance: 67,
          Growth: 69,
          Environment: 78,
          Relax: 60,
          HappyPlus: 62
        }
      }
    ];

    const dimensionLabels = {
      Body: 'Body (สุขภาพกาย)',
      Brain: 'Brain (การเรียนรู้)',
      Heart: 'Heart (ความสัมพันธ์)',
      Soul: 'Soul (คุณค่าภายใน)',
      Family: 'Family (เครือข่ายหนุนเสริม)',
      Support: 'การนำและระบบสนับสนุน',
      Finance: 'ค่าตอบแทนและสวัสดิการ',
      Growth: 'โอกาสเติบโตในงาน',
      Environment: 'สิ่งแวดล้อมการทำงาน',
      Relax: 'Relax (Work-Life Balance)',
      HappyPlus: 'Happy Plus (ความสุขเชิงบวก)'
    };

    const dimensionKeys = Object.keys(happinessProfiles[0].dimensions);

    const clusterSummaryElement = document.getElementById('clusterSummary');
    const clusterGridElement = document.getElementById('clusterGrid');

    if (clusterSummaryElement && clusterGridElement) {
      const seeds = ['หอพัก', 'ER', 'PICU'];
      const clusterResult = analyzeHappinessClusters(happinessProfiles, dimensionKeys, seeds);
      applyDescriptionContent(clusterSummaryElement, clusterResult.summaryEasy, clusterResult.summaryAdvanced);
      renderClusterCards(clusterGridElement, clusterResult.details);
    }

    function analyzeHappinessClusters(profiles, keys, seeds) {
      const k = 3;
      const { clusters } = kMeansProfiles(profiles, keys, k, seeds);
      const populatedClusters = clusters.filter(cluster => cluster.length);

      const details = populatedClusters.map((members, index) => {
        const averages = keys.reduce((acc, key) => {
          const total = members.reduce((sum, profile) => sum + profile.dimensions[key], 0);
          acc[key] = total / members.length;
          return acc;
        }, {});

        const overall = keys.reduce((sum, key) => sum + averages[key], 0) / keys.length;
        const classification = classifyCluster(overall, averages);

        const strengths = keys
          .slice()
          .sort((a, b) => averages[b] - averages[a])
          .slice(0, 2)
          .map(key => `${dimensionLabels[key]} ${formatPercentage(averages[key])}`);

        const watch = keys
          .slice()
          .sort((a, b) => averages[a] - averages[b])
          .slice(0, 2)
          .map(key => `${dimensionLabels[key]} ${formatPercentage(averages[key])}`);

        return {
          id: index + 1,
          members: members.map(member => member.unit),
          overall: formatPercentage(overall),
          overallValue: overall,
          classification,
          strengths,
          watch
        };
      });

      const summaryParts = details.map(detail => `${detail.classification.label} (${detail.members.length} หน่วย, เฉลี่ย ${detail.overall})`);
      const summaryText = `วิเคราะห์โปรไฟล์ความสุขของ ${profiles.length} หน่วยงาน พบ ${details.length} คลัสเตอร์หลัก: ${summaryParts.join(' • ')}.`;
      const advancedSegments = details.map(detail => `${detail.classification.label}: μ = ${detail.overallValue.toFixed(1)}% (${detail.members.length} หน่วย)`);
      const advancedSummary = `ผลการจัดกลุ่ม k-means (${details.length} คลัสเตอร์) ให้ค่าเฉลี่ยความสุข (μ) ของแต่ละคลัสเตอร์ดังนี้ ${advancedSegments.join(' • ')} ครอบคลุมหน่วยทั้งหมด ${profiles.length} หน่วย`;

      return {
        summaryEasy: summaryText,
        summaryAdvanced: advancedSummary,
        details
      };
    }

    function kMeansProfiles(profiles, keys, k, seeds, maxIterations = 30) {
      const fallbackProfiles = profiles.filter(profile => !seeds.includes(profile.unit));
      const seedCentroids = seeds
        .map(seed => profiles.find(profile => profile.unit === seed))
        .filter(Boolean)
        .map(profile => keys.map(key => profile.dimensions[key]));

      let centroids = seedCentroids.slice(0, k);
      let fallbackIndex = 0;
      while (centroids.length < k && fallbackIndex < fallbackProfiles.length) {
        centroids.push(keys.map(key => fallbackProfiles[fallbackIndex].dimensions[key]));
        fallbackIndex += 1;
      }

      if (!centroids.length) {
        centroids = profiles.slice(0, k).map(profile => keys.map(key => profile.dimensions[key]));
      }

      let clusters = [];

      for (let iteration = 0; iteration < maxIterations; iteration += 1) {
        clusters = Array.from({ length: centroids.length }, () => []);

        profiles.forEach(profile => {
          const vector = keys.map(key => profile.dimensions[key]);
          let bestIndex = 0;
          let bestDistance = Infinity;

          centroids.forEach((centroid, index) => {
            const distance = euclideanDistance(vector, centroid);
            if (distance < bestDistance) {
              bestDistance = distance;
              bestIndex = index;
            }
          });

          clusters[bestIndex].push(profile);
        });

        const newCentroids = centroids.map((centroid, index) => {
          const members = clusters[index];
          if (!members.length) {
            return centroid;
          }
          const sums = new Array(keys.length).fill(0);
          members.forEach(member => {
            keys.forEach((key, keyIndex) => {
              sums[keyIndex] += member.dimensions[key];
            });
          });
          return sums.map(sum => sum / members.length);
        });

        const hasShift = centroids.some((centroid, index) =>
          centroid.some((value, dimIndex) => Math.abs(value - newCentroids[index][dimIndex]) > 0.1)
        );

        centroids = newCentroids;

        if (!hasShift) {
          break;
        }
      }

      clusters = clusters.filter(cluster => cluster.length);

      return { clusters, centroids };
    }

    function euclideanDistance(a, b) {
      return Math.sqrt(a.reduce((sum, value, index) => sum + Math.pow(value - b[index], 2), 0));
    }

    function classifyCluster(overall, averages) {
      if (overall >= 80 && averages.Relax >= 75 && averages.HappyPlus >= 80) {
        return {
          label: 'สมดุลสูงเป็นต้นแบบ',
          description:
            'คะแนนทุกมิติเฉลี่ยมากกว่า 80% โดยเฉพาะการผ่อนคลายและความสุขเชิงบวก เหมาะขยายผลเป็นทีมต้นแบบและโค้ชหน่วยอื่น',
          tone: 'positive'
        };
      }

      if (averages.Relax < 60 || averages.Body < 65) {
        return {
          label: 'ภาระงานตึง ต้องเร่งพยุง',
          description:
            'คะแนนด้านพลังงานกายและเวลาพักต่ำกว่ามาตรฐาน สะท้อนความล้าและความเสี่ยงผูกพัน จำเป็นต้องจัดการเวรและเพิ่มระบบสนับสนุนทันที',
          tone: 'warning'
        };
      }

      return {
        label: 'กลุ่มกำลังเสริมสมดุล',
        description:
          'คะแนนรวมระดับกลาง แข็งแรงด้านการสนับสนุนและสิ่งแวดล้อม แต่ยังต้องต่อยอดมิติความผ่อนคลายและแรงจูงใจเชิงบวก',
        tone: 'neutral'
      };
    }

    function formatPercentage(value) {
      return `${Math.round(value)}%`;
    }

    function parsePercentageValue(value) {
      if (typeof value === 'number') {
        return value;
      }
      if (value === null || value === undefined) {
        return null;
      }
      const normalized = value.toString().replace(',', '.');
      const match = normalized.match(/-?\d+(?:\.\d+)?/);
      return match ? parseFloat(match[0]) : null;
    }

    function calculateAverage(items, key) {
      if (!items.length) {
        return 0;
      }
      const total = items.reduce((sum, item) => sum + (key ? item[key] : item), 0);
      return total / items.length;
    }

    function calculatePearson(data, xKey, yKey) {
      const n = data.length;
      if (n < 2) {
        return 0;
      }
      let sumX = 0;
      let sumY = 0;
      let sumXY = 0;
      let sumX2 = 0;
      let sumY2 = 0;

      data.forEach(item => {
        const x = item[xKey];
        const y = item[yKey];
        sumX += x;
        sumY += y;
        sumXY += x * y;
        sumX2 += x * x;
        sumY2 += y * y;
      });

      const numerator = n * sumXY - sumX * sumY;
      const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
      if (!denominator) {
        return 0;
      }
      return numerator / denominator;
    }

    function buildTopBottomComparison(units, metricKey, groupSize = 5) {
      const validUnits = units.filter(item => Number.isFinite(item[metricKey]));
      if (!validUnits.length) {
        return null;
      }
      const sorted = validUnits.slice().sort((a, b) => b[metricKey] - a[metricKey]);
      const size = Math.min(groupSize, sorted.length);
      const topGroup = sorted.slice(0, size);
      const bottomGroup = sorted.slice(-size).reverse();
      const topAvg = calculateAverage(topGroup, metricKey);
      const bottomAvg = calculateAverage(bottomGroup, metricKey);
      return { size, topGroup, bottomGroup, topAvg, bottomAvg, diff: topAvg - bottomAvg };
    }

    function renderClusterCards(container, details) {
      container.innerHTML = '';
      details.forEach(detail => {
        const card = document.createElement('div');
        card.className = `cluster-card ${detail.classification.tone}`;
        card.innerHTML = `
          <div class="cluster-header">
            <div>
              <span class="cluster-id">Cluster ${detail.id}</span>
              <h4>${detail.classification.label}</h4>
            </div>
            <span class="cluster-score">เฉลี่ย ${detail.overall}</span>
          </div>
          <p class="cluster-desc">${detail.classification.description}</p>
          <div class="cluster-members">
            ${detail.members.map(member => `<span class="cluster-chip">${member}</span>`).join('')}
          </div>
          <div class="cluster-metrics">
            <div>
              <span class="cluster-subtitle">จุดแข็ง</span>
              ${detail.strengths.map(text => `<div class="cluster-tag">${text}</div>`).join('')}
            </div>
            <div>
              <span class="cluster-subtitle">เฝ้าระวัง</span>
              ${detail.watch.map(text => `<div class="cluster-tag warning">${text}</div>`).join('')}
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderSatisfactionHeatmap(table, data, keys) {
      table.innerHTML = '';

      const headerRow = document.createElement('tr');
      const corner = document.createElement('th');
      corner.textContent = 'หน่วยงาน';
      headerRow.appendChild(corner);

      keys.forEach(key => {
        const th = document.createElement('th');
        th.textContent = satisfactionDimensionLabels[key];
        headerRow.appendChild(th);
      });

      table.appendChild(headerRow);

      const values = data.flatMap(item => keys.map(key => item[key]));
      const minValue = Math.min(...values);
      const maxValue = Math.max(...values);

      data.forEach(item => {
        const row = document.createElement('tr');
        const labelCell = document.createElement('th');
        labelCell.textContent = item.unit;
        row.appendChild(labelCell);

        keys.forEach(key => {
          const td = document.createElement('td');
          const wrapper = document.createElement('div');
          wrapper.className = 'heatmap-cell';
          const value = item[key];
          const color = interpolateHeatmapColor(value, minValue, maxValue);
          wrapper.style.backgroundColor = color.background;
          wrapper.style.color = color.text;
          wrapper.textContent = `${Math.round(value)}%`;
          wrapper.title = `${item.unit} • ${satisfactionDimensionLabels[key]}: ${value.toFixed(1)}%`;
          td.appendChild(wrapper);
          row.appendChild(td);
        });

        table.appendChild(row);
      });
    }

    function interpolateHeatmapColor(value, min, max) {
      const safeMin = Number.isFinite(min) ? min : 0;
      const safeMax = Number.isFinite(max) ? max : 100;
      const denominator = safeMax - safeMin || 1;
      const ratio = Math.min(Math.max((value - safeMin) / denominator, 0), 1);

      const rgb = heatmapLowColor.map((start, index) => {
        const end = heatmapHighColor[index];
        return Math.round(start + (end - start) * ratio);
      });

      const background = `rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 0.85)`;
      const brightness = 0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2];
      const text = brightness > 165 ? '#1f2a44' : '#ffffff';

      return { background, text };
    }

    function updateRadarCharts(selectedUnit) {
      if (!happinessRadarChart || !satisfactionRadarChart) {
        return;
      }

      const happinessProfile = happinessProfiles.find(profile => profile.unit === selectedUnit);
      const satisfactionProfile = satisfactionDimensionData.find(item => item.unit === selectedUnit);

      const happinessData = happinessProfile
        ? dimensionKeys.map(key => happinessProfile.dimensions[key])
        : dimensionKeys.map(() => Number.NaN);

      const satisfactionData = satisfactionProfile
        ? satisfactionDimensionKeys.map(key => satisfactionProfile[key])
        : satisfactionDimensionKeys.map(() => Number.NaN);

      happinessRadarChart.data.datasets[0].data = happinessData;
      satisfactionRadarChart.data.datasets[0].data = satisfactionData;

      happinessRadarChart.update();
      satisfactionRadarChart.update();

      if (radarNoteElement) {
        const notes = [];
        if (happinessProfile) {
          notes.push('มีข้อมูล Happinometer ครบทุกมิติ');
        } else {
          notes.push('ยังไม่มีข้อมูล Happinometer สำหรับหน่วยนี้');
        }

        if (satisfactionProfile) {
          notes.push('มีข้อมูลความพึงพอใจ 5 มิติพร้อมเปรียบเทียบ');
        } else {
          notes.push('ยังไม่มีข้อมูลความพึงพอใจในชุดข้อมูลนี้');
        }

        const easyRadarNote = `${selectedUnit}: ${notes.join(' • ')}`;
        const advancedRadarNote = `${selectedUnit}: ${happinessProfile ? 'ครอบคลุมข้อมูล Happinometer 11 มิติเต็ม (coverage 100%)' : 'ข้อมูล Happinometer ขาดหาย ต้องทำเครื่องหมายเป็น missing data'} • ${satisfactionProfile ? 'มีข้อมูลความพึงพอใจ 5 มิติครบ (coverage 100%)' : 'ไม่มีข้อมูลความพึงพอใจ ต้องจัดการข้อมูลสูญหาย'}`;
        applyDescriptionContent(radarNoteElement, easyRadarNote, advancedRadarNote);
      }
    }

    function formatPersonaMetric(value) {
      if (!Number.isFinite(value)) {
        return '-';
      }
      const rounded = Math.round(value * 10) / 10;
      return `${rounded.toFixed(1)}%`;
    }

    function analyzeEngagementPersonas(unitMap) {
      const units = Object.entries(unitMap)
        .map(([unit, data]) => ({
          unit,
          happiness: parsePercentageValue(data.happy),
          engagement: parsePercentageValue(data.engagement)
        }))
        .filter(item => Number.isFinite(item.happiness) && Number.isFinite(item.engagement));

      if (!units.length) {
        return { summary: 'ยังไม่มีข้อมูลเพียงพอสำหรับจำแนก persona', details: [] };
      }

      const personaDefinitions = [
        {
          id: 'thriving',
          order: 1,
          tone: 'positive',
          label: 'Thriving Champions',
          description:
            'ความสุขและความผูกพันสูงกว่ามาตรฐาน เป็นทีมต้นแบบที่พร้อมแบ่งปันแนวทางสร้างประสบการณ์เชิงบวก',
          focus: 'ต่อยอดบทบาทเป็นพี่เลี้ยงและโค้ช เพื่อยกระดับหน่วยที่ยังตามหลัง',
          condition: (h, e) => h >= 78 && e >= 72
        },
        {
          id: 'happyLowCommit',
          order: 2,
          tone: 'warning',
          label: 'Highly Happy but Lowly Committed',
          description:
            'ความสุขในงานสูงแต่ความผูกพันยังไม่มั่นคง บ่งชี้ความเสี่ยงต่อการย้ายงานหากไม่มีเส้นทางเติบโตชัดเจน',
          focus: 'เน้นการสื่อสารวิสัยทัศน์และสร้างโอกาสเติบโต/พัฒนาเส้นทางความก้าวหน้า',
          condition: (h, e) => h >= 75 && e < 70
        },
        {
          id: 'committedStrain',
          order: 3,
          tone: 'neutral',
          label: 'Committed but Under Strain',
          description:
            'ยึดมั่นกับงานและทีม แต่คะแนนความสุขต่ำกว่ามาตรฐาน สะท้อนภาระงานและพลังงานที่ถดถอย',
          focus: 'ปรับตารางเวร เติมทรัพยากร และจัดโปรแกรมฟื้นฟูพลังงานป้องกันภาวะเหนื่อยล้า',
          condition: (h, e) => h < 70 && e >= 70
        },
        {
          id: 'atRisk',
          order: 4,
          tone: 'critical',
          label: 'Disengaged & Vulnerable',
          description:
            'ทั้งความสุขและความผูกพันอยู่ในระดับต่ำ ต้องเร่งเสริมระบบสนับสนุนและบทสนทนากับผู้นำสายงาน',
          focus: 'จัดทีมเฉพาะกิจรับฟังเสียงบุคลากร วางมาตรการเร่งด่วนเพื่อยึดเหนี่ยวคนและลดลาออก',
          condition: (h, e) => h < 65 && e < 65
        }
      ];

      const defaultPersona = {
        id: 'steadyCore',
        order: 5,
        tone: 'neutral',
        label: 'Balanced Core Team',
        description:
          'คะแนนอยู่ในระดับปานกลางทั้งสองด้าน ต้องรักษาเสถียรภาพพร้อมหา quick win เพื่อขยับสู่กลุ่มต้นแบบ',
        focus: 'กำหนด action เล็ก ๆ เช่น โครงการยกย่องและวงแลกเปลี่ยนประสบการณ์เพื่อดันคะแนนให้สูงขึ้น'
      };

      const personaState = {};
      [...personaDefinitions, defaultPersona].forEach(definition => {
        personaState[definition.id] = { ...definition, members: [], happinessTotal: 0, engagementTotal: 0 };
      });

      units.forEach(unit => {
        const matched = personaDefinitions.find(def => def.condition(unit.happiness, unit.engagement));
        const persona = matched || defaultPersona;
        const bucket = personaState[persona.id];
        bucket.members.push(unit);
        bucket.happinessTotal += unit.happiness;
        bucket.engagementTotal += unit.engagement;
      });

      const details = Object.values(personaState)
        .filter(detail => detail.members.length)
        .sort((a, b) => a.order - b.order)
        .map(detail => ({
          id: detail.id,
          tone: detail.tone,
          label: detail.label,
          description: detail.description,
          focus: detail.focus,
          averages: {
            happiness: detail.happinessTotal / detail.members.length,
            engagement: detail.engagementTotal / detail.members.length
          },
          members: detail.members
        }));

      const summaryParts = details.map(detail => `${detail.label} ${detail.members.length} หน่วย`).join(' • ');
      const riskGroup = details.find(detail => detail.id === 'atRisk');
      const totalUnits = units.length;
      let summaryText = `จำแนก ${totalUnits} หน่วยที่มีข้อมูลครบเป็น ${details.length} บุคลิก: ${summaryParts}.`;
      if (riskGroup) {
        const riskUnits = riskGroup.members.map(member => member.unit).join(', ');
        summaryText += ` กลุ่มเสี่ยงต้องเร่งฟื้นฟูคือ ${riskUnits}.`;
      }

      return { summary: summaryText, details };
    }

    function renderPersonaCards(container, details) {
      container.innerHTML = '';
      details.forEach(detail => {
        const card = document.createElement('div');
        card.className = `persona-card ${detail.tone}`;
        const averageLabel = `Happy ${formatPersonaMetric(detail.averages.happiness)} • Engagement ${formatPersonaMetric(detail.averages.engagement)}`;
        card.innerHTML = `
          <div class="persona-header">
            <span class="persona-tag">${detail.label}</span>
            <span class="persona-score">${averageLabel}</span>
          </div>
          <p class="persona-desc">${detail.description}</p>
          <p class="persona-focus"><strong>โฟกัส:</strong> ${detail.focus}</p>
          <div class="persona-members">
            ${detail.members
              .map(member => `<span class="persona-chip">${member.unit} (${member.happiness.toFixed(1)}% / ${member.engagement.toFixed(1)}%)</span>`)
              .join('')}
          </div>
        `;
        container.appendChild(card);
      });
    }

    const unitsData = {
      "18D": {
        happy: "71%",
        engagement: "74%",
        job: "75%",
        alerts: [
          "รักษาคะแนนผูกพัน ≥70% พร้อมมีลาออกเพียง 2 คน แสดงผลของการสื่อสารและการสนับสนุนที่ต่อเนื่อง"
        ]
      },
      "19C": {
        happy: "53.9%",
        engagement: "60.71%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "อยู่ในกลุ่มคะแนนความสุขต่ำ 53.9% ต้องเติมพลังงานและระบบสนับสนุน",
          "มิติ Relax 50.86% สะท้อนภาระงานที่ต้องเร่งจัดการ"
        ]
      },
      "20B": {
        happy: "57.00%",
        engagement: "59.56%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "คะแนน Body 62.40% และ Relax 48.80% สะท้อนความเหนื่อยล้า",
          "แนะนำจัดโครงการ Care for Caregivers และกำหนดผู้ช่วยสนับสนุน"
        ]
      },
      "22A & Stroke": {
        happy: "ไม่มีข้อมูล",
        engagement: "59.39%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "คะแนนความผูกพัน 59.39% อยู่ในกลุ่มที่ต้องเฝ้าระวัง",
          "สิ่งแวดล้อมการทำงาน 75.6% ยังต่ำกว่าค่าเฉลี่ยหน่วยบริการ"
        ]
      },
      "23A": {
        happy: "72%",
        engagement: "76%",
        job: "76%",
        alerts: [
          "หน่วยที่รักษาผูกพัน ≥70% เช่น 18D และ 23A มีการลาออกเพียง 2 คน",
          "ข้อมูลลาออกปี 2568 บันทึกเพียง 2 คน ช่วยสะท้อนการรักษากำลังคน"
        ]
      },
      "CSSD": {
        happy: "81.25%",
        engagement: "70.65%",
        job: "83.20%",
        alerts: [
          "การบังคับบัญชาสูงถึง 85.60% เป็นตัวอย่างการจัดการทีม",
          "ควรลงทุนต่อเนื่องในเทคโนโลยีสนับสนุนเพื่อลดภาระงานซ้ำ"
        ]
      },
      "DR": {
        happy: "64%",
        engagement: "65%",
        job: "70%",
        alerts: [
          "MICU และ DR อยู่ในกลุ่มผูกพันต่ำ (<65%) และสูญเสียรวม 6 คน",
          "ข้อมูลลาออกปี 2568 ระบุ DR มี 3 คน ต้องวางแผนพยุงกำลังคน"
        ]
      },
      "ER": {
        happy: "68.48%",
        engagement: "66.94%",
        job: "74.00%",
        alerts: [
          "ค่าตอบแทนและสวัสดิการ 68.20% (ปานกลาง) ต้องเร่งทบทวน",
          "ภาระงานสูงสะท้อนใน Relax 58.42% ต้องเพิ่มเวลาพักและทีมสนับสนุน"
        ]
      },
      "MICU": {
        happy: "59%",
        engagement: "63%",
        job: "66%",
        alerts: [
          "MICU และ DR อยู่ในกลุ่มผูกพันต่ำ (<65%) และสูญเสียรวม 6 คน",
          "ข้อมูลลาออกปี 2568 ระบุ MICU มี 3 คน สะท้อนผลของเวรหนัก"
        ]
      },
      "OPD2": {
        happy: "84.29%",
        engagement: "77.62%",
        job: "78.80%",
        alerts: [
          "คะแนนค่าตอบแทนและสวัสดิการ 83.40% สนับสนุนการรักษากำลังคน",
          "ควรต่อยอดโครงการพัฒนาผู้นำสายงานเพื่อรักษาคะแนนสูงต่อเนื่อง"
        ]
      },
      "OPD3": {
        happy: "74.21%",
        engagement: "ไม่มีข้อมูล",
        job: "ไม่มีข้อมูล",
        alerts: [
          "คะแนนความสุขรวม 74.21% อยู่ในกลุ่มทีมสุขภาพจิตดีร่วมกับ CSSD และปฐมภูมิ"
        ]
      },
      "OR": {
        happy: "62%",
        engagement: "60%",
        job: "68%",
        alerts: [
          "OR มีผูกพันเพียง 58% แต่มีการลาออกสูงสุด 6 คน ต้องเร่งเสริมแผนรักษาคน",
          "แบบจำลองลาออกสะท้อนภาระงานสูง (workloadPressure 0.78) แม้ความพึงพอใจ 68%"
        ]
      },
      "PICU": {
        happy: "48.89%",
        engagement: "62.72%",
        job: "81.00%",
        alerts: [
          "มิติ Relax เพียง 52.89% และ Happy Plus 48.15% ต้องเร่งเสริมกำลังใจ",
          "แม้สิ่งแวดล้อมการทำงานสูง (92.80%) แต่ต้องเติมทรัพยากรบุคลากรและวันพัก"
        ]
      },
      "Refer": {
        happy: "68%",
        engagement: "70%",
        job: "73%",
        alerts: [
          "ข้อมูลลาออก 2 คนพร้อมคะแนนผูกพัน 69% ต้องเฝ้าระวังการรักษาทีม",
          "แบบจำลองลาออกแสดงความสุข 68% และความพึงพอใจ 73% ต้องคุมภาระงานต่อเนื่อง"
        ]
      },
      "SICU": {
        happy: "65.00%",
        engagement: "64.96%",
        job: "72.40%",
        alerts: [
          "ลักษณะงาน 67.80% (ปานกลาง) ต้องปรับสัดส่วนเวร",
          "มิติ Relax 56.92% ควรเสริมทีมสนับสนุนด้านจิตใจ"
        ]
      },
      "สำนักงาน": {
        happy: "ไม่มีข้อมูล",
        engagement: "ไม่มีข้อมูล",
        job: "87.2%",
        alerts: [
          "โดดเด่นในสิ่งแวดล้อมการทำงาน 90% และสวัสดิการ 86% เป็นต้นแบบพื้นที่สนับสนุน",
          "การบังคับบัญชา 87.6% สูงสุด สะท้อนภาวะผู้นำที่ชัดเจน"
        ]
      },
      "งานระบาด": {
        happy: "ไม่มีข้อมูล",
        engagement: "93.33%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "คะแนนความผูกพัน 4.67 (93.33%) สะท้อนผู้นำและภารกิจชัดเจน"
        ]
      },
      "ผู้บริหาร": {
        happy: "75.43%",
        engagement: "80.58%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "ความผูกพันสูงควบคู่ความสุข 75.43% ชี้บทบาทผู้นำที่ต้องต่อยอด"
        ]
      },
      "ปฐมภูมิ": {
        happy: "80.0%",
        engagement: "78.67%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "อยู่ในกลุ่มทีมสุขภาพจิตดีและมีระบบทีมหนุน Happy Plus 84%",
          "คะแนนความผูกพัน 78.67% ช่วยรักษาผลงานต่อเนื่อง"
        ]
      },
      "หอพัก": {
        happy: "90.0%",
        engagement: "73.33%",
        job: "ไม่มีข้อมูล",
        alerts: [
          "คะแนนสุขภาวะองค์รวมสูงทุกมิติ เหมาะเป็นพื้นที่แลกเปลี่ยนแนวปฏิบัติที่ดี"
        ]
      },
      "ไตเทียม": {
        happy: "68.67%",
        engagement: "66.52%",
        job: "74.80%",
        alerts: [
          "การบังคับบัญชา 68.80% และค่าตอบแทน 66.80% อยู่ระดับปานกลาง",
          "ควรสื่อสารเส้นทางความก้าวหน้าและสวัสดิการเฉพาะทางเพิ่ม"
        ]
      },
      "บางพระ": {
        happy: "66%",
        engagement: "68%",
        job: "72%",
        alerts: [
          "MICU / DR / บางพระ มีการลาออก 3 คน ต้องทบทวนแผนเวรและสวัสดิการ",
          "ข้อมูลลาออกปี 2568 ระบุบางพระ 3 คน พร้อมคะแนนความสุข 66% และพึงพอใจ 72%"
        ]
      }
    };

    const personaSummaryElement = document.getElementById('personaSummary');
    const personaGridElement = document.getElementById('personaGrid');

    if (personaSummaryElement && personaGridElement) {
      const personaResult = analyzeEngagementPersonas(unitsData);
      if (personaResult.details.length) {
        personaSummaryElement.textContent = personaResult.summary;
        renderPersonaCards(personaGridElement, personaResult.details);
      } else {
        personaSummaryElement.textContent = personaResult.summary;
      }
    }

    const satisfactionDimensionData = [
      { unit: 'สำนักงาน', command: 87.6, compensation: 86.0, jobNature: 84.5, environment: 90.0, growth: 85.2 },
      { unit: 'CSSD', command: 85.6, compensation: 82.2, jobNature: 80.4, environment: 88.0, growth: 81.6 },
      { unit: 'OPD2', command: 82.0, compensation: 83.4, jobNature: 81.2, environment: 85.4, growth: 80.8 },
      { unit: 'PICU', command: 72.8, compensation: 71.5, jobNature: 70.4, environment: 92.8, growth: 69.0 },
      { unit: 'ER', command: 75.2, compensation: 68.2, jobNature: 72.0, environment: 75.6, growth: 70.3 },
      { unit: 'ไตเทียม', command: 68.8, compensation: 66.8, jobNature: 71.0, environment: 78.0, growth: 69.4 },
      { unit: 'SICU', command: 70.5, compensation: 72.0, jobNature: 67.8, environment: 74.0, growth: 68.6 },
      { unit: 'ปฐมภูมิ', command: 80.2, compensation: 78.6, jobNature: 82.4, environment: 83.5, growth: 81.0 }
    ];

    const satisfactionDimensionKeys = ['command', 'compensation', 'jobNature', 'environment', 'growth'];

    const satisfactionDimensionLabels = {
      command: 'การบังคับบัญชา',
      compensation: 'ค่าตอบแทนและสวัสดิการ',
      jobNature: 'ลักษณะงาน',
      environment: 'สิ่งแวดล้อมการทำงาน',
      growth: 'โอกาสเติบโต'
    };

    const heatmapLowColor = [255, 138, 91];
    const heatmapHighColor = [43, 177, 168];

    const tabButtons = document.querySelectorAll('.tab-button');
    const panels = document.querySelectorAll('.panel');

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.dataset.target;
        tabButtons.forEach(btn => btn.classList.remove('active'));
        panels.forEach(panel => panel.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(target).classList.add('active');
      });
    });

    const unitSelect = document.getElementById('unitSelect');
    const happyScore = document.getElementById('happyScore');
    const engagementScore = document.getElementById('engagementScore');
    const jobScore = document.getElementById('jobScore');
    const alertList = document.getElementById('alertList');

    function updateUnitDetails(unit) {
      if (!happyScore || !engagementScore || !jobScore || !alertList) {
        return;
      }

      const data = unitsData[unit];
      if (!data) {
        happyScore.textContent = 'ไม่มีข้อมูล';
        engagementScore.textContent = 'ไม่มีข้อมูล';
        jobScore.textContent = 'ไม่มีข้อมูล';
        alertList.innerHTML = '';
        const emptyState = document.createElement('div');
        emptyState.className = 'alert-item';
        emptyState.textContent = 'ไม่มีข้อมูลสำหรับหน่วยงานนี้';
        alertList.appendChild(emptyState);
        return;
      }

      happyScore.textContent = data.happy || 'ไม่มีข้อมูล';
      engagementScore.textContent = data.engagement || 'ไม่มีข้อมูล';
      jobScore.textContent = data.job || 'ไม่มีข้อมูล';

      alertList.innerHTML = '';
      const alerts = Array.isArray(data.alerts) && data.alerts.length
        ? data.alerts
        : ['ไม่มีข้อมูลสัญญาณเตือนสำหรับหน่วยงานนี้'];

      alerts.forEach(item => {
        const div = document.createElement('div');
        div.className = 'alert-item';
        div.textContent = item;
        alertList.appendChild(div);
      });
    }

    if (unitSelect) {
      const sortedUnits = Object.keys(unitsData).sort((a, b) => a.localeCompare(b, 'th'));

      unitSelect.innerHTML = '';
      sortedUnits.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit;
        option.textContent = unit;
        unitSelect.appendChild(option);
      });

      unitSelect.addEventListener('change', event => {
        updateUnitDetails(event.target.value);
      });

      if (sortedUnits.length) {
        unitSelect.value = sortedUnits[0];
        updateUnitDetails(sortedUnits[0]);
      } else {
        updateUnitDetails();
      }
    }

    const heatmapElement = document.getElementById('satisfactionHeatmap');
    if (heatmapElement) {
      renderSatisfactionHeatmap(heatmapElement, satisfactionDimensionData, satisfactionDimensionKeys);
    }

    const radarUnitSelect = document.getElementById('radarUnitSelect');
    const happinessRadarCanvas = document.getElementById('happinessRadar');
    const satisfactionRadarCanvas = document.getElementById('satisfactionRadar');
    const radarNoteElement = document.getElementById('radarNote');

    let happinessRadarChart = null;
    let satisfactionRadarChart = null;

    if (
      radarUnitSelect &&
      happinessRadarCanvas &&
      satisfactionRadarCanvas &&
      typeof Chart !== 'undefined'
    ) {
      const unitOptions = Array.from(
        new Set([
          ...happinessProfiles.map(profile => profile.unit),
          ...satisfactionDimensionData.map(item => item.unit)
        ])
      ).sort((a, b) => a.localeCompare(b, 'th'));

      if (!unitOptions.length) {
        if (radarNoteElement) {
          applyDescriptionContent(
            radarNoteElement,
            'ยังไม่มีข้อมูลเพียงพอสำหรับสร้างกราฟ Radar',
            'ยังไม่มีข้อมูลเพียงพอสำหรับสร้างกราฟ Radar (missing data) ต้องรวบรวมคะแนนอย่างน้อยหนึ่งรอบเพื่อสร้างการแจกแจง'
          );
        }
      } else {
        radarUnitSelect.innerHTML = unitOptions
          .map(unit => `<option value="${unit}">${unit}</option>`)
          .join('');

        if (!radarUnitSelect.value && unitOptions[0]) {
          radarUnitSelect.value = unitOptions[0];
        }

        const happinessLabels = dimensionKeys.map(key => dimensionLabels[key]);
        const satisfactionLabels = satisfactionDimensionKeys.map(
          key => satisfactionDimensionLabels[key]
        );

        happinessRadarChart = new Chart(happinessRadarCanvas.getContext('2d'), {
          type: 'radar',
          data: {
            labels: happinessLabels,
            datasets: [
              {
                label: 'Happinometer',
                data: new Array(happinessLabels.length).fill(Number.NaN),
                backgroundColor: 'rgba(60, 88, 185, 0.18)',
                borderColor: '#3c58b9',
                borderWidth: 2,
                pointBackgroundColor: '#3c58b9',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#3c58b9'
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              r: {
                suggestedMin: 40,
                suggestedMax: 100,
                ticks: {
                  stepSize: 10,
                  backdropColor: 'transparent',
                  color: '#5d6a93'
                },
                grid: {
                  color: 'rgba(31, 42, 68, 0.12)'
                },
                angleLines: {
                  color: 'rgba(31, 42, 68, 0.12)'
                },
                pointLabels: {
                  color: '#1f2a44',
                  font: {
                    size: 11
                  }
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  color: '#1f2a44'
                }
              }
            }
          }
        });

        satisfactionRadarChart = new Chart(satisfactionRadarCanvas.getContext('2d'), {
          type: 'radar',
          data: {
            labels: satisfactionLabels,
            datasets: [
              {
                label: 'Job Satisfaction',
                data: new Array(satisfactionLabels.length).fill(Number.NaN),
                backgroundColor: 'rgba(255, 138, 91, 0.22)',
                borderColor: '#ff8a5b',
                borderWidth: 2,
                pointBackgroundColor: '#ff8a5b',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#ff8a5b'
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              r: {
                suggestedMin: 40,
                suggestedMax: 100,
                ticks: {
                  stepSize: 10,
                  backdropColor: 'transparent',
                  color: '#5d6a93'
                },
                grid: {
                  color: 'rgba(31, 42, 68, 0.12)'
                },
                angleLines: {
                  color: 'rgba(31, 42, 68, 0.12)'
                },
                pointLabels: {
                  color: '#1f2a44',
                  font: {
                    size: 11
                  }
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  color: '#1f2a44'
                }
              }
            }
          }
        });

        const defaultUnit = radarUnitSelect.value || unitOptions[0];
        if (defaultUnit) {
          updateRadarCharts(defaultUnit);
        }

        radarUnitSelect.addEventListener('change', event => {
          updateRadarCharts(event.target.value);
        });
      }
    }

    const commitmentData = [
      { unit: 'OR', commitment: 58, resignations: 6 },
      { unit: 'MICU', commitment: 61, resignations: 3 },
      { unit: 'DR', commitment: 63, resignations: 3 },
      { unit: 'บางพระ', commitment: 67, resignations: 3 },
      { unit: 'Refer', commitment: 69, resignations: 2 },
      { unit: '18D', commitment: 72, resignations: 2 },
      { unit: '23A', commitment: 74, resignations: 2 }
    ];

    const commitmentTable = document.getElementById('commitmentTable');
    const commitmentSummary = document.getElementById('commitmentSummary');
    const commitmentInsights = document.getElementById('commitmentInsights');

    const totalResignations = commitmentData.reduce((sum, item) => sum + item.resignations, 0);
    const lowCommitment = commitmentData.filter(item => item.commitment < 65);
    const highCommitment = commitmentData.filter(item => item.commitment >= 70);

    commitmentData.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${item.unit}</strong></td>
        <td>${item.commitment}%</td>
        <td>${item.resignations} คน</td>
      `;
      commitmentTable.appendChild(row);
    });

    const lowResignations = lowCommitment.reduce((sum, item) => sum + item.resignations, 0);
    const highResignations = highCommitment.reduce((sum, item) => sum + item.resignations, 0);
    const shareLow = Math.round((lowResignations / totalResignations) * 100);
    const shareHigh = Math.round((highResignations / totalResignations) * 100);

    const easyCommitmentSummary = `หน่วยที่มีความผูกพันต่ำกว่า 65% (${lowCommitment.length} หน่วย) คิดเป็น <span class="trend-indicator">${shareLow}%</span> ของการลาออกทั้งหมด (${lowResignations}/${totalResignations} คน) ขณะที่หน่วยที่มีคะแนน ≥ 70% มีเพียง ${shareHigh}% ของการลาออก (${highResignations} คน)`;
    const advancedCommitmentSummary = `กลุ่มผูกพันต่ำกว่า 65% มีสัดส่วนลาออก ${shareLow}% (${lowResignations}/${totalResignations} คน) สูงกว่ากลุ่มคะแนน ≥70% ซึ่งมีเพียง ${shareHigh}% (${highResignations}/${totalResignations}) สะท้อนความสัมพันธ์เชิงสัดส่วน (proportion) ระหว่างความผูกพันและการลาออก`;
    applyDescriptionContent(commitmentSummary, easyCommitmentSummary, advancedCommitmentSummary);

    const insightItems = [
      'OR มีผูกพันเพียง 58% แต่มีการลาออกสูงสุด 6 คน ต้องเร่งเสริมแผนรักษาคนโดยเฉพาะ N 4 คนและ PN 2 คน',
      'MICU และ DR อยู่ในกลุ่มผูกพันต่ำ (<65%) และสูญเสียรวม 6 คน สอดคล้องกับคะแนน Relax ต่ำและเวรหนัก',
      'หน่วยที่รักษาผูกพัน ≥70% เช่น 18D และ 23A มีการลาออกเพียง 2 คน แสดงผลของการสื่อสารและการสนับสนุนที่ต่อเนื่อง'
    ];

    insightItems.forEach(text => {
      const item = document.createElement('div');
      item.className = 'alert-item';
      item.textContent = text;
      commitmentInsights.appendChild(item);
    });

    const resignationTrendData = [
      { unit: 'OR', current: 6, commitment: 58, engagement: 60, happiness: 62, satisfaction: 68, workloadPressure: 0.78, mitigation: 0.18 },
      { unit: 'MICU', current: 3, commitment: 61, engagement: 63, happiness: 59, satisfaction: 66, workloadPressure: 0.74, mitigation: 0.18 },
      { unit: 'DR', current: 3, commitment: 63, engagement: 65, happiness: 64, satisfaction: 70, workloadPressure: 0.68, mitigation: 0.15 },
      { unit: 'บางพระ', current: 3, commitment: 67, engagement: 68, happiness: 66, satisfaction: 72, workloadPressure: 0.6, mitigation: 0.12 },
      { unit: 'Refer', current: 2, commitment: 69, engagement: 70, happiness: 68, satisfaction: 73, workloadPressure: 0.58, mitigation: 0.2 },
      { unit: '18D', current: 2, commitment: 72, engagement: 74, happiness: 71, satisfaction: 75, workloadPressure: 0.55, mitigation: 0.22 },
      { unit: '23A', current: 2, commitment: 74, engagement: 76, happiness: 72, satisfaction: 76, workloadPressure: 0.52, mitigation: 0.25 }
    ];

    let comparativeUnits = [];
    let comparisonResults = null;

    const topBottomSummaryElement = document.getElementById('topBottomSummary');
    const commitmentComparativeElement = document.getElementById('commitmentComparative');
    const satisfactionComparativeElement = document.getElementById('satisfactionComparative');
    const happinessComparativeElement = document.getElementById('happinessComparative');
    const topBottomHighlightsElement = document.getElementById('topBottomHighlights');
    const satisfactionResignationSummaryElement = document.getElementById('satisfactionResignationSummary');
    const satisfactionResignationTable = document.getElementById('satisfactionResignationTable');
    const satisfactionResignationInsightsElement = document.getElementById('satisfactionResignationInsights');
    const commitmentHappinessSummaryElement = document.getElementById('commitmentHappinessSummary');
    const commitmentHappinessInsightsElement = document.getElementById('commitmentHappinessInsights');

    if (
      topBottomSummaryElement &&
      commitmentComparativeElement &&
      satisfactionComparativeElement &&
      happinessComparativeElement &&
      topBottomHighlightsElement
    ) {
      const comparativeMap = new Map();

      resignationTrendData.forEach(item => {
        const satisfaction = Number.isFinite(item.satisfaction)
          ? item.satisfaction
          : (item.commitment + item.engagement + item.happiness) / 3;
        comparativeMap.set(item.unit, {
          unit: item.unit,
          commitment: item.commitment,
          satisfaction,
          happiness: item.happiness,
          resignations: item.current
        });
      });

      Object.entries(unitsData).forEach(([unit, data]) => {
        const commitment = parsePercentageValue(data.engagement);
        const satisfaction = parsePercentageValue(data.job);
        const happiness = parsePercentageValue(data.happy);
        if (commitment !== null && satisfaction !== null && happiness !== null) {
          const existing = comparativeMap.get(unit) || { unit };
          comparativeMap.set(unit, {
            unit,
            commitment: existing.commitment ?? commitment,
            satisfaction: existing.satisfaction ?? satisfaction,
            happiness: existing.happiness ?? happiness,
            resignations: existing.resignations ?? null
          });
        }
      });

      comparativeUnits = Array.from(comparativeMap.values()).filter(
        item =>
          Number.isFinite(item.commitment) &&
          Number.isFinite(item.satisfaction) &&
          Number.isFinite(item.happiness)
      );

      const metricConfigs = [
        { key: 'commitment', element: commitmentComparativeElement, label: 'ช่องว่างคะแนนความผูกพัน' },
        { key: 'satisfaction', element: satisfactionComparativeElement, label: 'ช่องว่างคะแนนความพึงพอใจ' },
        { key: 'happiness', element: happinessComparativeElement, label: 'ช่องว่างคะแนนความสุขรวม' }
      ];

      comparisonResults = {};

      metricConfigs.forEach(config => {
        const result = buildTopBottomComparison(comparativeUnits, config.key);
        if (!result) {
          return;
        }
        comparisonResults[config.key] = result;
        const topLabel = result.topGroup
          .map(item => `${item.unit} (${item[config.key].toFixed(1)}%)`)
          .join(', ');
        const bottomLabel = result.bottomGroup
          .map(item => `${item.unit} (${item[config.key].toFixed(1)}%)`)
          .join(', ');
        const diffLabel = result.diff >= 0 ? '+' : '';
        const easyComparison = `Top ${result.size}: ${topLabel}<br>Bottom ${result.size}: ${bottomLabel}`;
        const advancedComparison = `กลุ่ม Top ${result.size} มีค่าเฉลี่ย ${result.topAvg.toFixed(1)}% สูงกว่า Bottom ${result.size} ที่ ${result.bottomAvg.toFixed(1)}% (Δ = ${diffLabel}${result.diff.toFixed(1)} จุด) แสดงช่องว่างเชิงสถิติของมิติ ${config.label}`;
        config.element.innerHTML = `
          <span class="metric-title">${config.label}</span>
          <span class="metric-value">${diffLabel}${result.diff.toFixed(1)} จุด</span>
          ${createDescriptionMarkup(easyComparison, advancedComparison, { tag: 'p', classes: ['metric-desc'] })}
        `;
        activateDescriptionToggles(config.element);
      });

      const validComparisons = metricConfigs
        .map(config => comparisonResults[config.key])
        .filter(Boolean);

      if (validComparisons.length) {
        const topAverage = calculateAverage(validComparisons.map(result => result.topAvg));
        const bottomAverage = calculateAverage(validComparisons.map(result => result.bottomAvg));
        const gap = topAverage - bottomAverage;
        const gapLabel = gap >= 0 ? '+' : '';
        const easyTopBottom = `คะแนนเฉลี่ยสามมิติเชิงประสบการณ์ของ Top 5 อยู่ที่ ${topAverage.toFixed(1)}% สูงกว่า Bottom 5 ที่ ${bottomAverage.toFixed(1)}%`;
        const advancedTopBottom = `เมื่อคำนวณค่าเฉลี่ยรวมสามมิติ (commitment, satisfaction, happiness) กลุ่ม Top 5 มีค่า ${topAverage.toFixed(1)}% เทียบกับ ${bottomAverage.toFixed(1)}% ในกลุ่ม Bottom 5 ทำให้ส่วนต่าง ${gapLabel}${gap.toFixed(1)} จุด มีนัยสำคัญเชิงการจัดอันดับ`;
        topBottomSummaryElement.innerHTML = `
          <span class="metric-title">${comparativeUnits.length} หน่วยพร้อมข้อมูลครบ</span>
          <span class="metric-value">${gapLabel}${gap.toFixed(1)} จุด</span>
          ${createDescriptionMarkup(easyTopBottom, advancedTopBottom, { tag: 'p', classes: ['metric-desc'] })}
        `;
        activateDescriptionToggles(topBottomSummaryElement);
      }

      const highlightMessages = [];
      const commitmentResult = comparisonResults?.commitment;
      const satisfactionResult = comparisonResults?.satisfaction;
      const happinessResult = comparisonResults?.happiness;

      if (commitmentResult) {
        const topLeader = commitmentResult.topGroup[0];
        const bottomLeader = commitmentResult.bottomGroup[0];
        highlightMessages.push(
          `ความผูกพันของกลุ่มนำสูงกว่า ${commitmentResult.diff.toFixed(1)} จุด นำโดย ${topLeader.unit} (${topLeader.commitment.toFixed(1)}%) เทียบกับ ${bottomLeader.unit} (${bottomLeader.commitment.toFixed(1)}%)`
        );
      }

      if (satisfactionResult) {
        const lowShareUnits = satisfactionResult.bottomGroup.slice(0, 2).map(item => item.unit).join(', ');
        highlightMessages.push(
          `หน่วยที่ความพึงพอใจต่ำสุด ได้แก่ ${lowShareUnits} ซึ่งเฉลี่ยแล้วอยู่ต่ำกว่า Top Group ${satisfactionResult.diff.toFixed(1)} จุด`
        );
      }

      if (happinessResult) {
        const highCommitmentHappy = happinessResult.topGroup.filter(item => item.commitment >= 70);
        if (highCommitmentHappy.length) {
          highlightMessages.push(
            `หน่วยที่รักษาความสุขและความผูกพัน ≥70% พร้อมกัน ได้แก่ ${highCommitmentHappy
              .map(item => item.unit)
              .join(', ')}`
          );
        } else {
          highlightMessages.push(
            `กลุ่มความสุขสูงมีความผูกพันเฉลี่ย ${happinessResult.topAvg.toFixed(1)}% สูงกว่ากลุ่มต่ำ ${happinessResult.bottomAvg.toFixed(1)}%`
          );
        }
      }

      topBottomHighlightsElement.innerHTML = '';
      highlightMessages.forEach(message => {
        const item = document.createElement('div');
        item.className = 'alert-item';
        item.textContent = message;
        topBottomHighlightsElement.appendChild(item);
      });
    }

    if (
      satisfactionResignationSummaryElement &&
      satisfactionResignationTable &&
      satisfactionResignationInsightsElement
    ) {
      const satisfactionResignData = resignationTrendData.map(item => ({
        unit: item.unit,
        satisfaction: Number.isFinite(item.satisfaction)
          ? item.satisfaction
          : (item.commitment + item.engagement + item.happiness) / 3,
        resignations: item.current
      }));

      const satisfactionCorrelation = calculatePearson(satisfactionResignData, 'satisfaction', 'resignations');
      const threshold = 70;
      const lowGroup = satisfactionResignData.filter(item => item.satisfaction < threshold);
      const highGroup = satisfactionResignData.filter(item => item.satisfaction >= threshold);
      const lowAverage = calculateAverage(lowGroup, 'resignations');
      const highAverage = calculateAverage(highGroup, 'resignations');
      const totalResignCount = satisfactionResignData.reduce((sum, item) => sum + item.resignations, 0);
      const lowResignCount = lowGroup.reduce((sum, item) => sum + item.resignations, 0);
      const highResignCount = highGroup.reduce((sum, item) => sum + item.resignations, 0);
      const lowShare = totalResignCount ? (lowResignCount / totalResignCount) * 100 : 0;
      const highShare = totalResignCount ? (highResignCount / totalResignCount) * 100 : 0;

      const correlationLabel = satisfactionCorrelation >= 0 ? '+' : '';
      const easySatisfactionSummary = `กลุ่มคะแนนความพึงพอใจต่ำกว่า ${threshold}% มีลาออกเฉลี่ย ${lowAverage.toFixed(1)} คน/หน่วย (${lowShare.toFixed(1)}% ของทั้งหมด) เทียบกับ ${highAverage.toFixed(1)} คน/หน่วย ในกลุ่มคะแนนสูง (${highShare.toFixed(1)}%)`;
      const advancedSatisfactionSummary = `ค่า Pearson's r = ${correlationLabel}${satisfactionCorrelation.toFixed(2)} ชี้ว่ากลุ่มคะแนนต่ำกว่า ${threshold}% มีลาออกเฉลี่ย ${lowAverage.toFixed(1)} คน/หน่วย (${lowShare.toFixed(1)}%) มากกว่ากลุ่มคะแนน ≥${threshold}% ที่ ${highAverage.toFixed(1)} คน/หน่วย (${highShare.toFixed(1)}%)`;
      satisfactionResignationSummaryElement.innerHTML = `
        <span class="metric-title">สหสัมพันธ์ (r)</span>
        <span class="metric-value">${correlationLabel}${satisfactionCorrelation.toFixed(2)}</span>
        ${createDescriptionMarkup(easySatisfactionSummary, advancedSatisfactionSummary, { tag: 'p', classes: ['metric-desc'] })}
      `;
      activateDescriptionToggles(satisfactionResignationSummaryElement);

      satisfactionResignationTable.innerHTML = '';
      satisfactionResignData
        .slice()
        .sort((a, b) => a.satisfaction - b.satisfaction)
        .forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${item.unit}</strong></td>
            <td>${item.satisfaction.toFixed(1)}%</td>
            <td>${item.resignations} คน</td>
          `;
          satisfactionResignationTable.appendChild(row);
        });

      const lowLeaders = lowGroup.map(item => `${item.unit} (${item.resignations} คน)`).join(', ');
      const highStable = highGroup.map(item => `${item.unit} (${item.resignations} คน)`).join(', ');

      const insightMessages = [];
      if (lowGroup.length) {
        insightMessages.push(
          `คะแนนความพึงพอใจต่ำกว่า ${threshold}% เช่น ${lowLeaders} คิดเป็น ${lowShare.toFixed(1)}% ของการลาออกทั้งหมด`
        );
      }
      if (highGroup.length) {
        insightMessages.push(
          `กลุ่มที่รักษาความพึงพอใจ ≥${threshold}% (${highStable}) มีลาออกเฉลี่ยต่ำกว่า ${highAverage.toFixed(1)} คน/หน่วย`
        );
      }
      insightMessages.push('ค่าสหสัมพันธ์เป็นบวกอ่อน แสดงว่าความพึงพอใจที่ลดลงยังคงสัมพันธ์กับการสูญเสียกำลังคน แม้จะมีปัจจัยอื่นร่วมด้วย');

      satisfactionResignationInsightsElement.innerHTML = '';
      insightMessages.forEach(message => {
        const item = document.createElement('div');
        item.className = 'alert-item';
        item.textContent = message;
        satisfactionResignationInsightsElement.appendChild(item);
      });
    }

    if (commitmentHappinessSummaryElement && commitmentHappinessInsightsElement) {
      const dataForCorrelation = comparativeUnits.length ? comparativeUnits : resignationTrendData.map(item => ({
        unit: item.unit,
        commitment: item.commitment,
        happiness: item.happiness
      }));

      const correlation = calculatePearson(dataForCorrelation, 'happiness', 'commitment');
      const correlationLabel = correlation >= 0 ? '+' : '';
      const happinessComparison = comparisonResults?.happiness || buildTopBottomComparison(dataForCorrelation, 'happiness');
      const topCommitmentAverage = happinessComparison ? calculateAverage(happinessComparison.topGroup, 'commitment') : 0;
      const bottomCommitmentAverage = happinessComparison ? calculateAverage(happinessComparison.bottomGroup, 'commitment') : 0;
      const commitmentGap = topCommitmentAverage - bottomCommitmentAverage;
      const gapLabel = commitmentGap >= 0 ? '+' : '';

      const easyCommitmentHappiness = `กลุ่มที่มีความสุขสูงสุดรักษาคะแนนผูกพันเฉลี่ย ${topCommitmentAverage.toFixed(1)}% สูงกว่ากลุ่มต่ำสุด ${gapLabel}${Math.abs(commitmentGap).toFixed(1)} จุด`;
      const advancedCommitmentHappiness = `ค่า Pearson's r = ${correlationLabel}${correlation.toFixed(2)} และค่าเฉลี่ยความผูกพันของกลุ่มความสุขสูง (${topCommitmentAverage.toFixed(1)}%) สูงกว่ากลุ่มต่ำ (${bottomCommitmentAverage.toFixed(1)}%) อยู่ที่ ${gapLabel}${Math.abs(commitmentGap).toFixed(1)} จุด แสดงความสัมพันธ์เชิงบวกปานกลาง`;
      commitmentHappinessSummaryElement.innerHTML = `
        <span class="metric-title">สหสัมพันธ์ (r)</span>
        <span class="metric-value">${correlationLabel}${correlation.toFixed(2)}</span>
        ${createDescriptionMarkup(easyCommitmentHappiness, advancedCommitmentHappiness, { tag: 'p', classes: ['metric-desc'] })}
      `;
      activateDescriptionToggles(commitmentHappinessSummaryElement);

      const alignedUnits = dataForCorrelation.filter(item => item.commitment >= 70 && item.happiness >= 70);
      const riskUnits = dataForCorrelation.filter(item => item.commitment < 65 && item.happiness < 65);
      const mismatchUnits = dataForCorrelation.filter(
        item => (item.happiness >= 70 && item.commitment < 65) || (item.happiness < 65 && item.commitment >= 70)
      );

      const correlationInsights = [];
      if (alignedUnits.length) {
        correlationInsights.push(
          `High-High Cluster: ${alignedUnits.map(item => `${item.unit} (${item.happiness.toFixed(1)}% / ${item.commitment.toFixed(1)}%)`).join(', ')}`
        );
      }
      if (riskUnits.length) {
        correlationInsights.push(
          `Low-Low Cluster: ${riskUnits.map(item => `${item.unit} (${item.happiness.toFixed(1)}% / ${item.commitment.toFixed(1)}%)`).join(', ')} ต้องการแผนฟื้นฟูเร่งด่วน`
        );
      }
      if (mismatchUnits.length) {
        correlationInsights.push(
          `Mismatch ที่ควรเจาะลึก: ${mismatchUnits.map(item => `${item.unit} (${item.happiness.toFixed(1)}% / ${item.commitment.toFixed(1)}%)`).join(', ')}`
        );
      }
      correlationInsights.push('แนวโน้มบวกระดับกลางชี้ว่าการยกระดับประสบการณ์เชิงบวกยังช่วยเสริมความผูกพันได้ แม้ต้องบริหารปัจจัยอื่นประกอบ');

      commitmentHappinessInsightsElement.innerHTML = '';
      correlationInsights.forEach(message => {
        const item = document.createElement('div');
        item.className = 'alert-item';
        item.textContent = message;
        commitmentHappinessInsightsElement.appendChild(item);
      });
    }

    const forecastGrid = document.getElementById('forecastGrid');
    const forecastInsights = document.getElementById('forecastInsights');

    function formatHeadcount(value) {
      return Math.abs(value - Math.round(value)) < 0.05 ? Math.round(value).toString() : value.toFixed(1);
    }

    const forecastResults = resignationTrendData.map(item => {
      const satisfactionIndex = (item.commitment + item.engagement + item.happiness) / 3;
      const pressureWeight = item.workloadPressure * 40;
      const satisfactionWeight = Math.max(0, (70 - satisfactionIndex) * 0.6);
      const mitigationWeight = item.mitigation * 25;
      const riskIndex = Math.max(8, pressureWeight + satisfactionWeight - mitigationWeight);

      const baselineHalf = item.current * 0.45;
      const riskAdjustmentHalf = 1 + (riskIndex - 25) / 120;
      const forecastSix = Math.max(0.2, baselineHalf * riskAdjustmentHalf);

      const baselineYear = item.current;
      const riskAdjustmentYear = Math.max(0.55, 1 + (riskIndex - 25) / 90 - item.mitigation * 0.25);
      const forecastTwelve = Math.max(0.5, baselineYear * riskAdjustmentYear);

      const riskLevel = riskIndex >= 38 ? 'high' : riskIndex >= 26 ? 'moderate' : 'low';
      const riskLabel = riskLevel === 'high' ? 'เสี่ยงสูง' : riskLevel === 'moderate' ? 'เฝ้าระวัง' : 'เสถียร';
      const growthRate = item.current > 0 ? ((forecastTwelve - item.current) / item.current) * 100 : 0;

      return {
        ...item,
        satisfactionIndex,
        riskIndex,
        forecastSix,
        forecastTwelve,
        riskLevel,
        riskLabel,
        growthRate
      };
    });

    forecastResults.forEach(result => {
      const card = document.createElement('div');
      card.className = 'forecast-card';

      const growthSymbol = result.growthRate >= 0 ? '↑' : '↓';
      const growthClass = result.growthRate >= 0 ? 'forecast-trend' : 'forecast-trend down';
      const growthValue = `${result.growthRate >= 0 ? '+' : ''}${Math.round(result.growthRate)}% เทียบกับปีปัจจุบัน`;
      const relativeWidth = Math.max(20, Math.min(120, Math.round((result.forecastTwelve / (result.current || 1)) * 100)));

      card.innerHTML = `
        <div class="forecast-header">
          <h4>${result.unit}</h4>
          <span class="risk-badge ${result.riskLevel}">${result.riskLabel}</span>
        </div>
        <div class="forecast-metric">
          <span class="label">คาดการณ์ 6 เดือน</span>
          <span class="value">${formatHeadcount(result.forecastSix)} คน</span>
        </div>
        <div class="forecast-metric">
          <span class="label">คาดการณ์ 12 เดือน</span>
          <span class="value">${formatHeadcount(result.forecastTwelve)} คน</span>
        </div>
        <div class="${growthClass}">${growthSymbol} ${growthValue}</div>
        <div class="forecast-bar"><span style="width: ${relativeWidth}%;"></span></div>
        <p class="forecast-note">ดัชนีความพึงพอใจเฉลี่ย ${Math.round(result.satisfactionIndex)}% | ภาระงาน ${Math.round(result.workloadPressure * 100)}% | แผนลดความเสี่ยง ${Math.round(result.mitigation * 100)}%</p>
      `;

      forecastGrid.appendChild(card);
    });

    const totalForecastTwelve = forecastResults.reduce((sum, item) => sum + item.forecastTwelve, 0);
    const totalCurrent = resignationTrendData.reduce((sum, item) => sum + item.current, 0);
    const totalDiff = totalForecastTwelve - totalCurrent;
    const diffLabel = totalDiff >= 0 ? 'เพิ่ม' : 'ลดลง';
    const diffPrefix = totalDiff >= 0 ? '+' : '-';
    const diffPercent = totalCurrent > 0 ? Math.abs(totalDiff) / totalCurrent * 100 : 0;

    const highRiskUnits = forecastResults.filter(item => item.riskLevel === 'high');
    const moderateRiskUnits = forecastResults.filter(item => item.riskLevel === 'moderate');
    const stableUnits = forecastResults.filter(item => item.riskLevel === 'low');

    const priorityGroup = highRiskUnits.length ? highRiskUnits : moderateRiskUnits.slice(0, 2);
    const priorityLabel = highRiskUnits.length ? 'หน่วยเสี่ยงสูง' : 'หน่วยที่ต้องเฝ้าระวัง';

    const summaryItems = [
      `แบบจำลองคาดว่าการลาออกอาจ${diffLabel}เป็น ${formatHeadcount(totalForecastTwelve)} คนใน 12 เดือน (${diffPrefix}${formatHeadcount(Math.abs(totalDiff))} คน หรือ ${diffPrefix}${diffPercent.toFixed(1)}%)`,
      priorityGroup.length
        ? `${priorityLabel}: ${priorityGroup.map(item => `${item.unit} (${formatHeadcount(item.forecastTwelve)} คน, ดัชนี ${Math.round(item.riskIndex)})`).join(', ')}`
        : 'ไม่มีหน่วยที่อยู่ในระดับเสี่ยงสูง ข้อมูลบ่งชี้ว่ามาตรการที่มีอยู่สามารถรักษาระดับได้',
      stableUnits.length
        ? `จุดแข็งที่ควรต่อยอด: ${stableUnits.slice(0, 2).map(item => `${item.unit} (${formatHeadcount(item.forecastTwelve)} คน, แผนลดความเสี่ยง ${Math.round(item.mitigation * 100)}%)`).join(', ')}`
        : 'ควรวางมาตรการเชิงรุกเพิ่มเติมเพื่อสร้างหน่วยตัวอย่างที่มีความเสถียร'
    ];

    summaryItems.forEach(text => {
      const item = document.createElement('div');
      item.className = 'alert-item';
      item.textContent = text;
      forecastInsights.appendChild(item);
    });

    const regressionSummary = document.getElementById('regressionSummary');
    const regressionTableBody = document.getElementById('regressionTableBody');
    const regressionInsights = document.getElementById('regressionInsights');

    if (regressionSummary && regressionTableBody && regressionInsights) {
      const regressionFeatures = ['satisfaction', 'happiness', 'commitment'];
      const featureLabels = {
        satisfaction: 'ความพึงพอใจงาน (Job Satisfaction)',
        happiness: 'ความสุขรวม (Happiness Index)',
        commitment: 'ความผูกพัน (Commitment)'
      };

      const nuanceMap = {
        satisfaction: {
          positive: 'ต้องเจาะลึกเชิงคุณภาพเพราะคะแนนความพึงพอใจสูงขึ้นแต่ยังสัมพันธ์กับการลาออกที่เพิ่มขึ้น',
          negative: 'การยกระดับความพึงพอใจหน้างานช่วยลดโอกาสลาออกอย่างมีนัยสำคัญ'
        },
        happiness: {
          positive: 'คะแนนความสุขที่สูงขึ้นยังสัมพันธ์กับลาออก จึงควรหาปัจจัยกดดันที่ยังไม่ถูกแก้ไข',
          negative: 'การลงทุนเพิ่มประสบการณ์ความสุขช่วยตรึงบุคลากรให้อยู่กับทีม'
        },
        commitment: {
          positive: 'คะแนนผูกพันที่เพิ่มแต่ยังลาออกสูง สะท้อนแรงจูงใจภายนอกที่ต้องจัดการเพิ่มเติม',
          negative: 'การยกระดับความผูกพันช่วยลดการลาออกของหน่วยนั้นอย่างต่อเนื่อง'
        }
      };

      function calculateStats(values) {
        const mean = values.reduce((sum, value) => sum + value, 0) / values.length;
        const variance = values.reduce((sum, value) => sum + Math.pow(value - mean, 2), 0) / Math.max(1, values.length - 1);
        const stdDev = Math.sqrt(variance) || 1;
        return { mean, stdDev };
      }

      function standardize(value, stats) {
        return stats.stdDev === 0 ? 0 : (value - stats.mean) / stats.stdDev;
      }

      function transpose(matrix) {
        return matrix[0].map((_, columnIndex) => matrix.map(row => row[columnIndex]));
      }

      function multiplyMatrices(a, b) {
        const rows = a.length;
        const cols = b[0].length;
        const result = Array.from({ length: rows }, () => Array(cols).fill(0));
        for (let i = 0; i < rows; i++) {
          for (let k = 0; k < b.length; k++) {
            const value = a[i][k];
            for (let j = 0; j < cols; j++) {
              result[i][j] += value * b[k][j];
            }
          }
        }
        return result;
      }

      function multiplyMatrixVector(matrix, vector) {
        return matrix.map(row => row.reduce((sum, value, index) => sum + value * vector[index], 0));
      }

      function invertMatrix(matrix) {
        const n = matrix.length;
        const augmented = matrix.map((row, i) => {
          const identityRow = Array.from({ length: n }, (_, j) => (i === j ? 1 : 0));
          return [...row, ...identityRow];
        });

        for (let i = 0; i < n; i++) {
          let pivotRow = i;
          for (let j = i + 1; j < n; j++) {
            if (Math.abs(augmented[j][i]) > Math.abs(augmented[pivotRow][i])) {
              pivotRow = j;
            }
          }

          const pivotValue = augmented[pivotRow][i];
          if (Math.abs(pivotValue) < 1e-10) {
            throw new Error('Matrix is singular and cannot be inverted');
          }

          if (pivotRow !== i) {
            [augmented[i], augmented[pivotRow]] = [augmented[pivotRow], augmented[i]];
          }

          const pivot = augmented[i][i];
          for (let j = 0; j < 2 * n; j++) {
            augmented[i][j] /= pivot;
          }

          for (let row = 0; row < n; row++) {
            if (row !== i) {
              const factor = augmented[row][i];
              for (let col = 0; col < 2 * n; col++) {
                augmented[row][col] -= factor * augmented[i][col];
              }
            }
          }
        }

        return augmented.map(row => row.slice(n));
      }

      const featureStats = {};
      regressionFeatures.forEach(key => {
        const values = resignationTrendData.map(item => item[key]);
        featureStats[key] = calculateStats(values);
      });

      const targetStats = calculateStats(resignationTrendData.map(item => item.current));
      const y = resignationTrendData.map(item => standardize(item.current, targetStats));

      const designMatrix = resignationTrendData.map(item => {
        const row = [1];
        regressionFeatures.forEach(key => {
          row.push(standardize(item[key], featureStats[key]));
        });
        return row;
      });

      const transposed = transpose(designMatrix);
      const xtx = multiplyMatrices(transposed, designMatrix);
      const xtxInverse = invertMatrix(xtx);
      const xty = multiplyMatrixVector(transposed, y);
      const coefficients = multiplyMatrixVector(xtxInverse, xty);

      const predictions = designMatrix.map(row => row.reduce((sum, value, index) => sum + value * coefficients[index], 0));
      const meanY = y.reduce((sum, value) => sum + value, 0) / y.length;
      const ssTotal = y.reduce((sum, value) => sum + Math.pow(value - meanY, 2), 0);
      const ssResidual = y.reduce((sum, value, index) => sum + Math.pow(value - predictions[index], 2), 0);
      const rSquared = ssTotal === 0 ? 1 : 1 - ssResidual / ssTotal;

      const regressionResults = regressionFeatures.map((key, index) => {
        const coefficient = coefficients[index + 1];
        const direction = coefficient >= 0 ? 'positive' : 'negative';
        return {
          key,
          coefficient,
          magnitude: Math.abs(coefficient),
          direction,
          interpretation: `${direction === 'positive' ? 'คะแนนสูงขึ้นสัมพันธ์กับการลาออกเพิ่มขึ้น' : 'คะแนนสูงขึ้นสัมพันธ์กับการลาออกลดลง'} — ${nuanceMap[key][direction]}`
        };
      }).sort((a, b) => b.magnitude - a.magnitude);

      regressionTableBody.innerHTML = '';
      regressionResults.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${featureLabels[result.key]}</strong></td>
          <td>${result.coefficient >= 0 ? '+' : '-'}${Math.abs(result.coefficient).toFixed(2)}</td>
          <td><span class="hint">${result.interpretation}</span></td>
        `;
        regressionTableBody.appendChild(row);
      });

      const boundedRSquared = Math.max(0, Math.min(1, rSquared));
      const easyRegressionSummary = `แบบจำลองถดถอยเชิงเส้นที่ใช้คะแนนความพึงพอใจ ความสุข และความผูกพัน อธิบายความแปรปรวนของจำนวนลาออกได้ <span class="trend-indicator">${(boundedRSquared * 100).toFixed(1)}%</span> จากข้อมูล 7 หน่วยงาน (คะแนนถูกปรับมาตรฐานก่อนคำนวณ)`;
      const advancedRegressionSummary = `โมเดลถดถอยเชิงเส้นพหุให้ค่า R² = ${(boundedRSquared).toFixed(3)} (คิดเป็น ${(boundedRSquared * 100).toFixed(1)}%) โดยใช้ข้อมูล 7 หน่วยที่ผ่านการมาตรฐาน (z-score) ของตัวแปรอิสระทั้งสาม`;
      applyDescriptionContent(regressionSummary, easyRegressionSummary, advancedRegressionSummary);

      const topRisk = regressionResults.find(result => result.coefficient > 0);
      const topProtective = regressionResults.find(result => result.coefficient < 0);

      const insightMessages = [];
      if (topRisk) {
        insightMessages.push(`${featureLabels[topRisk.key]} (β = ${topRisk.coefficient.toFixed(2)}) เป็นตัวเร่งการลาออกสูงสุด ควรตั้งมาตรการเฉพาะเพื่อลดแรงผลักดันในมิตินี้`);
      }
      if (topProtective) {
        insightMessages.push(`${featureLabels[topProtective.key]} (β = ${topProtective.coefficient.toFixed(2)}) ทำหน้าที่เป็นเกราะป้องกัน หากเพิ่มคะแนนในมิตินี้ได้อีกจะช่วยลดจำนวนลาออก`);
      }
      insightMessages.push('ค่า β > 0 หมายถึงคะแนนสูงขึ้นสัมพันธ์กับลาออกเพิ่มขึ้น ส่วนค่า β < 0 บ่งชี้ผลเชิงป้องกัน ต้องติดตามการเปลี่ยนแปลงรายไตรมาส');

      regressionInsights.innerHTML = '';
      insightMessages.forEach(message => {
        const item = document.createElement('div');
        item.className = 'alert-item';
        item.textContent = message;
        regressionInsights.appendChild(item);
      });
    }

    const diagnosticSummaryElement = document.getElementById('diagnosticSummary');
    const satisfactionMatrixElement = document.getElementById('satisfactionCorrelationMatrix');
    const diagnosticInsightsElement = document.getElementById('diagnosticInsights');

    if (diagnosticSummaryElement && satisfactionMatrixElement && diagnosticInsightsElement) {
      const correlationCache = new Map();

      function getCorrelationValue(dimA, dimB) {
        if (dimA === dimB) {
          return 1;
        }
        const key = [dimA, dimB].sort().join('|');
        if (!correlationCache.has(key)) {
          correlationCache.set(key, calculatePearson(satisfactionDimensionData, dimA, dimB));
        }
        return correlationCache.get(key);
      }

      function getMatrixColor(value) {
        const intensity = Math.min(1, Math.abs(value));
        const minAlpha = 0.12;
        const maxAlpha = 0.58;
        const alpha = (minAlpha + (maxAlpha - minAlpha) * intensity).toFixed(2);
        const base = value >= 0 ? '43, 177, 168' : '255, 138, 91';
        return `rgba(${base}, ${alpha})`;
      }

      satisfactionMatrixElement.innerHTML = '';
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const corner = document.createElement('th');
      corner.textContent = '';
      headerRow.appendChild(corner);
      satisfactionDimensionKeys.forEach(key => {
        const th = document.createElement('th');
        th.textContent = satisfactionDimensionLabels[key];
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      satisfactionMatrixElement.appendChild(thead);

      const tbody = document.createElement('tbody');
      const dimensionPairs = [];

      satisfactionDimensionKeys.forEach((rowKey, rowIndex) => {
        const tr = document.createElement('tr');
        const rowHeader = document.createElement('th');
        rowHeader.textContent = satisfactionDimensionLabels[rowKey];
        tr.appendChild(rowHeader);

        satisfactionDimensionKeys.forEach((colKey, colIndex) => {
          const td = document.createElement('td');
          const wrapper = document.createElement('div');
          wrapper.className = 'matrix-cell';

          if (rowKey === colKey) {
            wrapper.classList.add('diagonal');
            wrapper.textContent = '1.00';
          } else {
            const value = getCorrelationValue(rowKey, colKey);
            wrapper.classList.add(value >= 0 ? 'positive' : 'negative');
            wrapper.style.background = getMatrixColor(value);
            wrapper.textContent = value.toFixed(2);
            td.title = `${satisfactionDimensionLabels[rowKey]} ↔ ${satisfactionDimensionLabels[colKey]} (r = ${value.toFixed(2)})`;
            if (colIndex > rowIndex) {
              dimensionPairs.push({ keyA: rowKey, keyB: colKey, value });
            }
          }

          td.appendChild(wrapper);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      satisfactionMatrixElement.appendChild(tbody);

      const positivePairs = dimensionPairs.filter(pair => pair.value > 0);
      const negativePairs = dimensionPairs.filter(pair => pair.value < 0);
      const topPositive = positivePairs.sort((a, b) => b.value - a.value)[0] || null;
      const topNegative = negativePairs.sort((a, b) => a.value - b.value)[0] || null;

      const topPositiveUnits = topPositive
        ? satisfactionDimensionData
            .filter(item => item[topPositive.keyA] >= 80 && item[topPositive.keyB] >= 80)
            .map(item => item.unit)
        : [];

      const summarySegments = [];
      if (topPositiveUnits.length) {
        summarySegments.push(`พบคะแนน ≥80% ทั้งคู่ใน ${topPositiveUnits.join(', ')}`);
      } else if (topPositive) {
        summarySegments.push('คะแนนทั้งสองมิติเคลื่อนในทิศทางเดียวกันในหลายหน่วยงาน');
      }

      if (topNegative) {
        const divergenceUnits = satisfactionDimensionData
          .filter(item => Math.abs(item[topNegative.keyA] - item[topNegative.keyB]) >= 12)
          .map(item => `${item.unit} (${item[topNegative.keyA].toFixed(1)}% / ${item[topNegative.keyB].toFixed(1)}%)`);
        const divergenceText = divergenceUnits.length
          ? `โดยมีช่องว่างเด่นใน ${divergenceUnits.join(', ')}`
          : 'ควรเฝ้าระวังไม่ให้คะแนนทั้งสองมิติแยกทิศกัน';
        summarySegments.push(`คู่ที่สวนทางมากที่สุดคือ ${satisfactionDimensionLabels[topNegative.keyA]} ↔ ${satisfactionDimensionLabels[topNegative.keyB]} (r = ${topNegative.value.toFixed(2)}) ${divergenceText}`);
      }

      summarySegments.push(`ใช้ข้อมูล ${satisfactionDimensionData.length} หน่วยงานในการคำนวณ`);

      const positiveLabel = topPositive
        ? `${satisfactionDimensionLabels[topPositive.keyA]} ↔ ${satisfactionDimensionLabels[topPositive.keyB]} (r = ${topPositive.value.toFixed(2)})`
        : 'ยังไม่พบความสัมพันธ์เด่น';

      const easyDiagnosticSummary = summarySegments.join(' | ');
      const advancedDiagnosticSegments = [];
      if (topPositive) {
        advancedDiagnosticSegments.push(`r(${satisfactionDimensionLabels[topPositive.keyA]}, ${satisfactionDimensionLabels[topPositive.keyB]}) = ${topPositive.value.toFixed(2)}`);
      } else {
        advancedDiagnosticSegments.push('ยังไม่พบคู่มิติที่มีค่าสหสัมพันธ์บวกโดดเด่น');
      }
      if (topNegative) {
        advancedDiagnosticSegments.push(`r(${satisfactionDimensionLabels[topNegative.keyA]}, ${satisfactionDimensionLabels[topNegative.keyB]}) = ${topNegative.value.toFixed(2)}`);
      } else {
        advancedDiagnosticSegments.push('ยังไม่พบคู่มิติที่มีค่าสหสัมพันธ์ลบ');
      }
      advancedDiagnosticSegments.push(`จำนวนหน่วยที่ใช้วิเคราะห์ (n) = ${satisfactionDimensionData.length}`);
      const advancedDiagnosticSummary = `การวิเคราะห์ Pearson's r: ${advancedDiagnosticSegments.join(' • ')}`;
      diagnosticSummaryElement.innerHTML = `
        <span class="metric-title">คู่มิติที่สัมพันธ์สูงสุด</span>
        <span class="metric-value">${positiveLabel}</span>
        ${createDescriptionMarkup(easyDiagnosticSummary, advancedDiagnosticSummary, { tag: 'p', classes: ['metric-desc'] })}
      `;
      activateDescriptionToggles(diagnosticSummaryElement);

      const insights = [];

      if (topPositive) {
        const highUnitsDetailed = satisfactionDimensionData
          .filter(item => item[topPositive.keyA] >= 80 && item[topPositive.keyB] >= 80)
          .map(item => `${item.unit} (${item[topPositive.keyA].toFixed(1)}% / ${item[topPositive.keyB].toFixed(1)}%)`);
        const highlightText = highUnitsDetailed.length
          ? `ตัวอย่างหน่วยที่ทำได้ดีคือ ${highUnitsDetailed.join(', ')}`
          : 'ควรออกแบบโครงการที่ยกระดับทั้งสองมิติควบคู่กันในหน่วยคะแนนปานกลาง';
        insights.push(`${satisfactionDimensionLabels[topPositive.keyA]} และ ${satisfactionDimensionLabels[topPositive.keyB]} เคลื่อนไปในทิศทางเดียวกัน (r = ${topPositive.value.toFixed(2)}) ${highlightText}`);
      }

      if (topNegative) {
        const divergenceUnitsDetailed = satisfactionDimensionData
          .filter(item => Math.abs(item[topNegative.keyA] - item[topNegative.keyB]) >= 12)
          .map(item => `${item.unit} (${item[topNegative.keyA].toFixed(1)}% / ${item[topNegative.keyB].toFixed(1)}%)`);
        const divergenceText = divergenceUnitsDetailed.length
          ? `ต้องโฟกัส ${divergenceUnitsDetailed.join(', ')} เพื่อสร้างความสมดุล`
          : 'ควรกำหนดตัวชี้วัดร่วมเพื่อไม่ให้สองมิตินี้แยกทิศ';
        insights.push(`${satisfactionDimensionLabels[topNegative.keyA]} และ ${satisfactionDimensionLabels[topNegative.keyB]} มีแนวโน้มสวนทาง (r = ${topNegative.value.toFixed(2)}) ${divergenceText}`);
      }

      const dimensionAverages = satisfactionDimensionKeys
        .map(key => ({ key, avg: calculateAverage(satisfactionDimensionData, key) }))
        .sort((a, b) => b.avg - a.avg);

      if (dimensionAverages.length) {
        const highestAvg = dimensionAverages[0];
        const lowestAvg = dimensionAverages[dimensionAverages.length - 1];
        insights.push(`ค่าเฉลี่ยสูงสุดคือ ${satisfactionDimensionLabels[highestAvg.key]} ${highestAvg.avg.toFixed(1)}% ขณะที่ต่ำสุดคือ ${satisfactionDimensionLabels[lowestAvg.key]} ${lowestAvg.avg.toFixed(1)}% ชี้ลำดับความสำคัญในการลงทุน`);
      }

      const unitProfiles = satisfactionDimensionData
        .map(item => ({
          unit: item.unit,
          avg: satisfactionDimensionKeys.reduce((sum, key) => sum + item[key], 0) / satisfactionDimensionKeys.length
        }))
        .sort((a, b) => b.avg - a.avg);

      if (unitProfiles.length) {
        const topUnit = unitProfiles[0];
        const bottomUnit = unitProfiles[unitProfiles.length - 1];
        insights.push(`หน่วยที่ทำคะแนนภาพรวมดีสุดคือ ${topUnit.unit} (เฉลี่ย ${topUnit.avg.toFixed(1)}%) ขณะที่ ${bottomUnit.unit} (${bottomUnit.avg.toFixed(1)}%) ต้องได้รับการสนับสนุนเชิงลึก`);
      }

      if (!insights.length) {
        insights.push('ใช้เมทริกซ์เพื่อออกแบบแผนเสริมแต่ละมิติให้ขับเคลื่อนไปในทิศทางเดียวกันกับคะแนนรวม');
      }

      diagnosticInsightsElement.innerHTML = '';
      insights.forEach(message => {
        const item = document.createElement('div');
        item.className = 'alert-item';
        item.textContent = message;
        diagnosticInsightsElement.appendChild(item);
      });
    }

    const correlationData = [
      {
        dimension: 'การบังคับบัญชา',
        correlation: 0.82,
        effect: 'positive',
        insight: {
          easy: 'คะแนนหัวหน้าที่ชัดเจนและติดตามงานสม่ำเสมอช่วยเพิ่มคะแนนรวมเฉลี่ย +6.4 จุด',
          advanced: 'Pearson\'s r = 0.82 บ่งชี้ความสัมพันธ์เชิงบวกสูง ระดับคะแนนการบังคับบัญชาที่เพิ่มขึ้น 1 ส่วนเบี่ยงเบนมาตรฐานยกระดับคะแนนรวมประมาณ +6.4 จุด'
        }
      },
      {
        dimension: 'สิ่งแวดล้อมการทำงาน',
        correlation: 0.78,
        effect: 'positive',
        insight: {
          easy: 'พื้นที่ที่มีทรัพยากรพร้อมและปลอดภัยสัมพันธ์กับ Happinometer ที่ดีขึ้นใน 15/18 หน่วย',
          advanced: 'Pearson\'s r = 0.78 สะท้อนความเชื่อมโยงเชิงบวก โดยหน่วยที่ได้ ≥80% มีคะแนนรวมเฉลี่ยสูงกว่ากลุ่มอื่น 5-6 จุด'
        }
      },
      {
        dimension: 'ค่าตอบแทนและสวัสดิการ',
        correlation: 0.74,
        effect: 'positive',
        insight: {
          easy: 'เมื่อคะแนนสวัสดิการเกิน 80% พบคะแนนรวมสูงขึ้นเฉลี่ย 5 จุดและอัตรา Stay สูงขึ้น',
          advanced: 'Pearson\'s r = 0.74 แสดงว่าค่าตอบแทนสัมพันธ์กับคะแนนรวมเชิงบวก โดยกลุ่มคะแนน ≥80% มีค่าเฉลี่ยสูงกว่ากลุ่มต่ำกว่าประมาณ 5 จุดและรักษาอัตรา Stay ได้ดีกว่า'
        }
      },
      {
        dimension: 'โอกาสเติบโตในวิชาชีพ',
        correlation: 0.69,
        effect: 'positive',
        insight: {
          easy: 'การสื่อสารเส้นทางเติบโตและการอบรมทำให้คะแนนรวมเพิ่มขึ้นต่อเนื่อง 3 ไตรมาส',
          advanced: 'Pearson\'s r = 0.69 ระบุว่าการลงทุนด้าน Career Path เชื่อมโยงกับคะแนนรวม โดยหน่วยที่มีโครงการอบรมต่อเนื่องมีคะแนนเพิ่มเฉลี่ย ~4 จุด'
        }
      },
      {
        dimension: 'ความสมดุลชีวิตกับงาน',
        correlation: -0.63,
        effect: 'negative',
        insight: {
          easy: 'หน่วยที่พนักงานรู้สึกพักไม่พอมีคะแนนรวมต่ำกว่าค่าเฉลี่ย 7 จุด',
          advanced: 'Pearson\'s r = -0.63 แสดงว่าความไม่สมดุลชีวิต-งานลดคะแนนรวมเฉลี่ย ~7 จุด และเพิ่มค่าส่วนเบี่ยงเบนมาตรฐานของความพึงพอใจ'
        }
      },
      {
        dimension: 'ภาระงานและทรัพยากร',
        correlation: -0.58,
        effect: 'negative',
        insight: {
          easy: 'คะแนนภาระงานตึง (Relax <60%) สัมพันธ์กับคะแนนรวมต่ำและการร้องเรียนด้านคุณภาพ',
          advanced: 'Pearson\'s r = -0.58 สะท้อนความสัมพันธ์เชิงลบ โดยหน่วยที่มีคะแนน Relax <60% มีคะแนนรวมต่ำกว่าค่าเฉลี่ย 4-5 จุดและมีอัตราร้องเรียนสูงขึ้น'
        }
      },
      {
        dimension: 'ความยุติธรรมของรางวัล',
        correlation: -0.66,
        effect: 'negative',
        insight: {
          easy: 'ความรู้สึกว่าแรงจูงใจไม่เป็นธรรมลากคะแนนรวมลงเฉลี่ย 6 จุดและเพิ่มแนวโน้มลาออก',
          advanced: 'Pearson\'s r = -0.66 ระบุว่าการรับรู้ความยุติธรรมต่ำลดคะแนนรวมเฉลี่ย ~6 จุด และสัมพันธ์กับแนวโน้มลาออกที่สูงขึ้นอย่างมีนัยสำคัญ'
        }
      }
    ];

    const positiveCorrelation = document.getElementById('positiveCorrelation');
    const negativeCorrelation = document.getElementById('negativeCorrelation');
    const correlationSummary = document.getElementById('correlationSummary');

    const positives = correlationData.filter(item => item.effect === 'positive').sort((a, b) => b.correlation - a.correlation);
    const negatives = correlationData
      .filter(item => item.effect === 'negative')
      .sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation));

    const maxDisplay = 3;

    function renderCorrelation(listElement, data, isNegative = false) {
      listElement.innerHTML = '';
      data.slice(0, maxDisplay).forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.className = 'correlation-item';
        const scoreClass = isNegative ? 'correlation-score negative' : 'correlation-score';
        const percentage = Math.round(Math.abs(item.correlation) * 100);
        const insightContent = typeof item.insight === 'object' ? item.insight : { easy: item.insight, advanced: item.insight };
        wrapper.innerHTML = `
          <strong>${item.dimension}</strong>
          <div class="correlation-score-wrapper">
            <span class="${scoreClass}">r = ${item.correlation.toFixed(2)}</span>
          </div>
          <div class="correlation-bar">
            <span class="${isNegative ? 'negative' : ''}" style="width: ${percentage}%;"></span>
          </div>
          ${createDescriptionMarkup(insightContent.easy, insightContent.advanced, { tag: 'p', classes: ['hint'] })}
        `;
        activateDescriptionToggles(wrapper);
        listElement.appendChild(wrapper);
      });
    }

    renderCorrelation(positiveCorrelation, positives);
    renderCorrelation(negativeCorrelation, negatives, true);

    if (positives.length && negatives.length) {
      const topPositive = positives[0];
      const topNegative = negatives[0];
      const easyCorrelationSummary = `มิติที่สัมพันธ์สูงสุดกับคะแนนรวมคือ <strong>${topPositive.dimension}</strong> (r = ${topPositive.correlation.toFixed(2)}) หากเพิ่มคะแนนด้านนี้ทุก 5 จุดจะดันคะแนนรวมเฉลี่ย +3 จุด ขณะที่ความเสี่ยงหลักคือ <strong>${topNegative.dimension}</strong> (r = ${topNegative.correlation.toFixed(2)}) ซึ่งเมื่อคะแนนต่ำกว่า 70% จะดึงคะแนนรวมลงเฉลี่ย 6 จุด`;
      const advancedCorrelationSummary = `Pearson\'s r สูงสุด = ${topPositive.correlation.toFixed(2)} สำหรับ ${topPositive.dimension} ชี้ว่าการเพิ่มคะแนน 1 SD ยกระดับคะแนนรวมราว +3 จุด ส่วนค่าลบเด่นคือ ${topNegative.dimension} (r = ${topNegative.correlation.toFixed(2)}) เมื่อคะแนนต่ำกว่า 70% ค่าเฉลี่ยรวมลดลงประมาณ 6 จุดและเพิ่มความเสี่ยงลาออก`;
      correlationSummary.innerHTML = `
        <span class="metric-title">สรุป</span>
        <span class="metric-value">${topPositive.dimension} vs ${topNegative.dimension}</span>
        ${createDescriptionMarkup(easyCorrelationSummary, advancedCorrelationSummary, { tag: 'p', classes: ['metric-desc'] })}
      `;
      activateDescriptionToggles(correlationSummary);
    }

    activateDescriptionToggles();
  </script>
</body>
</html>
